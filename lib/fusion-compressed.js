Fusion.Error=OpenLayers.Class({type:null,message:null,initialize:function(A,B){this.type=A;this.message=B},alert:function(){var A=this.typeToString(this.type);alert(OpenLayers.i18n("fusionError",{type:A,message:this.message}))},toString:function(){var A=this.typeToString(this.type);return A+": "+this.message},typeToString:function(A){switch(A){case Fusion.Error.FATAL:return"FATAL";case Fusion.Error.WARNING:return"WARNING";case Fusion.Error.NOTICE:return"NOTICE";default:return"UNKNOWN ("+A+")"}}});Fusion.Error.FATAL=0;Fusion.Error.WARNING=1;Fusion.Error.NOTICE=2;Fusion.Lib.EventMgr=OpenLayers.Class({events:null,initialize:function(){if(!this.events){this.events=[]}},destroy:function(){this.events=[]},registerEventID:function(A){if(!this.events){this.events=[]}if(!A){Fusion.reportError(new Fusion.Error(Fusion.Error.WARNING,OpenLayers.i18n("regsiterEventError")))}var B=new String(A);if(!this.events[A]){this.events[A]=[]}},registerForEvent:function(A,C){var B=new String(A);this.events[A].push(C)},deregisterForEvent:function(C,E){var D=new String(C);var A=false;if(!this.events[C]){return false}for(var B=0;B<this.events[C].length;B++){if(this.events[C][B]==E){this.events[C].splice(B,1);A=true}}return A},triggerEvent:function(B){var C=new String(B);if(!this.events||!this.events[B]){return false}for(var A=0;A<this.events[B].length;A++){this.events[B][A].apply(null,arguments)}return true}});Fusion.events=[];Fusion.registerEventID=Fusion.Lib.EventMgr.prototype.registerEventID;Fusion.registerForEvent=Fusion.Lib.EventMgr.prototype.registerForEvent;Fusion.triggerEvent=Fusion.Lib.EventMgr.prototype.triggerEvent;Fusion.Event.FUSION_INITIALIZED=Fusion.Event.lastEventId++;Fusion.Event.FUSION_ERROR=Fusion.Event.lastEventId++;Fusion.registerEventID(Fusion.Event.FUSION_INITIALIZED);Fusion.registerEventID(Fusion.Event.FUSION_ERROR);Fusion.Lib.ApplicationDefinition=OpenLayers.Class({mapGroups:null,widgetSets:null,oBroker:null,searchDefinitions:null,searchCategories:null,initialize:function(A){this.sessionId=A;this.oBroker=Fusion.getBroker();this.applicationDefinition=Fusion.getApplicationDefinitionURL();this.widgetSets=[];this.mapGroups=[];this.searchDefinitions=[];this.searchCategories=[];this.parse()},parse:function(){if(this.applicationDefinition==""){return null}if((this.applicationDefinition.match("Library://")==null)&&(this.applicationDefinition.match("Session:")==null)){if(Fusion.appDefJson){this.parseAppDef(Fusion.appDefJson)}else{Fusion.getXmlAsJson(this.applicationDefinition,OpenLayers.Function.bind(this.getAppDefCB,this))}}else{if(!this.sessionId){var A=new Fusion.Lib.MGRequest.MGCreateSession();this.oBroker.dispatchRequest(A,OpenLayers.Function.bind(this.getAppDef,this))}else{this.getAppDef()}}return true},getAppDef:function(B){if(B){this.sessionId=B.responseText;Fusion.sessionId=this.sessionId}var A=new Fusion.Lib.MGRequest.MGGetResourceContent(this.applicationDefinition);A.parameters.session=this.sessionId;this.oBroker.dispatchRequest(A,OpenLayers.Function.bind(Fusion.xml2json,this,OpenLayers.Function.bind(this.getAppDefCB,this)))},getAppDefCB:function(xhr){var o;eval("o="+xhr.responseText);this.parseAppDef(o);Fusion.setLoadState(Fusion.LOAD_WIDGETS)},parseAppDef:function(N){var A=N.ApplicationDefinition;if(A.Title){var K=A.Title[0];document.title=K}if(A.MapSet){var I=A.MapSet[0];if(I.MapGroup instanceof Array){for(var F=0;F<I.MapGroup.length;F++){var C=new Fusion.Lib.ApplicationDefinition.MapGroup(I.MapGroup[F]);this.mapGroups.push(C)}}}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.i18n("appDefParseError")))}if(A.WidgetSet){for(var F=0;F<A.WidgetSet.length;F++){var D=new Fusion.Lib.ApplicationDefinition.WidgetSet(A.WidgetSet[F]);this.widgetSets.push(D)}}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.i18n("widgetSetParseError")))}if(A.Extension){var M=A.Extension[0];if(M.SearchDefinitions instanceof Array){var G=M.SearchDefinitions[0];if(G.SearchCategory instanceof Array){for(var F=0;F<G.SearchCategory.length;F++){var J={};var B=G.SearchCategory[F];J.id=B["@id"];J.name=B["@name"];J.layer=B.Layer?B.Layer[0]:"";J.searchDefinitions=[];this.searchCategories[J.id]=J;var L=B.SearchDefinition;for(var E=0;E<L.length;E++){var H=new Fusion.Lib.ApplicationDefinition.SearchDefinition(L[E]);H.category=J;J.searchDefinitions[H.id]=H;this.searchDefinitions[H.id]=H}}}}}},create:function(){for(var A=0;A<this.widgetSets.length;A++){this.widgetSets[A].create(this)}},getMapByName:function(A){var C=null;for(var B=0;B<this.widgetSets.length;B++){C=this.widgetSets[B].getMapByName(A);if(C){break}}return C},getMapById:function(C){var B=null;for(var A=0;A<this.widgetSets.length;A++){B=this.widgetSets[A].mapWidget;if(B.mapId==C){break}}return B},getMapByIndice:function(B){var A=null;if(this.widgetSets.length>B){A=this.widgetSets[B].getMapWidget()}return A},getMapGroup:function(B){var C=null;for(var A=0;A<this.mapGroups.length;++A){if(this.mapGroups[A].mapId==B){C=this.mapGroups[A];break}}return C},getWidgetsByType:function(C){var B=[];for(var A=0;A<this.widgetSets.length;A++){B=B.concat(this.widgetSets[A].getWidgetsByType(C))}return B}});Fusion.Lib.ApplicationDefinition.MapGroup=OpenLayers.Class({initialView:null,maps:null,initialize:function(H){this.mapId=H["@id"][0];this.maps=[];if(H.InitialView){var C=H.InitialView[0];if(C.CenterX&&C.CenterY&&C.Scale){this.setInitialView({x:parseFloat(C.CenterX[0]),y:parseFloat(C.CenterY[0]),scale:parseFloat(C.Scale[0])})}else{if(C.MinX&&C.MinY&&C.MaxX&&C.MaxY){this.setInitialView({minX:parseFloat(C.MinX[0]),minY:parseFloat(C.MinY[0]),maxX:parseFloat(C.MaxX[0]),maxY:parseFloat(C.MaxY[0])})}else{}}}if(H.Map instanceof Array){for(var E=0;E<H.Map.length;E++){var A=new Fusion.Lib.ApplicationDefinition.Map(H.Map[E]);var L={groups:[],layers:[]};var I={layerEvents:{},groupEvents:{}};if(H.Map[E].Extension){var K=H.Map[E].Extension[0];if(K.Links){if(K.Links[0].Group instanceof Array){for(var D=0;D<K.Links[0].Group.length;D++){var J=K.Links[0].Group[D];L.groups.push({name:J.Name[0],url:J.Url[0]})}}if(K.Links[0].Layer instanceof Array){for(var D=0;D<K.Links[0].Layer.length;D++){var F=K.Links[0].Layer[D];L.layers.push({name:F.Name[0],url:F.Url[0]})}}}if(K.MapEvents){if(K.MapEvents[0].Layer instanceof Array){for(var D=0;D<K.MapEvents[0].Layer.length;D++){var F=K.MapEvents[0].Layer[D];var B={};B.name=F.Name[0];B.onEnable=[];if(F.OnEnable instanceof Array){B.onEnable=this.parseMapEventSubBlock(F.OnEnable[0])}B.onDisable=[];if(F.OnDisable instanceof Array){B.onDisable=this.parseMapEventSubBlock(F.OnDisable[0])}I.layerEvents[B.name]=B}}if(K.MapEvents[0].Group instanceof Array){for(var D=0;D<K.MapEvents[0].Group.length;D++){var J=K.MapEvents[0].Group[D];var G={};G.name=J.Name[0];G.onEnable=[];if(F.OnEnable instanceof Array){G.onEnable=this.parseMapEventSubBlock(J.OnEnable[0])}G.onDisable=[];if(F.OnDisable instanceof Array){G.onDisable=this.parseMapEventSubBlock(J.OnDisable[0])}I.groupEvents[G.name]=G}}}}A.mapInfo={links:L,mapEvents:I};this.maps.push(A)}}else{}},parseMapEventSubBlock:function(E){var A=[];if(E.Layer&&E.Layer instanceof Array){for(var C=0;C<E.Layer.length;C++){var B=E.Layer[C];A.push({type:"layer",name:B.Name[0],enable:B.Enable[0]=="true"?true:false})}}if(E.Group&&E.Group instanceof Array){for(var C=0;C<E.Group.length;C++){var D=E.Group[C];A.push({type:"group",name:D.Name[0],enable:D.Enable[0]=="true"?true:false})}}return A},getInitialView:function(){return this.initialView},setInitialView:function(A){this.initialView=A}});Fusion.Lib.ApplicationDefinition.Map=OpenLayers.Class({type:null,singleTile:false,extension:null,initialize:function(B){this.type=B.Type[0];if(B.SingleTile){var A=B.SingleTile[0].toLowerCase();this.singleTile=(A=="true")?true:false}if(B.Extension){this.extension=B.Extension[0]}else{this.extension={}}this.resourceId=this.extension.ResourceId?this.extension.ResourceId[0]:"";if(!Fusion.Maps[this.type]){Fusion.require(this.type+"/"+this.type+".js")}}});Fusion.Lib.ApplicationDefinition.WidgetSet=OpenLayers.Class({containers:null,containersByName:null,widgetTags:null,widgetTagsByName:null,widgetInstances:null,mapWidget:null,mapId:null,initialize:function(C){this.containers=[];this.widgetTags=[];this.widgetInstances=[];this.widgetTagsByName={};this.containersByName={};if(C.MapWidget){for(var B=0;B<C.MapWidget.length;B++){var E=new Fusion.Lib.ApplicationDefinition.Widget(C.MapWidget[B]);E.widgetSet=this;this.mapWidgetTag=E;this.mapId=C.MapWidget[B].MapId[0]}}var D=Fusion.getQueryParam("mapid");if(D.length>0){this.mapId=D}if(C.Widget){for(var B=0;B<C.Widget.length;B++){var E=new Fusion.Lib.ApplicationDefinition.Widget(C.Widget[B]);E.widgetSet=this;this.widgetTags.push(E);this.widgetTagsByName[E.name]=E}}if(C.Container){for(var B=0;B<C.Container.length;B++){var A=new Fusion.Lib.ApplicationDefinition.Container(C.Container[B]);this.containers.push(A);this.containersByName[A.name]=A}}},addWidgetInstance:function(A){this.widgetInstances.push(A)},getMapWidget:function(){return this.mapWidget},create:function(A){var C=null;if(this.mapId){for(var B=0;B<A.mapGroups.length;++B){if(this.mapId==A.mapGroups[B].mapId){C=A.mapGroups[B];break}}}this.mapWidget=new Fusion.Widget.Map(this.mapWidgetTag,C,this);this.mapWidget.setMenu();$(this.mapWidgetTag.name).widget=this.mapWidget;for(var B=0;B<this.widgetTags.length;B++){this.widgetTags[B].create(this)}for(var B=0;B<this.containers.length;B++){this.containers[B].create(this)}},getMapByName:function(A){var B=null;if(this.mapWidget.getMapName()==A){B=this.mapWidget}return B},getWidgetsByType:function(C){var B=[];for(var A=0;A<this.widgetInstances.length;A++){if(this.widgetInstances[A].sType==C){B.push(this.widgetInstances[A])}}return B},getWidgetByName:function(A){return this.widgetTagsByName[A]},getContainerByName:function(A){return this.containersByName[A]}});Fusion.Lib.ApplicationDefinition.Container=OpenLayers.Class({name:null,type:null,validPositions:["top","left","bottom","right"],position:"top",items:null,initialize:function(C){this.type=C.Type[0];this.name=C.Name[0];var A=C.Position?C.Position[0].toLowerCase():this.position;for(var B=0;B<this.validPositions.length;B++){if(this.validPositions[B]==A){this.position=A;break}}this.items=[];if(C.Item){for(var B=0;B<C.Item.length;B++){var D=new Fusion.Lib.ApplicationDefinition.Item(C.Item[B]);this.items.push(D)}}else{}},create:function(C){var A;if(this.type=="Toolbar"||this.type=="Statusbar"){if($(this.name)){A=new Jx.Toolbar(this.name,this.position);$(this.name).container=A}this.createWidgets(C,A)}else{if(this.type=="Splitterbar"){if($(this.name)){A=new Jx.Splitter(this.name,{splitInto:this.items.length});for(var B=0;B<this.items.length;B++){A.elements[B].id=this.name+"_"+B}$(this.name).container=A}this.createWidgets(C,A)}}if(A&&A.domObj.jxLayout){A.domObj.jxLayout.resize({forceResize:true})}},createWidgets:function(C,A){for(var B=0;B<this.items.length;B++){this.items[B].create(C,A,this.name+"_"+B)}}});Fusion.Lib.ApplicationDefinition.Widget=OpenLayers.Class({name:null,type:null,statusText:null,location:null,imageUrl:null,imageClass:null,tooltip:null,label:null,disabled:null,extension:null,initialize:function(A){if(A){this.type=A.Type[0];this.name=A.Name?A.Name[0]:"";this.statusText=A.StatusText?A.StatusText[0]:"";this.location=A.Location?A.Location[0]:"widgets/";if(this.location.slice(-1)!="/"){this.location+="/"}this.imageUrl=A.ImageUrl?A.ImageUrl[0]:"";this.imageClass=A.ImageClass?A.ImageClass[0]:"";this.tooltip=A.Tooltip?A.Tooltip[0]:"";this.label=A.Label?A.Label[0]:"";this.disabled=A.Disabled?(A.Disabled[0].toLowerCase()=="true"?true:false):false;if(A.Extension){this.extension=A.Extension[0]}else{this.extension={}}if(!Fusion.Widget[this.type]){Fusion.require(this.location+this.type+".js")}}},getMapWidget:function(){if(this.widgetSet){return this.widgetSet.getMapWidget()}else{return null}},create:function(widgetSet,widgetName){var widget=null;this.widgetSet=widgetSet;var oldName=this.name;if(typeof widgetName=="undefined"){widgetName=this.name}if(widgetName!=null&&(widgetName==""||$(widgetName)!=null)){this.name=widgetName;widget=eval("new Fusion.Widget."+this.type+"(this)");widgetSet.addWidgetInstance(widget);if($(this.name)){widget.id=this.name;$(this.name).widget=widget}this.name=oldName}return widget}});Fusion.Lib.ApplicationDefinition.Item=OpenLayers.Class({uniqueId:[0],type:null,initialize:function(A){this.type=A.Function[0];switch(this.type){case"Widget":this.widgetName=A.Widget[0];break;case"Flyout":this.flyout=new Fusion.Lib.ApplicationDefinition.Flyout(A);break;case"Separator":break;break}},create:function(F,C,K){switch(this.type){case"Widget":var I=F.getWidgetByName(this.widgetName);if(I){var B="FusionItem"+this.uniqueId[0];this.uniqueId[0]++;if(C instanceof Jx.Toolbar){var H=new Jx.ToolbarItem();H.domObj.id=B;C.add(H);I.create(F,B)}else{if(C instanceof Jx.Splitter){var J=I.create(F,K)}else{if(C instanceof Jx.Menu||C instanceof Jx.ContextMenu||C instanceof Jx.SubMenu){var J=I.create(F,"");J.id=B;if(J.oMenu){J.oMenu.domObj.id=B;J.oMenu.domObj.widget=J;C.add(J.oMenu)}else{var G=new Jx.Action(OpenLayers.Function.bind(J.activateTool,J));var D={};D.label=I.label;D.image=I.imageUrl;var A=new Jx.MenuItem(G,D);A.domObj.id=B;A.domObj.widget=J;C.add(A)}}}}}else{Fusion.reportError(new Fusion.Error(Fusion.Error.WARNING,"can't find widget: "+this.widgetName))}break;case"Flyout":var E;var D={};D.label=this.flyout.label;D.tooltip=this.flyout.tooltip;D.image=this.flyout.imageUrl;D.imageClass=this.flyout.imageClass;if(C instanceof Jx.Toolbar){E=new Jx.Menu(D)}else{if(C instanceof Jx.Menu||C instanceof Jx.ContextMenu||C instanceof Jx.SubMenu){E=new Jx.SubMenu(D)}}C.add(E);this.flyout.create(F,E);break;case"Separator":if(C instanceof Jx.Toolbar){C.add(new Jx.ToolbarSeparator())}else{if(C instanceof (Jx.Menu)||C instanceof (Jx.SubMenu)||C instanceof (Jx.ContextMenu)){C.add(new Jx.MenuSeparator())}}break}}});Fusion.Lib.ApplicationDefinition.Flyout=OpenLayers.Class({label:null,tooltip:null,description:null,imageUrl:null,items:null,initialize:function(B){this.label=B.Label?B.Label[0]:"";this.tooltip=B.Tooltip?B.Tooltip[0]:"";this.description=B.Description?B.Description[0]:"";this.imageUrl=B.ImageUrl?B.ImageUrl[0]:"";this.items=[];if(B.Item instanceof Array){for(var A=0;A<B.Item.length;A++){this.items.push(new Fusion.Lib.ApplicationDefinition.Item(B.Item[A]))}}},create:function(B,C){for(var A=0;A<this.items.length;A++){this.items[A].create(B,C)}}});Fusion.Lib.ApplicationDefinition.SearchDefinition=OpenLayers.Class({id:null,name:null,category:null,parameters:null,join:null,rule:null,initialize:function(B){this.id=B["@id"];this.name=B["@name"];if(B.Join instanceof Array){this.join=new Fusion.Lib.ApplicationDefinition.SearchJoin(B.Join[0])}this.parameters=[];if(B.Parameter instanceof Array){for(var A=0;A<B.Parameter.length;A++){this.parameters.push(B.Parameter[A]["@name"])}}var C;if(B.SearchAnd instanceof Array){this.rule=new Fusion.Lib.ApplicationDefinition.SearchRule("AND");C=B.SearchAnd[0]}else{if(B.SearchOr instanceof Array){this.rule=new Fusion.Lib.ApplicationDefinition.SearchRule("OR");C=B.SearchOr[0]}}if(C&&C.SearchCondition instanceof Array){for(var A=0;A<C.SearchCondition.length;A++){this.rule.add(new Fusion.Lib.ApplicationDefinition.SearchCondition(C.SearchCondition[A]))}}},getJoinUrl:function(A){if(this.join){return"&joinlayer="+this.join.layer+"&joinpk="+this.join.primaryKey+"&joinfk="+this.join.foreignKey}else{return""}},getFilterUrl:function(A){return"&filter="+encodeURIComponent(this.rule.toString(A))}});Fusion.Lib.ApplicationDefinition.SearchJoin=OpenLayers.Class({layer:null,primaryKey:null,foreignKey:null,initialize:function(A){this.layer=A.Layer?A.Layer[0]:"";this.primaryKey=A.PrimaryKey?A.PrimaryKey[0]:"";this.foreignKey=A.ForeignKey?A.ForeignKey[0]:""}});Fusion.Lib.ApplicationDefinition.SearchRule=OpenLayers.Class({type:null,conditions:null,initialize:function(A){this.type=A;this.conditions=[]},add:function(A){this.conditions.push(A)},remove:function(B){for(var A=0;A<this.conditions.length;A++){if(this.conditions[A]==B){this.conditions.splice(A,1);break}}},toString:function(C){var B=[];for(var A=0;A<this.conditions.length;A++){this.conditions[A].setParams(C);var D=this.conditions[A].toString();if(D!=""){B.push(D)}}return"("+B.join(") "+this.type+" (")+")"}});Fusion.Lib.ApplicationDefinition.SearchCondition=OpenLayers.Class({column:null,operator:null,parameter:null,quote:null,value:null,operators:{eq:"=",like:"like",lt:"<",lte:"<=",gt:">",gte:">=",neq:"<>"},includeIfEmpty:false,initialize:function(A){this.column=A.Column[0];this.operator=this.operators[A.Operator[0].toLowerCase()];this.parameter=A.Parameter[0];this.quote=A["@quote"]?A["@quote"]:"";this.wildcard=A["@wildcard"]?A["@wildcard"]:"both";this.caseSensitive=true;if(A["@caseSensitive"]&&A["@caseSensitive"]=="false"){this.caseSensitive=false}},setParams:function(A){if(A[this.parameter]){this.value=A[this.parameter]}else{this.value=""}},toString:function(){var E=this.value?this.value:"";if(E==""&&!this.includeIfEmpty){return""}var D="";if(!this.caseSensitive){E=E.toUpperCase();D="Upper"}var C="";var C="";var A="";if(this.operator=="like"){if(this.wildcard=="before"||this.wildcard=="both"){C="*"}if(this.wildcard=="after"||this.wildcard=="both"){A="*"}}var B=this.operator=="like"?"*":"";return D+"("+this.column+") "+this.operator+" "+this.quote+C+E+A+this.quote}});Fusion.Lib.MGBroker=OpenLayers.Class({mapGuideURL:"",mapAgentURL:"",method:null,initialize:function(){},dispatchRequest:function(C,D){var B=C.encode()+"&ts="+(new Date()).getTime();if(this.method){C.options.method=this.method}var A=new OpenLayers.Ajax.Request(this.mapAgentURL,Object.extend({parameters:C.parameters,onComplete:D},C.options));A.originalRequest=C},setSiteURL:function(B,A,C){this.user=A;this.pass=C;if(B.indexOf("mapagent.fcgi")==-1){if(B.charAt(B.length-1)!="/"){B=B+"/"}this.mapGuideURL=B;B=B+"mapagent/mapagent.fcgi"}this.mapAgentURL=B},clearSiteURL:function(){this.user="";this.pass="";this.mapGuideURL="";this.mapAgentURL=""}});Fusion.Lib.MGRequest=OpenLayers.Class({options:null,parameters:null,initializeRequest:function(){this.options={method:"post"};this.parameters={version:"1.0.0",locale:Fusion.locale,clientagent:"Fusion Viewer"}},setParams:function(A){Object.extend(this.parameters,(A||{}))},setOptions:function(A){Object.extend(this.options,(A||{}))},encode:function(){var A=sep="";for(var B in this.parameters){if(this.parameters[B]){A=A+sep+B+"="+encodeURI(this.parameters[B])}sep="&"}return A}});Fusion.Lib.MGRequest.MGEnumerateResources=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(C,A,B){this.initializeRequest();this.setParams({operation:"ENUMERATERESOURCES",resourceid:(C||"Library://"),type:(A||""),depth:(typeof B=="undefined"?-1:B)})}});Fusion.Lib.MGRequest.MGGetResourceContent=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(A){this.initializeRequest();this.setParams({operation:"GETRESOURCECONTENT",resourceid:(A||"Library://")})}});Fusion.Lib.MGRequest.MGGetResourceHeader=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(A){this.initializeRequest();this.setParams({operation:"GETRESOURCEHEADER",resourceid:(A||"Library://")})}});Fusion.Lib.MGRequest.MGCreateSession=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(){this.initializeRequest();this.setParams({operation:"CREATESESSION"})}});Fusion.Lib.MGRequest.MGCopyResource=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(B,C,A){this.initializeRequest();this.setParams({operation:"COPYRESOURCE",source:B,destination:C,overwrite:A})}});Fusion.Lib.MGRequest.MGDeleteResource=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(A){this.initializeRequest();this.setParams({operation:"DELETERESOURCE",resourceid:A})}});Fusion.Lib.MGRequest.MGMoveResource=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(B,C,A){this.initializeRequest();this.setParams({operation:"MOVERESOURCE",source:B,destination:C,overwrite:A})}});Fusion.Lib.MGRequest.MGMoveResource=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(B,A,C){this.initializeRequest();this.setParams({method:"post",operation:"SETRESOURCE",resourceid:B,content:A,header:C})}});Fusion.Lib.MGRequest.MGDescribeSchema=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(B,A){this.initializeRequest();this.setParams({operation:"DESCRIBEFEATURESCHEMA",resourceid:B,schema:A})}});Fusion.Lib.MGRequest.MGGetSpatialContexts=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(B,A){this.initializeRequest();this.setParams({operation:"GETSPATIALCONTEXTS",resourceid:B,activeonly:A?"1":"0"})}});Fusion.Lib.MGRequest.MGEnumerateResourceReferences=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(A){this.initializeRequest();this.setParams({operation:"ENUMERATERESOURCEREFERENCES",resourceid:A})}});Fusion.Lib.MGRequest.MGEnumerateResourceData=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(A){this.initializeRequest();this.setParams({operation:"ENUMERATERESOURCEDATA",resourceid:A})}});Fusion.Lib.MGRequest.MGGetVisibleMapExtent=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(D,I,H,G,J,L,N,M,B,F,K,C,E,A){this.initializeRequest();this.setParams({operation:"GETVISIBLEMAPEXTENT",session:D,mapname:I,setviewcenterx:H,setviewcentery:G,setviewscale:J,setdataextent:L,setdisplaydpi:N,setdisplaywidth:M,setdisplayheight:B,showlayers:F,hidelayers:K,showgroups:C,hidegroups:E,refreshlayers:A})}});Fusion.Lib.MGRequest.MGQueryMapFeatures=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(H,C,G,B,D,A,F,E){this.initializeRequest();this.setParams({operation:"QUERYMAPFEATURES",session:H,mapname:C,geometry:G,maxFeatures:B,persist:D,selectionVariant:A,layerNames:F,layerAttributeFilter:E})}});Fusion.Lib.MGRequest.MGGetFeatureSetEnvelope=OpenLayers.Class(Fusion.Lib.MGRequest,{initialize:function(C,B,A){this.initializeRequest();this.setParams({operation:"GETFEATURESETENVELOPE",session:C,mapname:B,featureSet:A})}});Fusion.Event.WIDGET_STATE_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget=OpenLayers.Class(Fusion.Lib.EventMgr,{bIsMutuallyExclusive:null,sName:null,sType:null,oMap:null,bEnabled:false,mapLoadedWatcher:null,paramRegister:null,groups:[],group:null,domObj:null,initialize:function(A,C){this.bIsMutuallyExclusive=C;this.sType=A.type;this.sName=A.name;this.widgetTag=A;this.registerEventID(Fusion.Event.WIDGET_STATE_CHANGED);var B=A.extension.Group?A.extension.Group[0]:"";if(B!=""){if(!this.groups[B]){this.groups[B]=[]}this.groups[B].push(this);this.group=B}this.setMap(A.getMapWidget());if(A.name){this.domObj=$(A.name)}this.paramRegister=[]},setMap:function(A){if(this.mapLoadedWatcher){this.oMap.deregisterForEvent(Fusion.Event.MAP_LOADED,this.mapLoadedWatcher);this.mapLoadedWatcher=null}this.oMap=A;if(A){this.mapLoadedWatcher=OpenLayers.Function.bind(this._mapLoaded,this);A.registerForEvent(Fusion.Event.MAP_LOADED,this.mapLoadedWatcher)}if(A&&A.isLoaded()){this.enable()}else{this.disable()}},getMap:function(){return this.oMap},addControl:function(A){this.getMap().oMapOL.addControl(A)},_mapLoaded:function(){if(this.oMap&&this.oMap.isLoaded()){this.enable()}else{this.disable()}},setMutEx:function(A){this.bIsMutuallyExclusive=A},isMutEx:function(){return this.bIsMutuallyExclusive},getName:function(){return this.sName},getLocation:function(){return this.widgetTag.location},isEnabled:function(){return this.bEnabled},enable:function(){this.bEnabled=true;this.triggerEvent(Fusion.Event.WIDGET_STATE_CHANGED,this)},disable:function(){this.bEnabled=false;this.triggerEvent(Fusion.Event.WIDGET_STATE_CHANGED,this)},setParameter:function(B,A){},registerParameter:function(A){this.paramRegister.push(A)}});Fusion.Tool.ButtonBase=OpenLayers.Class({initialize:function(){this.enable=Fusion.Tool.ButtonBase.prototype.enable;this.disable=Fusion.Tool.ButtonBase.prototype.disable;this._oButton=new Fusion.Tool.Button(this.domObj,this.widgetTag);if(!this.isEnabled()){this._oButton.disableTool()}this.clickWatcher=OpenLayers.Function.bind(this.clickCB,this);this._oButton.observeEvent("click",this.clickWatcher)},clickCB:function(A){if(this.isEnabled()){this.activateTool()}this._oButton._oButton.domObj.blur();return false},activateTool:function(){if(this.execute){this.execute()}if(this.group){this._oButton.activateTool();for(var A=0;A<this.groups[this.group].length;A++){if(this.groups[this.group][A]!=this){this.groups[this.group][A]._oButton.deactivateTool()}}}},enable:function(){Fusion.Widget.prototype.enable.apply(this,[]);if(this._oButton){this._oButton.enableTool()}},disable:function(){Fusion.Widget.prototype.disable.apply(this,[]);if(this._oButton){this._oButton.disableTool()}}});Fusion.Tool.MenuBase=OpenLayers.Class({initialize:function(){var A={};A.imgPath=this.widgetTag.imageUrl;A.imgClass=this.widgetTag.imageClass;A.tooltip=this.widgetTag.tooltip;A.label=this.widgetTag.label;if($(this.widgetTag.name)){this.oMenu=new Jx.Menu(A);$(this.widgetTag.name).appendChild(this.oMenu.domObj)}else{this.oMenu=new Jx.SubMenu(A)}},enable:function(){Fusion.Widget.prototype.enable.apply(this,[])},disable:function(){Fusion.Widget.prototype.disable.apply(this,[])}});Fusion.Tool.Button=OpenLayers.Class({bActive:null,sActiveClass:"jxButtonActive",sDisabledClass:"jxButtonDisabled",initialize:function(B,D){var C=D.extension;this.buttonAction=new Jx.Action(OpenLayers.Function.bind(this.buttonClicked,this));if(B){var A={};A.imgPath=D.imageUrl;A.imgClass=D.imageClass;A.tooltip=D.tooltip;A.label=D.label;this._oButton=new Jx.Button(this.buttonAction,A);B.appendChild(this._oButton.domObj)}this.bActive=false;this.bEnabled=true;if(D.disabled){this.disableTool()}},buttonClicked:function(){},observeEvent:function(B,A){if(this._oButton){Event.observe(this._oButton.domObj,B,A)}},stopObserveEvent:function(B,A){if(this._oButton){Event.stopObserving(this._oButton.domObj,B,A)}},enableTool:function(){this.buttonAction.setEnabled(true)},disableTool:function(){this.buttonAction.setEnabled(false)},activateTool:function(){this.bActive=true;if(!this._oButton){return }if(this._sImageURL!=null&&this._sImageURL.length>0){this._oButton.setImage(this._sImageURL)}if(this.sActiveClass!=""){Element.addClassName(this._oButton.domA,this.sActiveClass)}},deactivateTool:function(){this.bActive=false;if(!this._oButton){return }if(this.sActiveClass!=""){Element.removeClassName(this._oButton.domA,this.sActiveClass)}},clickCB:function(A){this.activateTool()},isActive:function(){return this.bActive}});Fusion.Tool.Canvas=OpenLayers.Class({context:null,canvas:null,width:null,height:null,initialize:function(){this.context=null;this.canvas=null;this.width=null;this.height=null;this.mouseMoveCB=OpenLayers.Function.bindAsEventListener(this.mouseMove,this);this.mouseUpCB=OpenLayers.Function.bindAsEventListener(this.mouseUp,this);this.mouseDownCB=OpenLayers.Function.bindAsEventListener(this.mouseDown,this);this.dblClickCB=OpenLayers.Function.bindAsEventListener(this.dblClick,this);this.resizeCanvasFn=OpenLayers.Function.bind(this.resizeCanvas,this)},clearContext:function(){if(this.context){this.context.clearRect(0,0,this.width,this.height)}},activateCanvas:function(){var C=this.getMap();C.registerForEvent(Fusion.Event.MAP_RESIZED,this.resizeCanvasFn);var A=C.getDomObj();var B=Element.getDimensions(A);this.width=B.width;this.height=B.height;if(!this.canvas){this.canvas=document.createElement("canvas");if(typeof G_vmlCanvasManager!="undefined"){document.getElementsByTagName("BODY")[0].appendChild(this.canvas);G_vmlCanvasManager.initElement(this.canvas);this.canvas=document.getElementsByTagName("BODY")[0].lastChild}this.canvas.id="featureDigitizer";this.canvas.style.position="absolute";this.canvas.style.top="0px";this.canvas.style.left="0px";this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width;this.canvas.height=this.height}A.appendChild(this.canvas);if(!this.context){this.context=this.canvas.getContext("2d")}this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width;this.canvas.height=this.height;C.observeEvent("mousemove",this.mouseMoveCB);C.observeEvent("mouseup",this.mouseUpCB);C.observeEvent("mousedown",this.mouseDownCB);C.observeEvent("dblclick",this.dblClickCB)},resizeCanvas:function(){var C=this.getMap();var A=C.getDomObj();var B=Element.getDimensions(A);this.width=B.width;this.height=B.height;this.canvas.style.width=this.width+"px";this.canvas.style.height=this.height+"px";this.canvas.width=this.width;this.canvas.height=this.height},deactivateCanvas:function(){var A=this.getMap();A.deregisterForEvent(Fusion.Event.MAP_RESIZED,this.resizeCanvasFn);A.getDomObj().removeChild(this.canvas);this.context.clearRect(0,0,this.width,this.height);A.stopObserveEvent("mousemove",this.mouseMoveCB);A.stopObserveEvent("mouseup",this.mouseUpCB);A.stopObserveEvent("mousedown",this.mouseDownCB);A.stopObserveEvent("dblclick",this.dblClickCB)},mouseDown:function(A){},mouseUp:function(A){},mouseMove:function(A){},dblClick:function(A){}});Fusion.Tool.Canvas.Point=OpenLayers.Class({center:null,radius:null,lineStyle:null,fillStyle:null,initialize:function(A){this.center=new Fusion.Tool.Canvas.Node(0,0,A);this.radius=5;this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:2,strokeStyle:"rgba(0,0,0,1.0)"});this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:"rgba(0,0,255, 0.5)"});this.segments=[]},setPoint:function(A,B){this.center.set(A,B)},getPoint:function(){this.center.updateGeo();return{x:this.center.x,y:this.center.y}},draw:function(C){var B=this.center.px;var D=this.center.py;var A=this.radius;this.fillStyle.apply(C);this.lineStyle.apply(C);C.beginPath();C.arc(B,D,A,0,2*Math.PI,1);C.closePath();C.fill();C.stroke()},getNodes:function(){return[this.center]},clean:function(){},updateGeo:function(){this.center.updateGeo()},updatePx:function(){this.center.updatePx()}});Fusion.Tool.Canvas.Circle=OpenLayers.Class({map:null,center:null,radius:null,radiusPx:null,start:null,end:null,lineStyle:null,fillStyle:null,initialize:function(A){this.map=A;this.center=new Fusion.Tool.Canvas.Node(0,0,A);this.radius=1;this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:2,strokeStyle:"rgba(0,0,0,1.0)"});this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:"rgba(0,0,255, 0.5)"});this.segments=[]},setCenter:function(A,B){this.center.set(A,B)},setRadius:function(A){this.radius=Math.abs(A);this.radiusPx=this.map.geoToPixMeasure(this.radius)},draw:function(A){var G=this.center.px;var E=this.center.py;var B=this.radiusPx;this.fillStyle.apply(A);this.lineStyle.apply(A);A.beginPath();if(this.start&&this.end){A.moveTo(G,E);var I=this.start;var C=this.end;if(I<C){var H=I;I=C;C=H}var F=G+Math.sin(I)*B;var D=E-Math.cos(I)*B;A.lineTo(F,D);A.arc(G,E,B,I-Math.PI/2,C-Math.PI/2,1);A.lineTo(G,E)}else{A.arc(G,E,B,0,2*Math.PI,1)}A.closePath();A.fill();A.stroke()},getNodes:function(){return[this.center]},clean:function(){},updateGeo:function(){this.center.updateGeo();this.radius=this.map.pixToGeoMeasure(this.radiusPx)},updatePx:function(){this.center.updatePx();this.radiusPx=this.map.geoToPixMeasure(this.radius)}});Fusion.Tool.Canvas.Polygon=OpenLayers.Class({segments:null,lineStyle:null,fillStyle:null,map:null,initialize:function(A){this.map=A;this.segments=[];this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:2,strokeStyle:"rgba(0,0,0,1.0)"});this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:"rgba(0,0,255, 0.5)"})},clean:function(){var A=this.getNodes();this.segments=[];var D=A[0];var C=A[1];for(var B=1;B<A.length;B++){if(D.x!=C.x||D.y!=C.y){this.addSegment(new Fusion.Tool.Canvas.Segment(D,C));D=C}C=A[B]}this.addSegment(new Fusion.Tool.Canvas.Segment(D,A[0]))},getNodes:function(){var A=[];A.push(this.segments[0].from);for(var B=0;B<this.segments.length;B++){A.push(this.segments[B].to)}return A},reverseNodes:function(){var D=this.segments.length;if(!D){return }for(var C=0;C<D;C++){var A=this.segments[C];var B=A.from;A.from=A.to;A.to=B}this.segments.reverse()},removeNode:function(B){if(B==this.segments[0].from){this.segments[0].from=null;this.segments.shift();this.segments[0].from=this.segments[this.segments.length-1].to;return }if(B==this.segments[this.segments.length-1].from){this.segments[this.segments.length-1].from=null;this.segments.pop();this.segments[0].from=this.segments[this.segments.length-1].to;return }for(var A=1;A<this.segments.length;A++){if(B==this.segments[A].from){this.segments[A-1].to=this.segments[A].to;this.segments[A].from=null;this.segments.splice(A,1);return }}},draw:function(C){var A=this.segments[0].from.px;var F=this.segments[0].from.py;if(this.segments.length>2){this.fillStyle.apply(C);C.beginPath();C.moveTo(A,F);for(var B=0;B<this.segments.length;B++){var D=this.segments[B];C.lineTo(D.to.px,D.to.py)}C.lineTo(A,F);C.closePath();C.fill()}this.lineStyle.apply(C);for(var B=0;B<this.segments.length;B++){this.segments[B].draw(C)}var E=this.lastSegment();C.beginPath();C.moveTo(E.to.px,E.to.py);C.lineTo(A,F);C.stroke()},addSegment:function(A){A.normalStyle=this.lineStyle;this.segments[this.segments.length]=A},lastSegment:function(){return this.segments[this.segments.length-1]},segmentTo:function(B){var C=arguments.length>1?arguments[1]:3;for(var A=0;A<this.segments.length;A++){if(this.segments[A].hasTo(B,C)){return this.segments[A]}}return null},segmentFrom:function(B){var C=arguments.length>1?arguments[1]:3;for(var A=0;A<this.segments.length;A++){if(this.segments[A].hasFrom(B,C)){return this.segments[A]}}return null},extendLine:function(){var C=this.lastSegment();var B=new Fusion.Tool.Canvas.Node(C.to.x,C.to.y,this.map);var A=new Fusion.Tool.Canvas.Segment(C.to,B);this.addSegment(A);return A},contains:function(A){return true},toString:function(){var B=this.segments[0].from.toString();for(var A=0;A<this.segments.length;A++){B+=","+this.segments[A].to.toString()}return"POLYGON("+B+")"},updateGeo:function(){for(var A=0;A<this.segments.length;A++){this.segments[A].updateGeo()}},updatePx:function(){for(var A=0;A<this.segments.length;A++){this.segments[A].updatePx()}}});Fusion.Tool.Canvas.Line=OpenLayers.Class({segments:null,lineStyle:null,map:null,initialize:function(A){this.map=A;this.segments=[];this.lineStyle=new Fusion.Tool.Canvas.Style({strokeStyle:"rgba(0,0,0,1.0)"})},clean:function(){var A=this.getNodes();this.segments=[];var D=A[0];var C=A[1];for(var B=1;B<A.length;B++){C=A[B];if(D.x!=C.x||D.y!=C.y){this.addSegment(new Fusion.Tool.Canvas.Segment(D,C));D=C}}},getNodes:function(){var A=[];A.push(this.segments[0].from);for(var B=0;B<this.segments.length;B++){A.push(this.segments[B].to)}return A},reverseNodes:function(){var D=this.segments.length;if(!D){return }for(var C=0;C<D;C++){var A=this.segments[C];var B=A.from;A.from=A.to;A.to=B}this.segments.reverse()},removeNode:function(B){if(B==this.segments[0].from){this.segments[0].from=null;this.segments.shift();return }if(B==this.segments[this.segments.length-1].from){this.segments[this.segments.length-1].from=null;this.segments.pop();return }for(var A=1;A<this.segments.length;A++){if(B==this.segments[A].from){this.segments[A-1].to=this.segments[A].to;this.segments[A].from=null;this.segments.splice(A,1);return }}},draw:function(B){for(var A=0;A<this.segments.length;A++){this.segments[A].draw(B)}},addSegment:function(A){A.normalStyle=this.lineStyle;this.segments[this.segments.length]=A},lastSegment:function(){return this.segments[this.segments.length-1]},segmentTo:function(B){var C=arguments.length>1?arguments[1]:3;for(var A=0;A<this.segments.length;A++){if(this.segments[A].hasTo(B,C)){return this.segments[A]}}return null},segmentFrom:function(B){var C=arguments.length>1?arguments[1]:3;for(var A=0;A<this.segments.length;A++){if(this.segments[A].hasFrom(B,C)){return this.segments[A]}}return null},extendLine:function(){var C=this.lastSegment();var B=new Fusion.Tool.Canvas.Node(C.to.x,C.to.y,this.map);var A=new Fusion.Tool.Canvas.Segment(C.to,B);this.addSegment(A);return A},updateGeo:function(){for(var A=0;A<this.segments.length;A++){this.segments[A].updateGeo()}},updatePx:function(){for(var A=0;A<this.segments.length;A++){this.segments[A].updatePx()}}});Fusion.Tool.Canvas.Segment=OpenLayers.Class({from:null,to:null,initialize:function(B,A){this.from=B;this.to=A;this.isEditing=false;this.normalStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,strokeStyle:"rgba(0,0,0,1.0)"});this.editStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,strokeStyle:"rgba(255,0,0,1.0)"})},hasTo:function(A,B){return this.to.near({x:A.px,y:A.py},B)},hasFrom:function(A,B){return this.from.near({x:A.px,y:A.py},B)},intersectsPoint:function(C,F){var B=Math.min(this.to.px,this.from.px);var G=Math.max(this.to.px,this.from.px);if(C.x>G||C.x<B){return false}var E=Math.max(this.to.py,this.from.py);var H=Math.min(this.to.py,this.from.py);if(C.y<H||C.y>E){return false}var A=parseFloat((E-H))/(G-B);var D=A*(C.x-B)+H;return(D-F<C.y&&D+F>C.y)},setNormalStyle:function(A){this.normalStyle=A},setEditStyle:function(A){this.editStyle=A},draw:function(A){if(this.isEditing){this.editStyle.apply(A)}else{this.normalStyle.apply(A)}A.beginPath();A.moveTo(this.from.px,this.from.py);A.lineTo(this.to.px,this.to.py);A.closePath();A.stroke();if(this.isEditing){this.from.draw(A);this.to.draw(A)}},setEditing:function(A){this.isEditing=A},toString:function(){return this.from.toString()+", "+this.to.toString()},updateGeo:function(){this.from.updateGeo();this.to.updateGeo()},updatePx:function(){this.from.updatePx();this.to.updatePx()}});Fusion.Tool.Canvas.Node=OpenLayers.Class({x:null,y:null,px:null,py:null,uid:null,map:null,counter:[0],isSelected:false,initialize:function(A,D,C){this.map=C;this.set(A,D);var B=C.geoToPix(A,D);this.setPx(B.x,B.y);this.radius=3;this.uid=this.counter[0];this.counter[0]++;this.normalStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,strokeStyle:"rgba(0,0,0,1.0)"});this.selectedStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,fillStyle:"rgba(255,0,0,1.0)",strokeStyle:"rgba(255,0,0,1.0)"})},set:function(A,C){this.x=A;this.y=C;var B=this.map.geoToPix(A,C);this.setPx(B.x,B.y)},setPx:function(B,A){this.px=B;this.py=A},updateGeo:function(){if(!this.px||!this.py){return }var A=this.map.pixToGeo(this.px,this.py);this.set(A.x,A.y)},updatePx:function(){if(!this.x||!this.y){return }var A=this.map.geoToPix(this.x,this.y);this.setPx(A.x,A.y)},near:function(B,C){var A=B.x-C;var E=B.x+C;var D=B.y+C;var F=B.y-C;return((this.px>A&&this.px<E)&&(this.py>F&&this.py<D))?true:false},within:function(D){var A=Math.min(D[0],D[2]);var C=Math.max(D[0],D[2]);var E=Math.min(D[1],D[3]);var B=Math.max(D[1],D[3]);return((this.px>A&&this.px<C)&&(this.py>E&&this.py<B))?true:false},draw:function(A){if(this.isSelected){this.selectedStyle.apply(A)}else{this.normalStyle.apply(A)}A.beginPath();A.arc(this.px,this.py,this.radius,0,2*Math.PI,1);A.closePath();A.stroke();if(this.isSelected){A.fill()}},setSelected:function(A){this.isSelected=A},toString:function(){return"("+this.uid+") "+this.x+" ["+this.px+"px] "+this.y+" ["+this.py+"px] "}});Fusion.Tool.Canvas.Style=OpenLayers.Class({properties:["fillStyle","globalAlpha","globalCompositeOperation","lineCap","lineJoin","lineWidth","miterLimit","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","strokeStyle"],initialize:function(C){for(var A=0;A<this.properties.length;A++){var B=this.properties[A];this[B]=C[B]?C[B]:null}},set:function(B,A){this[B]=A},apply:function(B){for(var A=0;A<this.properties.length;A++){var C=this.properties[A];if(this[C]){B[C]=this[C]}}}});Fusion.Tool.Click=OpenLayers.Class({initialize:function(){this.mouseUpCB=OpenLayers.Function.bindAsEventListener(this.mouseUp,this)},execute:function(A,B){},activateClickTool:function(){if(this.oMap){this.oMap.observeEvent("mouseup",this.mouseUpCB)}},deactivateClickTool:function(){if(this.oMap){this.oMap.stopObserveEvent("mouseup",this.mouseUpCB)}},mouseUp:function(B){if(OpenLayers.Event.isLeftClick(B)){var A=this.oMap.getEventPosition(B);this.execute(A.x,A.y)}}});Fusion.Tool.Rectangle=OpenLayers.Class({oRectDiv:null,_sStartPos:null,_bIsActive:null,initialize:function(){this.oRectDiv=document.createElement("div");this.oRectDiv.style.position="absolute";this.oRectDiv.style.border="1px solid red";this.oRectDiv.style.top="0px";this.oRectDiv.style.left="0px";this.oRectDiv.style.width="1px";this.oRectDiv.style.height="1px";this.oRectDiv.style.visibility="hidden";this.oRectDiv.style.lineHeight="1px";this.oRectDiv.style.zIndex=99;this._bIsActive=false;this.mouseMoveCB=OpenLayers.Function.bindAsEventListener(this.mouseMove,this);this.mouseUpCB=OpenLayers.Function.bindAsEventListener(this.mouseUp,this);this.mouseDownCB=OpenLayers.Function.bindAsEventListener(this.mouseDown,this);this.mouseOutCB=OpenLayers.Function.bindAsEventListener(this.mouseOut,this)},execute:function(B,A,D,C){},activateRectTool:function(){if(this._bIsActive){return }if(this.oMap){this.oRectDiv.style.left="0px";this.oRectDiv.style.top="0px";this.oRectDiv.style.width="1px";this.oRectDiv.style.height="1px";this.oRectDiv.style.visibility="hidden";this._bIsActive=true;var A=this.oMap.getDomObj();A.appendChild(this.oRectDiv);this.oMap.observeEvent("mousemove",this.mouseMoveCB);this.oMap.observeEvent("mouseup",this.mouseUpCB);this.oMap.observeEvent("mousedown",this.mouseDownCB)}},deactivateRectTool:function(){this._sStartPos=null;if(!this._bIsActive){return }this._bIsActive=false;var A=this.oMap.getDomObj();A.removeChild(this.oRectDiv);this.oMap.stopObserveEvent("mousemove",this.mouseMoveCB);this.oMap.stopObserveEvent("mouseup",this.mouseUpCB);this.oMap.stopObserveEvent("mousedown",this.mouseDownCB)},mouseDown:function(B){if(OpenLayers.Event.isLeftClick(B)){var A=this.oMap.getEventPosition(B);this._sStartPos=A;this.oRectDiv.style.left=A.x+"px";this.oRectDiv.style.top=A.y+"px";this.oRectDiv.style.width="1px";this.oRectDiv.style.height="1px";this.oRectDiv.style.visibility="visible";OpenLayers.Event.observe(document,"mouseout",this.mouseOutCB)}OpenLayers.Event.stop(B)},mouseUp:function(E){if(this._sStartPos!=null){var C=parseInt(this.oRectDiv.style.top);var B=parseInt(this.oRectDiv.style.left);var D=B+parseInt(this.oRectDiv.style.width);var A=C+parseInt(this.oRectDiv.style.height);this.event=E;this.execute(B,A,D,C);this.oRectDiv.style.left="0px";this.oRectDiv.style.top="0px";this.oRectDiv.style.width="1px";this.oRectDiv.style.height="1px";this.oRectDiv.style.visibility="hidden";this._sStartPos=null;OpenLayers.Event.stop(E)}OpenLayers.Event.stopObserving(document,"mouseout",this.mouseOutCB)},mouseMove:function(F){if(this._sStartPos!=null){var E=this.oMap.getEventPosition(F);var B=this._sStartPos.x;var C=this._sStartPos.y;var D=E.x;var A=E.y;this.oRectDiv.style.left=Math.min(B,D)+"px";this.oRectDiv.style.top=Math.min(C,A)+"px";this.oRectDiv.style.width=Math.abs(D-B)+"px";this.oRectDiv.style.height=Math.abs(C-A)+"px";OpenLayers.Event.stop(F)}},mouseOut:function(B){var A=B.target||B.srcElement;if(A.tagName.toLowerCase()=="html"){this.mouseUp(B)}}});Fusion.Tool.Search=OpenLayers.Class({lastSearch:null,lastResult:null,resultOffset:0,initialize:function(){},getProperties:function(){var A=null;if(this.lastResult&&this.lastResult.properties){A=this.lastResult.properties}return A},getNumberOfProperties:function(){var A=0;if(this.lastResult&&this.lastResult.properties){A=this.lastResult.properties.length}return A},getProperty:function(B){var A="";if(this.lastResult&&this.lastResult.properties){A=this.lastResult.properties[B]}return A},getNumberOfResults:function(){result=0;if(this.lastResult&&this.lastResult.values){result=this.lastResult.values.length}return result},getFirstResult:function(){this.resultOffset=0;return this.getResult(this.resultOffset)},getNextResult:function(){this.resultOffset++;return this.getResult(this.resultOffset)},getResult:function(A){result=null;if(this.lastResult&&this.lastResult.values){result=this.lastResult.values[A]}return result},zoomToResult:function(B){var B="&filter="+B;var A=this.getMap().arch+"/"+Fusion.getScriptLanguage()+"/Query."+Fusion.getScriptLanguage();var C={};C.parameters="session="+this.getMap().getSessionID()+"&mapname="+this.getMap().getMapName()+"&layers="+this.layerName+B;C.onComplete=OpenLayers.Function.bind(this.selectComplete,this);Fusion.ajaxRequest(A,C)},selectComplete:function(B){var A=new DomNode(B.responseXML);var C=A.getNodeText("Selection");if(C=="true"){this.getMap().newSelection();this.getMap().getSelection(OpenLayers.Function.bind(this.zoomToSelection,this))}},zoomToSelection:function(C){var D=C.getLowerLeftCoord();var E=C.getUpperRightCoord();var B=E.x-D.x;var A=E.y-D.y;D.x=D.x-B;E.x=E.x+B;D.y=D.y-A;E.y=E.y+A;this.getMap().setExtents(new OpenLayers.Bounds(D.x,D.y,E.x,E.y))}});Fusion.Event.MAP_EXTENTS_CHANGED=Fusion.Event.lastEventId++;Fusion.Event.MAP_BUSY_CHANGED=Fusion.Event.lastEventId++;Fusion.Event.MAP_GENERIC_EVENT=Fusion.Event.lastEventId++;Fusion.Event.MAP_RESIZED=Fusion.Event.lastEventId++;Fusion.Event.MAP_SELECTION_ON=Fusion.Event.lastEventId++;Fusion.Event.MAP_SELECTION_OFF=Fusion.Event.lastEventId++;Fusion.Event.MAP_ACTIVE_LAYER_CHANGED=Fusion.Event.lastEventId++;Fusion.Event.MAP_LOADED=Fusion.Event.lastEventId++;Fusion.Event.MAP_LOADING=Fusion.Event.lastEventId++;Fusion.Event.MAP_RELOADED=Fusion.Event.lastEventId++;Fusion.Event.MAP_SESSION_CREATED=Fusion.Event.lastEventId++;Fusion.Constant.LAYER_POINT_TYPE=0;Fusion.Constant.LAYER_LINE_TYPE=1;Fusion.Constant.LAYER_POLYGON_TYPE=2;Fusion.Constant.LAYER_SOLID_TYPE=3;Fusion.Constant.LAYER_RASTER_TYPE=4;Fusion.Constant.LAYER_DWF_TYPE=5;Fusion.Widget.Map=OpenLayers.Class(Fusion.Lib.EventMgr,{_oDomObj:null,_sDomObj:"",_sMapname:"",_nWidth:-1,_nHeight:-1,_fMetersperunit:-1,_fScale:-1,_nDpi:96,_oCurrentExtents:null,maxExtent:new OpenLayers.Bounds(),_nWorkers:0,oContextMenu:null,bSupressContextMenu:false,aMaps:null,layerRoot:null,singleTile:true,fractionalZoom:true,maxScale:null,initialize:function(widgetTag,mapGroup,widgetSet){this.widgetTag=widgetTag;var name=widgetTag.name;this.widgetSet=widgetSet;this._nCellSize=-1;this._sDomObj=name;this._oDomObj=$(this._sDomObj);this.layerRoot=new Fusion.Widget.Map.Group();if(this._oDomObj.jxLayout){this._oDomObj.jxLayout.addSizeChangeListener(this)}if(widgetTag.extension.FractionalZoom){this.fractionalZoom=widgetTag.extension.FractionalZoom[0]=="false"?false:true}var scalesArray=null;if(widgetTag.extension.Scales){scalesArray=widgetTag.extension.Scales[0].split(",");this.fractionalZoom=false}if(widgetTag.extension.MaxScale){this.maxScale=parseInt(widgetTag.extension.MaxExtent[0])}var maxExtent=null;if(widgetTag.extension.MaxExtent){maxExtent=OpenLayers.Bounds.fromString(widgetTag.extension.MaxExtent[0])}OpenLayers.DOTS_PER_INCH=this._nDpi;if(!this.oMapOL){var options={controls:[],fallThrough:true,scales:scalesArray,fractionalZoom:this.fractionalZoom};if(widgetTag.extension.ConstrainMapExtent){this.bRestrictExtent=widgetTag.extension.ConstrainMapExtent[0]=="true"?true:false}if(maxExtent){options.maxExtent=maxExtent;this.maxExtent=maxExtent}this.oMapOL=new OpenLayers.Map(this._sDomObj,options)}this.oMapOL.viewPortDiv.style.position="absolute";this.oMapOL.viewPortDiv.style.zIndex=0;var useMouseWheel=true;if(widgetTag.extension.DisableMouseWheel&&widgetTag.extension.DisableMouseWheel[0]=="true"){useMouseWheel=false}if(useMouseWheel){this.wheelHandler=new OpenLayers.Handler.MouseWheel(this,{up:this.wheelUp,down:this.wheelDown});this.wheelHandler.map=this.oMapOL;this.wheelHandler.activate()}this.aMaps=[];this.mapGroup=mapGroup;for(var i=0;i<mapGroup.maps.length;++i){var mapTag=mapGroup.maps[i];if(Fusion.Maps[mapTag.type]){this.aMaps[i]=eval("new Fusion.Maps."+mapTag.type+"(this,mapTag)");this.layerRoot.addGroup(this.aMaps[i].layerRoot)}else{}}$(name).widget=this;this.registerEventID(Fusion.Event.MAP_EXTENTS_CHANGED);this.registerEventID(Fusion.Event.MAP_BUSY_CHANGED);this.registerEventID(Fusion.Event.MAP_GENERIC_EVENT);this.registerEventID(Fusion.Event.MAP_RESIZED);this.registerEventID(Fusion.Event.MAP_ACTIVE_LAYER_CHANGED);this.registerEventID(Fusion.Event.MAP_LOADED);this.registerEventID(Fusion.Event.MAP_LOADING);this.registerEventID(Fusion.Event.MAP_RELOADED);this.registerEventID(Fusion.Event.MAP_SELECTION_ON);this.registerEventID(Fusion.Event.MAP_SELECTION_OFF);this.registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.mapLoaded,this));this.oMapOL.events.register("moveend",this,this.mapExtentsChanged);this._oDomObj.oncontextmenu=function(){return false};this._oDomObj.onselectstart=function(){return false};OpenLayers.Event.observe(this._oDomObj,"contextmenu",OpenLayers.Function.bind(this.onContextMenu,this));this.aSelectionCallbacks=[];this.bFetchingSelection=false},mapLoaded:function(){this.setViewOptions(this.getUnits())},setMenu:function(){if(this.widgetTag.extension.MenuContainer){var B=new Jx.ContextMenu();var A=this.widgetSet.getContainerByName(this.widgetTag.extension.MenuContainer[0]);if(A){A.createWidgets(this.widgetSet,B);this.setContextMenu(B)}}},loadMapGroup:function(mapGroup){while(this.isBusy()){this._removeWorker()}this.clearSelection();this.mapGroup=mapGroup;for(var i=0;i<this.aMaps.length;i++){this.aMaps[i].oLayerOL.destroy()}this.aMaps=[];this.layerRoot=new Fusion.Widget.Map.Group();for(var i=0;i<mapGroup.maps.length;++i){var mapTag=mapGroup.maps[i];if(Fusion.Maps[mapTag.type]){this.aMaps[i]=eval("new Fusion.Maps."+mapTag.type+"(this,mapTag)");this.layerRoot.addGroup(this.aMaps[i].layerRoot)}else{}}},wheelChange:function(I,D){var J=this.oMapOL.getSize();var G=J.w/2-I.xy.x;var F=I.xy.y-J.h/2;var E=D>0?0.5:2;var H=this.oMapOL.baseLayer.getResolution()*E;var A=this.oMapOL.getLonLatFromPixel(I.xy);var C=new OpenLayers.LonLat(A.lon+G*H,A.lat+F*H);var B=new OpenLayers.Bounds(C.lon-J.w*H/2,C.lat-J.h*H/2,C.lon+J.w*H/2,C.lat+J.h*H/2);this.setExtents(B)},wheelUp:function(A){this.wheelChange(A,1)},wheelDown:function(A){this.wheelChange(A,-1)},getDomObj:function(){return this._oDomObj},getMapName:function(){return this.aMaps[0].getMapName()},getMapTitle:function(){return this.aMaps[0]._sMapTitle},getSessionID:function(){return this.aMaps[0].getSessionID()},getDomId:function(){return this._sDomObj},setMapOptions:function(A){this.oMapOL.setOptions(A)},addMap:function(A){if(!A.bSingleTile){this.singleTile=false}this.projection=A.projection;this.units=A.units;this.maxExtent.extend(A._oMaxExtent);this.oMapOL.setOptions({maxExtent:this.maxExtent,units:A.units,projection:this.projection});if(this.bRestrictExtent!=null){if(this.bRestrictExtent){this.oMapOL.restrictedExtent=A._oMaxExtent}else{this.oMapOL.restrictedExtent=false}}this.oMapOL.addLayer(A.oLayerOL);A.registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.selectionHandler,this));A.registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.selectionHandler,this))},getAllMaps:function(){return this.aMaps},reloadMap:function(){for(var A=0;A<this.aMaps.length;++A){var B=this.aMaps[A];window.setTimeout(OpenLayers.Function.bind(B.reloadMap,B),1)}},query:function(A){for(var B=0;B<this.aMaps.length;B++){if(this.aMaps[B].query(A)){}}},selectionHandler:function(){if(this.hasSelection()){this.triggerEvent(Fusion.Event.MAP_SELECTION_ON)}else{this.triggerEvent(Fusion.Event.MAP_SELECTION_OFF)}},hasSelection:function(){for(var A=0;A<this.aMaps.length;A++){if(this.aMaps[A].hasSelection()){return true}}return false},clearSelection:function(){this.oSelection=null;for(var A=0;A<this.aMaps.length;A++){this.aMaps[A].clearSelection()}},getSelection:function(D,C,B){var C=(arguments[1])?arguments[1]:"";var B=(arguments[2])?arguments[2]:"";this.aSelectionCallbacks.push(D);if(this.bFetchingSelection){return }this.bFetchingSelection=true;this.oSelection={};this.nSelectionMaps=0;for(var A=0;A<this.aMaps.length;A++){this.nSelectionMaps++;this.aMaps[A].getSelection(OpenLayers.Function.bind(this.accumulateSelection,this,this.aMaps[A]),C,B)}},setSelection:function(C,B){for(var A=0;A<this.aMaps.length;A++){this.aMaps[A].setSelection(C,B)}},accumulateSelection:function(C,B){this.oSelection[C._sMapname]=B;if(!--this.nSelectionMaps){this.bFetchingSelection=false;for(var A=0;A<this.aSelectionCallbacks.length;A++){this.aSelectionCallbacks[A](this.oSelection)}this.aSelectionCallbacks=[]}},setActiveLayer:function(A){this.oActiveLayer=A;this.oActiveMap=A.map;this.triggerEvent(Fusion.Event.MAP_ACTIVE_LAYER_CHANGED,A)},getActiveLayer:function(){return this.oActiveLayer},_addWorker:function(){this._nWorkers+=1;this.triggerEvent(Fusion.Event.MAP_BUSY_CHANGED,this);this._oDomObj.style.cursor="wait"},_removeWorker:function(){if(this._nWorkers>0){this._nWorkers-=1}this.setCursor(this.cursor);this.triggerEvent(Fusion.Event.MAP_BUSY_CHANGED,this)},mapExtentsChanged:function(){this._oCurrentExtents=this.oMapOL.getExtent();this.triggerEvent(Fusion.Event.MAP_EXTENTS_CHANGED)},isBusy:function(){return this._nWorkers>0},sizeChanged:function(){this.resize()},resize:function(){this.oMapOL.updateSize();var A=Element.getDimensions(this.getDomObj());this._nWidth=A.width;this._nHeight=A.height;if(this._oCurrentExtents){this.setExtents(this._oCurrentExtents)}this.triggerEvent(Fusion.Event.MAP_RESIZED,this)},redraw:function(){for(var A=0;A<this.aMaps.length;A++){this.aMaps[A].oLayerOL.params.ts=(new Date()).getTime()}this.oMapOL.setCenter(this.oMapOL.getCenter(),this.oMapOL.getZoom(),false,true)},setExtents:function(B){if(!B){Fusion.reportError(new Fusion.Error(Fusion.Error.WARNING,OpenLayers.i18n("nullExtents")))}if(B instanceof Array&&B.length==4){B=new OpenLayers.Bounds(B[0],B[1],B[2],B[3])}for(var A=0;A<this.aMaps.length;A++){this.aMaps[A].oLayerOL.params.ts=(new Date()).getTime()}this.oMapOL.zoomToExtent(B);this._oCurrentExtents=this.oMapOL.getExtent()},setInitialExtents:function(){var C;var D=Fusion.getQueryParam("extent");if(D){C=new OpenLayers.Bounds.fromArray(D.split(","))}else{if(this.mapGroup.initialView){var A=this.mapGroup.getInitialView();if(A.x){C=this.getExtentFromPoint(A.x,A.y,A.scale)}else{if(A.minX){C=new OpenLayers.Bounds(A.minX,A.minY,A.maxX,A.maxY)}}if(!C.intersectsBounds(this.maxExtent)){Fusion.reportError("AppDef initial view is outside map maxExtent, resetting initialView to maxExtent");C=this.maxExtent}}else{C=new OpenLayers.Bounds();for(var B=0;B<this.aMaps.length;++B){C.extend(this.aMaps[B]._oMaxExtent)}}}this.initialExtents=C;return C},fullExtents:function(){var A=this.maxExtent;this.setExtents(A)},isMapLoaded:function(){return(this._oCurrentExtents)?true:false},zoom:function(F,E,C){if(C==1||C==0){this.oMapOL.panTo(new OpenLayers.LonLat(F,E))}else{var J=this.oMapOL.getExtent();if(this.fractionalZoom){var K=J.right-J.left;var I=J.top-J.bottom;var H,D,G,B;if(C>0){H=F-(K/2/C);D=F+(K/2/C);G=E-(I/2/C);B=E+(I/2/C)}else{if(C<0){H=F-((K/2)*Math.abs(C));D=F+((K/2)*Math.abs(C));G=E-((I/2)*Math.abs(C));B=E+((I/2)*Math.abs(C))}}this.setExtents(new OpenLayers.Bounds(H,G,D,B))}else{var A=this.oMapOL.getZoom();if(C>1){this.oMapOL.zoomTo(A+1)}else{if(C<1){this.oMapOL.zoomTo(A-1)}}}}},zoomToScale:function(B){var A=this.getCurrentCenter();var C=this.getExtentFromPoint(A.x,A.y,B);this.setExtents(C)},queryRect:function(D,C,B,A){},queryPoint:function(B,A){},pixToGeo:function(C,A){var B=this.oMapOL.getLonLatFromPixel(new OpenLayers.Pixel(C,A));if(B!=null){return{x:B.lon,y:B.lat}}return null},geoToPix:function(C,B){if(!(this._oCurrentExtents)){return null}var A=this.oMapOL.getPixelFromLonLat(new OpenLayers.LonLat(C,B));return{x:Math.floor(A.x),y:Math.floor(A.y)}},pixToGeoMeasure:function(A){var B=this.oMapOL.getResolution();return(A*B)},setMetersPerUnit:function(A){if(this._fMetersperunit<0){Fusion.initUnits(A);this._fMetersperunit=A}else{if(A!=this._fMetersperunit){Fusion.reportError(new Fusion.Error(Fusion.Error.WARNING,"meters per unit value already set"))}}},getMetersPerUnit:function(){return this._fMetersperunit},setViewOptions:function(A){this.setWidgetParam("Units",A)},setWidgetParam:function(G,F){for(var C=0;C<Fusion.applicationDefinition.widgetSets.length;++C){var D=Fusion.applicationDefinition.widgetSets[C];for(var B=0;B<D.widgetInstances.length;++B){var E=D.widgetInstances[B];for(var A=0;A<E.paramRegister.length;++A){if(E.paramRegister[A]==G){E.setParameter(G,F)}}}}},geoToPixMeasure:function(A){return parseInt(A/this.oMapOL.getResolution())},getCurrentCenter:function(){var A=this.getCurrentExtents().getCenterLonLat();return{x:A.lon,y:A.lat}},getCurrentExtents:function(){return this.oMapOL.getExtent()},getExtentFromPoint:function(F,E,A){if(!A){A=this.getScale()}var D=OpenLayers.Util.getResolutionFromScale(A,this.oMapOL.baseLayer.units);var C=this.getSize();var G=C.w*D;var B=C.h*D;return new OpenLayers.Bounds(F-G/2,E-B/2,F+G/2,E+B/2)},getScale:function(){return this.oMapOL.getScale()},getResolution:function(){return this.oMapOL.getResolution()},getUnits:function(){return this.oMapOL.baseLayer.units},getSize:function(){return this.oMapOL.getSize()},getEventPosition:function(A){return this.oMapOL.events.getMousePosition(A)},setCursor:function(B){this.cursor=B;if(this.isBusy()){return }if(B&&B.length&&typeof B=="object"){for(var A=0;A<B.length;A++){this._oDomObj.style.cursor=B[A];if(this._oDomObj.style.cursor==B[A]){break}}}else{if(typeof B=="string"){this._oDomObj.style.cursor=B}else{this._oDomObj.style.cursor="auto"}}},observeEvent:function(B,A){OpenLayers.Event.observe(this._oDomObj,B,A,false)},stopObserveEvent:function(B,A){OpenLayers.Event.stopObserving(this._oDomObj,B,A,false)},activateWidget:function(A){if(A.isMutEx()){if(this.oActiveWidget){this.deactivateWidget(this.oActiveWidget)}A.activate();this.oActiveWidget=A}else{A.activate()}},deactivateWidget:function(A){A.deactivate();this.oActiveWidget=null},isLoaded:function(){return(this.oMapOL.getExtent()!=null)},supressContextMenu:function(A){this.bSupressContextMenu=A},setContextMenu:function(A){this.oContextMenu=A},onContextMenu:function(A){if(this.oContextMenu&&!this.bSupressContextMenu&&this.isLoaded()){this.oContextMenu.show(A);this.contextMenuPosition=this.getEventPosition(A);OpenLayers.Event.stop(A)}},executeFromContextMenu:function(A){A.execute(this.contextMenuPosition.x,this.contextMenuPosition.y)}});Fusion.Event.LAYER_PROPERTY_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget.Map.Layer=OpenLayers.Class(Fusion.Lib.EventMgr,{name:null,initialize:function(A){this.name=A;this.registerEventID(Fusion.Event.LAYER_PROPERTY_CHANGED)},clear:function(){},set:function(B,A){this[B]=A;this.triggerEvent(Fusion.Event.LAYER_PROPERTY_CHANGED,this)}});Fusion.Event.GROUP_PROPERTY_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget.Map.Group=OpenLayers.Class(Fusion.Lib.EventMgr,{name:null,groups:null,layers:null,initialize:function(A){this.name=A;this.groups=[];this.layers=[];this.registerEventID(Fusion.Event.GROUP_PROPERTY_CHANGED)},clear:function(){for(var A=0;A<this.groups.length;A++){this.groups[A].clear()}for(var A=0;A<this.layers.length;A++){this.layers[A].clear()}this.groups=[];this.layers=[]},set:function(B,A){this[B]=A;this.triggerEvent(Fusion.Event.GROUP_PROPERTY_CHANGED,this)},addGroup:function(B,A){B.parentGroup=this;if(A){this.groups.unshift(B)}else{this.groups.push(B)}},addLayer:function(B,A){B.parentGroup=this;if(A){this.layers.unshift(B)}else{this.layers.push(B)}},findGroup:function(A){return this.findGroupByAttribute("name",A)},findGroupByAttribute:function(B,C){if(this[B]==C){return this}for(var A=0;A<this.groups.length;A++){var D=this.groups[A].findGroupByAttribute(B,C);if(D){return D}}return null},findLayer:function(A){return this.findLayerByAttribute("name",A)},findLayerByAttribute:function(C,D){for(var B=0;B<this.layers.length;B++){if(this.layers[B][C]==D){return this.layers[B]}}for(var B=0;B<this.groups.length;B++){var A=this.groups[B].findLayerByAttribute(C,D);if(A){return A}}return null}});Fusion.SelectionObject=OpenLayers.Class({aLayers:null,initialize:function(B){this.aLayers=[];this.nTotalElements=0;this.nLayers=0;if(B.layers&&B.layers.length>0){this.fMinX=B.extents.minx;this.fMinY=B.extents.miny;this.fMaxX=B.extents.maxx;this.fMaxY=B.extents.maxy;this.nLayers=B.layers.length;for(var A=0;A<B.layers.length;A++){this.aLayers[A]=new Fusion.SelectionObject.Layer(B,B.layers[A])}}},getNumElements:function(){return this.nTotalElements},getLowerLeftCoord:function(){return{x:this.fMinX,y:this.fMinY}},getUpperRightCoord:function(){return{x:this.fMaxX,y:this.fMaxY}},getNumLayers:function(){return this.nLayers},getLayerByName:function(B){var A=null;for(var C=0;C<this.nLayers;C++){if(this.aLayers[C].getName()==B){A=this.aLayers[C];break}}return A},getLayer:function(A){if(A>=0&&A<this.nLayers){return this.aLayers[A]}else{return null}}});Fusion.SelectionObject.Layer=OpenLayers.Class({sName:null,nElements:null,aElements:null,nProperties:null,aPropertiesName:null,aPropertiesTypes:null,type:null,area:null,distance:null,bbox:null,center:null,initialize:function(D,I){this.sName=I;this.nElements=D[I].numelements;this.aElements=[];this.nProperties=D[I].propertyvalues.length;this.aPropertiesName=[];this.aPropertiesName=D[I].propertyvalues;this.aPropertiesTypes=[];this.aPropertiesTypes=D[I].propertytypes;this.area=0;this.distance=0;for(var F=0;F<D[I].values.length;F++){this.aElements[F]=[];for(var E=0;E<D[I].values[F].length;E++){this.aElements[F][E]=D[I].values[F][E]}}for(var F=0;F<D[I].metadata.length;F++){var H=D[I].metadata[F];var G=H[0];var J=H[1];var A=H[2];var B=H[3];var C=H[4];this.area+=parseFloat(B);this.distance+=parseFloat(C)}},getName:function(){return this.sName},getNumElements:function(){return this.nElements},getNumProperties:function(){return this.nProperties},getPropertyNames:function(){return this.aPropertiesName},getPropertyTypes:function(){return this.aPropertiesTypes},getElementValue:function(B,A){if(B>=0&&B<this.nElements&&A>=0&&A<this.nProperties){return this.aElements[B][A]}else{return null}}});Fusion.Maps.MapGuide=OpenLayers.Class(Fusion.Lib.EventMgr,{arch:"MapGuide",session:[null],bSingleTile:null,aShowLayers:null,aHideLayers:null,aShowGroups:null,aHideGroups:null,aRefreshLayers:null,sActiveLayer:null,selectionType:"INTERSECTS",bSelectionOn:false,oSelection:null,bDisplayInLegend:true,bExpandInLegend:true,bMapLoaded:false,bIsMapWidgetLayer:true,bLayersReversed:false,_sResourceId:null,clientAgent:"Fusion Viewer",initialize:function(E,C,B){this.registerEventID(Fusion.Event.MAP_SESSION_CREATED);this.registerEventID(Fusion.Event.MAP_SELECTION_ON);this.registerEventID(Fusion.Event.MAP_SELECTION_OFF);this.registerEventID(Fusion.Event.MAP_LOADED);this.registerEventID(Fusion.Event.MAP_LOADING);this.mapWidget=E;this.oSelection=null;if(B!=null){this.bIsMapWidgetLayer=B}this.mapInfo=C.mapInfo;var G=C.extension;this.selectionType=G.SelectionType?G.SelectionType[0]:"INTERSECTS";this.ratio=G.MapRatio?G.MapRatio[0]:1;if(this.bIsMapWidgetLayer){var D=true;if(G.DisableCtrlClick&&G.DisableCtrlClick[0]=="true"){D=false}if(D){this.map=this.mapWidget.oMapOL;this.handler=new OpenLayers.Handler.Click(this,{click:OpenLayers.Function.bind(this.mouseUpCRTLClick,this)},{keyMask:OpenLayers.Handler.MOD_CTRL});this.handler.activate();this.nTolerance=2}}var F=Fusion.getQueryParam("theme");if(F!=""){this.sMapResourceId=F}else{this.sMapResourceId=C.resourceId?C.resourceId:""}rootOpts={displayInLegend:this.bDisplayInLegend,expandInLegend:this.bExpandInLegend,legendLabel:this._sMapname,groupName:"layerRoot"};this.layerRoot=new Fusion.Maps.MapGuide.Group(rootOpts,this);this.bSingleTile=C.singleTile;this.keepAliveInterval=parseInt(G.KeepAliveInterval?G.KeepAliveInterval[0]:300);var A=Fusion.sessionId;if(A){this.session[0]=A;this.mapSessionCreated()}else{this.createSession()}},createSession:function(){if(!this.session[0]){this.session[0]=this;var A=Fusion.getScriptLanguage();var C=this.arch+"/"+A+"/CreateSession."+A;var B={onSuccess:OpenLayers.Function.bind(this.createSessionCB,this)};Fusion.ajaxRequest(C,B)}if(this.session[0] instanceof Fusion.Maps.MapGuide){this.session[0].registerForEvent(Fusion.Event.MAP_SESSION_CREATED,OpenLayers.Function.bind(this.mapSessionCreated,this))}else{this.mapSessionCreated()}},createSessionCB:function(xhr){if(xhr.status==200){var o;eval("o="+xhr.responseText);this.session[0]=o.sessionId;this.triggerEvent(Fusion.Event.MAP_SESSION_CREATED)}},mapSessionCreated:function(){if(this.sMapResourceId!=""){this.loadMap(this.sMapResourceId)}window.setInterval(OpenLayers.Function.bind(this.pingServer,this),this.keepAliveInterval*1000)},sessionReady:function(){return(typeof this.session[0]=="string")},getSessionID:function(){return this.session[0]},getMapName:function(){return this._sMapname},getMapTitle:function(){return this._sMapTitle},loadMap:function(F,C){this.bMapLoaded=false;if(this._sResourceId==F){return }if(!this.sessionReady()){this.sMapResourceId=F;return }if(this.bIsMapWidgetLayer){this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADING)}else{this.triggerEvent(Fusion.Event.MAP_LOADING)}this.mapWidget._addWorker();this._fScale=-1;this._nDpi=96;C=C||{};this._oMaxExtent=null;this.aShowLayers=C.showlayers||[];this.aHideLayers=C.hidelayers||[];this.aShowGroups=C.showgroups||[];this.aHideGroups=C.hidegroups||[];this.aRefreshLayers=C.refreshlayers||[];this.aLayers=[];this.oSelection=null;this.aSelectionCallbacks=[];this._bSelectionIsLoading=false;var A=Fusion.getScriptLanguage();var B=this.arch+"/"+A+"/LoadMap."+A;var D=this.getSessionID();var E={mapid:F,session:D};var C={onSuccess:OpenLayers.Function.bind(this.mapLoaded,this),parameters:E};Fusion.ajaxRequest(B,C)},mapLoaded:function(r){if(r.status==200){var o;eval("o="+r.responseText);this._sResourceId=o.mapId;this._sMapname=o.mapName;this._sMapTitle=o.mapTitle;this.mapWidget.setMetersPerUnit(o.metersPerUnit);this._oMaxExtent=OpenLayers.Bounds.fromArray(o.extent);this.layerRoot.clear();this.layerRoot.legendLabel=this._sMapTitle;this.parseMapLayersAndGroups(o);this.minScale=10000000000;this.maxScale=0;for(var i=0;i<this.aLayers.length;i++){this.minScale=Math.min(this.minScale,this.aLayers[i].minScale);this.maxScale=Math.max(this.maxScale,this.aLayers[i].maxScale)}if(this.minScale<=0){this.minScale=1}for(var i=0;i<this.aShowLayers.length;i++){var layer=this.layerRoot.findLayerByAttribute("layerName",this.aShowLayers[i]);if(layer){this.aShowLayers[i]=layer.uniqueId}else{this.aShowLayers[i]=""}}for(var i=0;i<this.aHideLayers.length;i++){var layer=this.layerRoot.findLayerByAttribute("layerName",this.aHideLayers[i]);if(layer){this.aHideLayers[i]=layer.uniqueId}else{this.aHideLayers[i]=""}}for(var i=0;i<this.aShowGroups.length;i++){var group=this.layerRoot.findGroupByAttribute("groupName",this.aShowGroups[i]);if(group){this.aShowGroups[i]=group.uniqueId}else{this.aShowGroups[i]=""}}for(var i=0;i<this.aHideGroups.length;i++){var group=this.layerRoot.findGroupByAttribute("groupName",this.aHideGroups[i]);if(group){this.aHideGroups[i]=group.uniqueId}else{this.aHideGroups[i]=""}}if(!this.bSingleTile){if(o.groups.length>0){this.bSingleTile=false;this.groupName=o.groups[0].groupName;this.mapWidget.registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.mapExtentsChanged,this))}else{this.bSingleTile=true}}this.units=Fusion.getClosestUnits(o.metersPerUnit);if(o.FiniteDisplayScales&&o.FiniteDisplayScales.length>0){this.scales=o.FiniteDisplayScales;this.mapWidget.fractionalZoom=false;this.mapWidget.oMapOL.fractionalZoom=false}if(this.oLayerOL){this.oLayerOL.events.unregister("loadstart",this,this.loadStart);this.oLayerOL.events.unregister("loadend",this,this.loadEnd);this.oLayerOL.events.unregister("loadcancel",this,this.loadEnd);this.oLayerOL.destroy()}this.oLayerOL=this.createOLLayer(this._sMapname,true,this.bSingleTile);this.oLayerOL.events.register("loadstart",this,this.loadStart);this.oLayerOL.events.register("loadend",this,this.loadEnd);this.oLayerOL.events.register("loadcancel",this,this.loadEnd);this.bMapLoaded=true;if(this.bIsMapWidgetLayer){this.mapWidget.addMap(this);this.mapWidget.oMapOL.setBaseLayer(this.oLayerOL);var initialExtent=this.mapWidget.setInitialExtents();this.mapWidget.setExtents(initialExtent);this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADED)}else{this.triggerEvent(Fusion.Event.MAP_LOADED)}}this.mapWidget._removeWorker()},reloadMap:function(){this.mapWidget._addWorker();this.aShowLayers=[];this.aHideLayers=[];this.aShowGroups=[];this.aHideGroups=[];this.aRefreshLayers=[];this.layerRoot.clear();this.oldLayers=this.aLayers.clone();this.aLayers=[];var A=Fusion.getScriptLanguage();var B=this.arch+"/"+A+"/LoadMap."+A;var D=this.getSessionID();var E={mapname:this._sMapname,session:D};var C={onSuccess:OpenLayers.Function.bind(this.mapReloaded,this),onException:OpenLayers.Function.bind(this.reloadFailed,this),parameters:E};Fusion.ajaxRequest(B,C)},reloadFailed:function(A){Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.i18n("mapLoadError",{error:A.transport.responseText})));this.mapWidget._removeWorker()},mapReloaded:function(r){if(r.status==200){var o;eval("o="+r.responseText);this.parseMapLayersAndGroups(o);for(var i=0;i<this.aLayers.length;++i){var newLayer=this.aLayers[i];for(var j=0;j<this.oldLayers.length;++j){if(this.oldLayers[j].uniqueId==newLayer.uniqueId){newLayer.selectedFeatureCount=this.oldLayers[j].selectedFeatureCount;newLayer.noCache=this.oldLayers[j].noCache;break}}}this.oldLayers=null;this.mapWidget.triggerEvent(Fusion.Event.MAP_RELOADED);this.drawMap()}this.mapWidget._removeWorker()},reorderLayers:function(D){var A=Fusion.getScriptLanguage();var B=this.arch+"/"+A+"/SetLayers."+A;var E={mapname:this._sMapname,session:this.getSessionID(),layerindex:D.join()};var C={onSuccess:OpenLayers.Function.bind(this.mapLayersReset,this,D),parameters:E};Fusion.ajaxRequest(B,C)},mapLayersReset:function(aLayerIndex,r){if(r.status==200){var o;eval("o="+r.responseText);if(o.success){var layerCopy=this.aLayers.clone();this.aLayers=[];this.aVisibleLayers=[];for(var i=0;i<aLayerIndex.length;++i){this.aLayers.push(layerCopy[aLayerIndex[i]]);if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName)}}this.drawMap();this.triggerEvent(Fusion.Event.MAP_LAYER_ORDER_CHANGED)}else{alert(OpenLayers.i18n("setLayersError",{error:o.layerindex}))}}},parseMapLayersAndGroups:function(E){for(var B=0;B<E.groups.length;B++){var D=new Fusion.Maps.MapGuide.Group(E.groups[B],this);var C;if(D.parentUniqueId!=""){C=this.layerRoot.findGroupByAttribute("uniqueId",D.parentUniqueId)}else{C=this.layerRoot}C.addGroup(D,this.bLayersReversed)}for(var B=0;B<E.layers.length;B++){var A=new Fusion.Maps.MapGuide.Layer(E.layers[B],this);var C;if(A.parentGroup!=""){C=this.layerRoot.findGroupByAttribute("uniqueId",A.parentGroup)}else{C=this.layerRoot}C.addLayer(A,this.bLayersReversed);this.aLayers.push(A)}},drawMap:function(){if(!this.bMapLoaded){return }var A={ts:(new Date()).getTime(),showLayers:this.aShowLayers.length>0?this.aShowLayers.toString():null,hideLayers:this.aHideLayers.length>0?this.aHideLayers.toString():null,showGroups:this.aShowGroups.length>0?this.aShowGroups.toString():null,hideGroups:this.aHideGroups.length>0?this.aHideGroups.toString():null,refreshLayers:this.aRefreshLayers.length>0?this.aRefreshLayers.toString():null};this.aShowLayers=[];this.aHideLayers=[];this.aShowGroups=[];this.aHideGroups=[];this.aRefreshLayers=[];this.oLayerOL.mergeNewParams(A);if(this.queryLayer){this.queryLayer.redraw()}},createOLLayer:function(B,D,F){var E={units:this.units,isBaseLayer:D,maxExtent:this._oMaxExtent,maxResolution:"auto",ratio:this.ratio};if(!/WebKit/.test(navigator.userAgent)){E.transitionEffect="resize"}if(this.scales&&this.scales.length>0){E.scales=this.scales}if(this.maxScale!=Infinity){E.minScale=this.maxScale}else{if(this.mapWidget.minScale){E.minScale=this.mapWidget.maxScale}}E.maxScale=this.minScale;E.singleTile=F;var G={};if(F){G={session:this.getSessionID(),mapName:this._sMapname,clientagent:this.clientAgent};G.showLayers=this.aShowLayers.length>0?this.aShowLayers.toString():null;G.hideLayers=this.aHideLayers.length>0?this.aHideLayers.toString():null;G.showGroups=this.aShowGroups.length>0?this.aShowGroups.toString():null;G.hideGroups=this.aHideGroups.length>0?this.aHideGroups.toString():null;G.refreshLayers=this.aRefreshLayers.length>0?this.aRefreshLayers.toString():null}else{G={mapdefinition:this._sResourceId,basemaplayergroupname:this.groupName,session:this.getSessionID(),clientagent:this.clientAgent}}var A=Fusion.getConfigurationItem("mapguide","mapAgentUrl");var C=new OpenLayers.Layer.MapGuide(B,A,G,E);return C},getLayerByName:function(B){var A=null;for(var C=0;C<this.aLayers.length;C++){if(this.aLayers[C].layerName==B){A=this.aLayers[C];break}}return A},isMapLoaded:function(){return this.bMapLoaded},hasSelection:function(){return this.bSelectionOn},getSelectionCB:function(userFunc,layers,startend,r){if(r.status==200){var o;eval("o="+r.responseText);var oSelection=new Fusion.SelectionObject(o);userFunc(oSelection)}},newSelection:function(){if(this.oSelection){this.oSelection=null}this.bSelectionOn=true;this.drawMap();this.triggerEvent(Fusion.Event.MAP_SELECTION_ON)},getSelectedFeatureCount:function(){var B=0;for(var A=0;A<this.aLayers.length;++A){B+=this.aLayers[A].selectedFeatureCount}return B},getSelectedLayers:function(){var B=[];for(var A=0;A<this.aLayers.length;++A){if(this.aLayers[A].selectedFeatureCount>0){B.push(this.aLayers[A])}}return B},getSelectableLayers:function(){var B=[];for(var A=0;A<this.aLayers.length;++A){if(this.aLayers[A].selectable){B.push(this.aLayers[A])}}return B},zoomToSelection:function(C){var A=C.getCenterPixel();var B=C.getSize();C.left=A.x-2*B.w;C.right=A.x+2*B.w;C.bottom=A.y-2*B.h;C.top=A.y+2*B.h;this.mapWidget.setExtents(C)},setSelection:function(F,E){this.mapWidget._addWorker();var A=Fusion.getScriptLanguage();var C=this.arch+"/"+A+"/SetSelection."+A;var D={mapname:this.getMapName(),session:this.getSessionID(),selection:F,seq:Math.random()};var B={onSuccess:OpenLayers.Function.bind(this.processQueryResults,this,E),parameters:D,asynchronous:false};Fusion.ajaxRequest(C,B)},getSelection:function(E,D,C){if(E){var B=this.arch+"/"+Fusion.getScriptLanguage()+"/Selection."+Fusion.getScriptLanguage();var A={parameters:{session:this.getSessionID(),mapname:this._sMapname,layers:D,startcount:C},onSuccess:OpenLayers.Function.bind(this.getSelectionCB,this,E,D,C)};Fusion.ajaxRequest(B,A)}},selectionCleared:function(){for(var A=0;A<this.aLayers.length;++A){this.aLayers[A].selectedFeatureCount=0}this.bSelectionOn=false;if(this.queryLayer){this.queryLayer.setVisibility(false)}this.triggerEvent(Fusion.Event.MAP_SELECTION_OFF);this.drawMap();this.oSelection=null},clearSelection:function(){if(this.hasSelection()){var B=this.arch+"/"+Fusion.getScriptLanguage()+"/ClearSelection."+Fusion.getScriptLanguage();var A={parameters:{session:this.getSessionID(),mapname:this._sMapname},onSuccess:OpenLayers.Function.bind(this.selectionCleared,this)};Fusion.ajaxRequest(B,A)}},removeQueryLayer:function(){if(this.queryLayer){this.queryLayer.destroy();this.queryLayer=null}},processQueryResults:function(zoomTo,r){this.mapWidget._removeWorker();if(r.responseText){var oNode;eval("oNode="+r.responseText);if(oNode.hasSelection){if(!this.bSingleTile){if(!this.queryLayer){this.queryLayer=this.createOLLayer("query layer",false,true);this.mapWidget.oMapOL.addLayer(this.queryLayer);this.mapWidget.registerForEvent(Fusion.Event.MAP_LOADING,OpenLayers.Function.bind(this.removeQueryLayer,this))}else{this.queryLayer.setVisibility(true)}}for(var i=0;i<oNode.layers.length;++i){var layerName=oNode.layers[i];for(var j=0;j<this.aLayers.length;++j){if(layerName==this.aLayers[j].layerName){this.aLayers[j].selectedFeatureCount=oNode[layerName].featureCount}}}if(zoomTo){var ext=oNode.extents;var extents=new OpenLayers.Bounds(ext.minx,ext.miny,ext.maxx,ext.maxy);this.zoomToSelection(extents)}this.newSelection()}else{this.clearSelection();return }}},query:function(E){this.mapWidget._addWorker();for(var D=0;D<this.aLayers.length;++D){this.aLayers[D].selectedFeatureCount=0}var H=E.persistent||true;var G=E.zoomTo?true:false;var A=Fusion.getScriptLanguage();var C=this.arch+"/"+A+"/Query."+A;var F={mapname:this._sMapname,session:this.getSessionID(),spatialfilter:E.geometry||"",computed:E.computed||"",queryHiddenLayers:E.queryHiddenLayers||"false",maxfeatures:E.maxFeatures||0,layers:E.layers||"",variant:E.selectionType||this.selectionType};if(E.filter){F.filter=E.filter}if(E.extendSelection){F.extendselection=true}if(E.computedProperties){F.computed=true}var B={onSuccess:OpenLayers.Function.bind(this.processQueryResults,this,G),parameters:F};Fusion.ajaxRequest(C,B)},processLayerEvents:function(E,B){if(this.mapInfo&&this.mapInfo.mapEvents.layerEvents[E.layerName]){var G=this.mapInfo.mapEvents.layerEvents[E.layerName];var D=B?G.onEnable:G.onDisable;for(var C=0;C<D.length;C++){var H=D[C];if(H.type=="layer"){var A=this.layerRoot.findLayer(H.name);if(A){if(H.enable){A.show(true)}else{A.hide(true)}}}else{if(H.type=="group"){var F=this.layerRoot.findGroupByAttribute("groupName",H.name);if(F){if(H.enable){F.show(true)}else{F.hide(true)}}}}}}},processGroupEvents:function(F,B){if(this.mapInfo&&this.mapInfo.mapEvents.groupEvents[F.groupName]){var H=this.mapInfo.mapEvents.groupEvents[F.groupName];var D=B?H.onEnable:H.onDisable;for(var C=0;C<D.length;C++){var G=D[C];if(G.type=="layer"){var A=this.layerRoot.findLayer(G.name);if(A){if(G.enable){A.show(true)}else{A.hide(true)}}}else{if(G.type=="group"){var E=this.layerRoot.findGroupByAttribute("groupName",G.name);if(E){if(G.enable){E.show(true)}else{E.hide(true)}}}}}}},showLayer:function(A,B){this.processLayerEvents(A,true);this.aShowLayers.push(A.uniqueId);if(!B){this.drawMap()}},hideLayer:function(A,B){this.processLayerEvents(A,false);this.aHideLayers.push(A.uniqueId);if(!B){this.drawMap()}},showGroup:function(B,A){this.processGroupEvents(B,true);if(B.groupName=="layerRoot"){this.oLayerOL.setVisibility(true)}else{this.aShowGroups.push(B.uniqueId);if(!A){this.drawMap()}}},hideGroup:function(B,A){this.processGroupEvents(B,false);if(B.groupName=="layerRoot"){this.oLayerOL.setVisibility(false)}else{this.aHideGroups.push(B.uniqueId);if(!A){this.drawMap()}}},refreshLayer:function(A){this.aRefreshLayers.push(A.uniqueId);this.drawMap()},setParameter:function(B,A){if(B=="SelectionType"){this.selectionType=A}},loadStart:function(){this.mapWidget._addWorker()},loadEnd:function(){this.mapWidget._removeWorker()},mouseUpCRTLClick:function(K){if(K.ctrlKey){var D=this.mapWidget.pixToGeo(K.xy.x-this.nTolerance,K.xy.y-this.nTolerance);var I=this.mapWidget.pixToGeo(K.xy.x+this.nTolerance,K.xy.y+this.nTolerance);if(!D){return }var F="POLYGON(("+D.x+" "+D.y+", "+D.x+" "+I.y+", "+I.x+" "+I.y+", "+I.x+" "+D.y+", "+D.x+" "+D.y+"))";var B=1;var G=0;var J="INTERSECTS";var H="";var C=3;var M="";for(var E=0;E<this.aLayers.length;++E){H+=M+this.aLayers[E].layerName;M=","}var A=new Fusion.Lib.MGRequest.MGQueryMapFeatures(this.mapWidget.getSessionID(),this._sMapname,F,B,G,J,H,C);var L=OpenLayers.Function.bind(this.crtlClickDisplay,this);Fusion.oBroker.dispatchRequest(A,OpenLayers.Function.bind(Fusion.xml2json,this,L))}},crtlClickDisplay:function(xhr){if(xhr.status==200){var o;eval("o="+xhr.responseText);var h=o.FeatureInformation["Hyperlink"];if(h){var linkURL;if(h[0].indexOf("href=")>0){var tempDiv=document.createElement("div");tempDiv.innerHTML=h[0];linkURL=tempDiv.firstChild.href;tempDiv=null}else{linkURL=h[0]}window.open(linkURL,"")}}},mapExtentsChanged:function(){if(!this.singleTile){var A=this.mapWidget.oMapOL.getCenter();var C=this.mapWidget.oMapOL.getSize();var B=new Fusion.Lib.MGRequest.MGGetVisibleMapExtent(this.mapWidget.getSessionID(),this._sMapname,A.lon,A.lat,this.mapWidget.oMapOL.getScale(),null,this._nDpi,C.w,C.h);Fusion.oBroker.dispatchRequest(B)}},pingServer:function(){var A=this.arch+"/"+Fusion.getScriptLanguage()+"/Common."+Fusion.getScriptLanguage();var B={};B.parameters={session:this.getSessionID()};Fusion.ajaxRequest(A,B)},getGroupInfoUrl:function(C){if(this.mapInfo){var A=this.mapInfo.links.groups;for(var B=0;B<A.length;B++){if(A[B].name==C){return A[B].url}}}return null},getLayerInfoUrl:function(A){if(this.mapInfo){var C=this.mapInfo.links.layers;for(var B=0;B<C.length;B++){if(C[B].name==A){return C[B].url}}}return null}});Fusion.Maps.MapGuide.Group=OpenLayers.Class(Fusion.Widget.Map.Group,{oMap:null,initialize:function(B,A){this.uniqueId=B.uniqueId;Fusion.Widget.Map.Group.prototype.initialize.apply(this,[B.groupName]);this.oMap=A;this.groupName=B.groupName;this.legendLabel=B.legendLabel;this.parentUniqueId=B.parentUniqueId;this.groupType=B.groupType;this.displayInLegend=B.displayInLegend;this.expandInLegend=B.expandInLegend;this.visible=B.visible;this.actuallyVisible=B.actuallyVisible},show:function(A){if(this.visible){return }this.oMap.showGroup(this,A?true:false);this.visible=true;if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=true}},hide:function(A){if(!this.visible){return }this.oMap.hideGroup(this,A?true:false);this.visible=false;if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=false}},isVisible:function(){return this.visible}});Fusion.Maps.MapGuide.Layer=OpenLayers.Class(Fusion.Widget.Map.Layer,{scaleRanges:null,oMap:null,initialize:function(D,A){this.uniqueId=D.uniqueId;Fusion.Widget.Map.Layer.prototype.initialize.apply(this,[D.layerName]);this.oMap=A;this.layerName=D.layerName;this.uniqueId=D.uniqueId;this.resourceId=D.resourceId;this.legendLabel=D.legendLabel;this.selectable=D.selectable;this.selectedFeatureCount=0;this.layerTypes=[].concat(D.layerTypes);this.displayInLegend=D.displayInLegend;this.expandInLegend=D.expandInLegend;this.visible=D.visible;this.actuallyVisible=D.actuallyVisible;this.editable=D.editable;this.layerType=null;if(this.supportsType(Fusion.Constant.LAYER_RASTER_TYPE)){this.layerType=Fusion.Constant.LAYER_RASTER_TYPE}else{if(this.supportsType(Fusion.Constant.LAYER_DWF_TYPE)){this.layerType=Fusion.Constant.LAYER_DWF_TYPE}}this.parentGroup=D.parentGroup;this.scaleRanges=[];this.minScale=10000000000;this.maxScale=0;for(var B=0;B<D.scaleRanges.length;B++){var C=new Fusion.Maps.MapGuide.ScaleRange(D.scaleRanges[B],this.layerType);this.scaleRanges.push(C);this.minScale=Math.min(this.minScale,C.minScale);this.maxScale=Math.max(this.maxScale,C.maxScale)}},supportsType:function(B){for(var A=0;A<this.layerTypes.length;A++){if(this.layerTypes[A]==B){return true}}return false},getScaleRange:function(A){for(var B=0;B<this.scaleRanges.length;B++){if(this.scaleRanges[B].contains(A)){return this.scaleRanges[B]}}return null},show:function(A){if(this.visible){return }this.oMap.showLayer(this,A?true:false);this.set("visible",true);if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=true}},hide:function(A){if(!this.visible){return }this.oMap.hideLayer(this,A?true:false);this.set("visible",false);if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=false}},isVisible:function(){return this.visible}});Fusion.Maps.MapGuide.ScaleRange=OpenLayers.Class({styles:null,initialize:function(E,B){this.minScale=E.minScale;this.maxScale=E.maxScale;if(this.maxScale=="infinity"){this.maxScale=Infinity}this.styles=[];if(!E.styles){var D=new Fusion.Maps.MapGuide.StyleItem({legendLabel:"DWF"},B);this.styles.push(D);return }var C=E.styles.length>1?false:B;for(var A=0;A<E.styles.length;A++){var D=new Fusion.Maps.MapGuide.StyleItem(E.styles[A],C);this.styles.push(D)}},contains:function(A){var B=Math.round(A);return B>=this.minScale&&B<=this.maxScale}});Fusion.Maps.MapGuide.StyleItem=OpenLayers.Class({clientAgent:"Fusion Viewer",initialize:function(B,A){this.legendLabel=B.legendLabel;this.filter=B.filter;this.geometryType=B.geometryType;if(this.geometryType==""){this.geometryType=-1}this.categoryIndex=B.categoryIndex;if(this.categoryindex==""){this.categoryindex=-1}this.staticIcon=A},getLegendImageURL:function(B,C){var A=Fusion.getConfigurationItem("mapguide","mapAgentUrl");A+="?OPERATION=GETLEGENDIMAGE&SESSION="+C.oMap.getSessionID();A+="&VERSION=1.0.0&SCALE="+B;A+="&LAYERDEFINITION="+encodeURIComponent(C.resourceId);A+="&THEMECATEGORY="+this.categoryIndex;A+="&TYPE="+this.geometryType;A+="&CLIENTAGENT="+encodeURIComponent(this.clientAgent);if(C.noCache){A+="&TS="+(new Date()).getTime()}return A}});var mapWidgetId="Map";function Refresh(){var A=window.top.Fusion;var B=A.getWidgetById(mapWidgetId);if(B&&B.isMapLoaded()){B.redraw()}}function SetSelectionXML(C){var A=window.top.Fusion;var B=A.getWidgetById(mapWidgetId);if(B&&B.isMapLoaded()){B.setSelection(C,true)}}function ZoomToView(B,G,F,E){var A=window.top.Fusion;var C=A.getWidgetById(mapWidgetId);if(C&&C.isMapLoaded()){var D=C.getExtentFromPoint(B,G,F);C.setExtents(D)}}function DigitizePoint(C){if(C){var A=window.top.Fusion;var B=A.getWidgetById(mapWidgetId);var D=new A.Tool.Canvas.Point(B);D.mouseUp=PointHandlers.prototype.mouseUp;Object.inheritFrom(D,A.Tool.Canvas.prototype,[]);D.handler=C;D.activateCanvas();var B=A.getWidgetById(mapWidgetId);B.registerForEvent(A.Event.MAP_EXTENTS_CHANGED,function(){D.updatePx();D.clearContext();D.draw(D.context)})}}function DigitizeLine(C){if(C){var A=window.top.Fusion;var B=A.getWidgetById(mapWidgetId);var D=new A.Tool.Canvas.Line(B);D.mouseDown=LineHandlers.prototype.mouseDown;D.mouseMove=LineHandlers.prototype.mouseMove;Object.inheritFrom(D,A.Tool.Canvas.prototype,[]);D.handler=C;D.activateCanvas();var B=A.getWidgetById(mapWidgetId);B.registerForEvent(A.Event.MAP_EXTENTS_CHANGED,function(){D.updatePx();D.clearContext();D.draw(D.context)})}}function DigitizeLineString(C){if(C){var A=window.top.Fusion;var B=A.getWidgetById(mapWidgetId);var D=new A.Tool.Canvas.Line(B);D.mouseDown=MultiPointHandlers.prototype.mouseDown;D.mouseMove=MultiPointHandlers.prototype.mouseMove;D.dblClick=MultiPointHandlers.prototype.dblClick;Object.inheritFrom(D,A.Tool.Canvas.prototype,[]);D.handler=C;D.activateCanvas();var B=A.getWidgetById(mapWidgetId);B.registerForEvent(A.Event.MAP_EXTENTS_CHANGED,function(){D.updatePx();D.clearContext();D.draw(D.context)})}}function DigitizeRectangle(C){if(C){var A=window.top.Fusion;var B=A.getWidgetById(mapWidgetId);var D=new A.Tool.Canvas.Polygon(B);D.mouseDown=RectangleHandlers.prototype.mouseDown;D.mouseMove=RectangleHandlers.prototype.mouseMove;Object.inheritFrom(D,A.Tool.Canvas.prototype,[]);D.handler=C;D.activateCanvas();var B=A.getWidgetById(mapWidgetId);B.registerForEvent(A.Event.MAP_EXTENTS_CHANGED,function(){D.updatePx();D.clearContext();D.draw(D.context)})}}function DigitizePolygon(C){if(C){var A=window.top.Fusion;var B=A.getWidgetById(mapWidgetId);var D=new A.Tool.Canvas.Polygon(B);D.mouseDown=MultiPointHandlers.prototype.mouseDown;D.mouseMove=MultiPointHandlers.prototype.mouseMove;D.dblClick=MultiPointHandlers.prototype.dblClick;Object.inheritFrom(D,A.Tool.Canvas.prototype,[]);D.handler=C;D.activateCanvas();var B=A.getWidgetById(mapWidgetId);B.registerForEvent(A.Event.MAP_EXTENTS_CHANGED,function(){D.updatePx();D.clearContext();D.draw(D.context)})}}Fusion.Tool.Canvas.prototype.getMap=function(){return Fusion.getWidgetById(mapWidgetId)};Fusion.Tool.Canvas.prototype.deactivateCanvas=function(){var A=this.getMap();A.deregisterForEvent(Fusion.Event.MAP_RESIZED,this.resizeCanvasFn);A.stopObserveEvent("mousemove",this.mouseMoveCB);A.stopObserveEvent("mouseup",this.mouseUpCB);A.stopObserveEvent("mousedown",this.mouseDownCB);A.stopObserveEvent("dblclick",this.dblClickCB)};PointHandlers=Class.create();PointHandlers.prototype={mouseUp:function(C){var B=this.getMap().getEventPosition(C);var A=this.getMap().pixToGeo(B.x,B.y);this.setPoint(A.x,A.y);this.clearContext();this.draw(this.context);this.isDigitizing=false;this.deactivateCanvas();this.handler(new Point(A.x,A.y))}};LineHandlers=Class.create();LineHandlers.prototype={mouseDown:function(G){if(Event.isLeftClick(G)){var B=this.getMap().getEventPosition(G);if(!this.isDigitizing){this.segments=[];var J=this.getMap().pixToGeo(B.x,B.y);var H=new Fusion.Tool.Canvas.Node(J.x,J.y,this.getMap());var I=new Fusion.Tool.Canvas.Node(J.x,J.y,this.getMap());var D=new Fusion.Tool.Canvas.Segment(H,I);D.setEditing(true);this.addSegment(D);this.clearContext();this.draw(this.context);this.isDigitizing=true}else{this.isDigitizing=false;var D=this.lastSegment();D.setEditing(false);this.clearContext();this.draw(this.context);this.deactivateCanvas();this.clean();var F=new LineString();var A=this.getNodes();for(var E=0;E<A.length;++E){var C=A[E];F.AddPoint(new Point(C.x,C.y))}this.handler(F)}}},mouseMove:function(C){if(!this.isDigitizing){return }var B=this.getMap().getEventPosition(C);var A=this.lastSegment();A.to.setPx(B.x,B.y);A.to.updateGeo();this.clearContext();this.draw(this.context)},};RectangleHandlers=Class.create();RectangleHandlers.prototype={mouseDown:function(E){if(Event.isLeftClick(E)){var D=this.getMap().getEventPosition(E);if(!this.isDigitizing){this.segments=[];var A=this.getMap().pixToGeo(D.x,D.y);var H=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());var G=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());this.seg1=new Fusion.Tool.Canvas.Segment(H,G);this.addSegment(this.seg1);H=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());G=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());this.seg2=new Fusion.Tool.Canvas.Segment(H,G);this.addSegment(this.seg2);H=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());G=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());this.seg3=new Fusion.Tool.Canvas.Segment(H,G);this.addSegment(this.seg3);H=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());G=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());this.seg4=new Fusion.Tool.Canvas.Segment(H,G);this.addSegment(this.seg4);this.clearContext();this.draw(this.context);this.isDigitizing=true}else{this.clearContext();this.draw(this.context);this.deactivateCanvas();this.clean();var F=new Point(this.seg1.from.x,this.seg1.from.y);var C=new Point(this.seg3.from.x,this.seg3.from.y);var B=new Rectangle(F,C);this.handler(B)}}},mouseMove:function(B){if(!this.isDigitizing){return }var A=this.getMap().getEventPosition(B);this.seg1.to.setPx(A.x,this.seg1.from.py);this.seg1.to.updateGeo();this.seg2.from.setPx(A.x,this.seg1.from.py);this.seg2.from.updateGeo();this.seg2.to.setPx(A.x,A.y);this.seg2.to.updateGeo();this.seg3.from.setPx(A.x,A.y);this.seg3.from.updateGeo();this.seg3.to.setPx(this.seg1.from.px,A.y);this.seg3.to.updateGeo();this.seg4.from.setPx(this.seg1.from.px,A.y);this.seg4.from.updateGeo();this.clearContext();this.draw(this.context)},};MultiPointHandlers=Class.create();MultiPointHandlers.prototype={mouseDown:function(D){if(Event.isLeftClick(D)){var C=this.getMap().getEventPosition(D);if(!this.isDigitizing){this.segments=[];var A=this.getMap().pixToGeo(C.x,C.y);var F=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());var E=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());var B=new Fusion.Tool.Canvas.Segment(F,E);B.setEditing(true);this.addSegment(B);this.clearContext();this.draw(this.context);this.isDigitizing=true}else{var B=this.lastSegment();B.setEditing(false);B=this.extendLine();B.setEditing(true);this.clearContext();this.draw(this.context)}}},mouseMove:function(C){if(!this.isDigitizing){return }var B=this.getMap().getEventPosition(C);var A=this.lastSegment();A.to.setPx(B.x,B.y);A.to.updateGeo();this.clearContext();this.draw(this.context)},dblClick:function(H){if(!this.isDigitizing){return }this.event=H;var G=this.getMap().getEventPosition(H);var A=this.getMap().pixToGeo(G.x,G.y);var C=this.lastSegment();C.setEditing(false);C.to.set(A.x,A.y);this.clearContext();this.draw(this.context);this.isDigitizing=false;this.deactivateCanvas();this.clean();var B=new LineString();var D=this.getNodes();for(var E=0;E<D.length;++E){var F=D[E];B.AddPoint(new Point(F.x,F.y))}this.handler(B)}};function Point(A,B){this.X=A;this.Y=B}function LineString(){this.points=new Array();this.Count=0;this.AddPoint=function(A){this.points.push(A);this.Count++};this.Point=function(A){if(A<0||A>=this.points.length){return null}return this.points[A]}}function Circle(){this.Center=null;this.Radius=0;this.SetRadius=function(A){dx=A.X-this.Center.X;dy=A.Y-this.Center.Y;this.Radius=Math.sqrt(dx*dx+dy*dy)}}function Rectangle(B,A){this.Point1=B;this.Point2=A}function Polygon(){this.LineStringInfo=LineString;this.LineStringInfo()}Fusion.Event.MAP_LAYER_ORDER_CHANGED=Fusion.Event.lastEventId++;Fusion.Maps.MapServer=OpenLayers.Class(Fusion.Lib.EventMgr,{arch:"MapServer",session:[null],aShowLayers:null,aHideLayers:null,aShowGroups:null,aHideGroups:null,aRefreshLayers:null,sActiveLayer:null,selectionType:"INTERSECTS",bSelectionOn:false,bDisplayInLegend:true,bExpandInLegend:true,oSelection:null,bMapLoaded:false,bIsMapWidgetLayer:true,bLayersReversed:true,mapMetadataKeys:null,layerMetadataKeys:null,sMapFile:null,_sImageType:"png",initialize:function(C,B,A){this.registerEventID(Fusion.Event.MAP_SESSION_CREATED);this.registerEventID(Fusion.Event.MAP_SELECTION_ON);this.registerEventID(Fusion.Event.MAP_SELECTION_OFF);this.registerEventID(Fusion.Event.MAP_LOADED);this.registerEventID(Fusion.Event.MAP_LOADING);this.registerEventID(Fusion.Event.MAP_LAYER_ORDER_CHANGED);this.mapWidget=C;this.oSelection=null;if(A!=null){this.bIsMapWidgetLayer=A}var D=B.extension;this.ratio=D.MapRatio?D.MapRatio[0]:"1.0";rootOpts={displayInLegend:this.bDisplayInLegend,expandInLegend:this.bExpandInLegend,legendLabel:this._sMapname,uniqueId:"layerRoot",groupName:"layerRoot",visible:true,actuallyVisible:true};this.layerRoot=new Fusion.Maps.MapServer.Group(rootOpts,this);this.sMapFile=D.MapFile?D.MapFile[0]:"";this.mapMetadataKeys=D.MapMetadata?D.MapMetadata[0]:null;this.layerMetadataKeys=D.LayerMetadata?D.LayerMetadata[0]:null;this.bSingleTile=B.singleTile;this.keepAliveInterval=parseInt(D.KeepAliveInterval?D.KeepAliveInterval[0]:300);if(B.sid){this.session[0]=B.sid;this.mapSessionCreated()}else{this.createSession()}},createSession:function(){if(!this.session[0]){this.session[0]=this;var A=Fusion.getScriptLanguage();var C=this.arch+"/"+A+"/CreateSession."+A;var B={onSuccess:OpenLayers.Function.bind(this.createSessionCB,this)};Fusion.ajaxRequest(C,B)}if(this.session[0] instanceof Fusion.Maps.MapServer){this.session[0].registerForEvent(Fusion.Event.MAP_SESSION_CREATED,OpenLayers.Function.bind(this.mapSessionCreated,this))}else{this.mapSessionCreated()}},createSessionCB:function(r){if(r.status==200){var o;eval("o="+r.responseText);this.session[0]=o.sessionId;this.triggerEvent(Fusion.Event.MAP_SESSION_CREATED)}},mapSessionCreated:function(){if(this.sMapFile!=""){this.loadMap(this.sMapFile)}window.setInterval(OpenLayers.Function.bind(this.pingServer,this),this.keepAliveInterval*1000)},sessionReady:function(){return(typeof this.session[0]=="string")},getSessionID:function(){return this.session[0]},getMapName:function(){return this._sMapname},getMapTitle:function(){return this._sMapTitle},loadMap:function(E,C){while(this.mapWidget.isBusy()){this.mapWidget._removeWorker()}this.bMapLoaded=false;if(this._sMapFile==E){return }if(!this.sessionReady()){this.sMapFile=E;return }if(this.bIsMapWidgetLayer){this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADING)}else{this.triggerEvent(Fusion.Event.MAP_LOADING)}this.mapWidget._addWorker();this._fScale=-1;this._nDpi=72;C=C||{};this._oMaxExtent=null;this.aVisibleLayers=C.showlayers||[];this.aVisibleGroups=C.showgroups||[];this.aLayers=[];this.oSelection=null;this.aSelectionCallbacks=[];this._bSelectionIsLoading=false;var A=Fusion.getScriptLanguage();var B=this.arch+"/"+A+"/LoadMap."+A;var D={mapfile:E,session:this.getSessionID()};if(this.mapMetadataKeys){D.map_metadata=this.mapMetadataKeys}if(this.layerMetadataKeys){D.layer_metadata=this.layerMetadataKeys}var C={onSuccess:OpenLayers.Function.bind(this.mapLoaded,this),parameters:D};Fusion.ajaxRequest(B,C)},mapLoaded:function(r){if(r.status==200){var o;eval("o="+r.responseText);this._sMapFile=o.mapId;this._sMapname=o.mapName;this._sMapTitle=o.mapTitle;this.mapWidget.setMetersPerUnit(o.metersPerUnit);this._sImageType=o.imagetype;this.metadata=o.metadata;this._oMaxExtent=OpenLayers.Bounds.fromArray(o.extent);this.layerRoot.clear();this.layerRoot.legendLabel=this._sMapTitle;this.parseMapLayersAndGroups(o);var minScale=10000000000;var maxScale=0;for(var i=0;i<this.aLayers.length;i++){if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName)}minScale=Math.min(minScale,this.aLayers[i].minScale);maxScale=Math.max(maxScale,this.aLayers[i].maxScale)}if(minScale<=0){minScale=1}if(o.dpi){OpenLayers.DOTS_PER_INCH=o.dpi}this.units=Fusion.getClosestUnits(o.metersPerUnit);var layerOptions={singleTile:true,ratio:this.ratio,units:this.units,maxExtent:this._oMaxExtent,maxResolution:"auto",minScale:maxScale,maxScale:minScale};var params={layers:this.aVisibleLayers.join(" "),session:this.getSessionID(),map:this._sMapFile,map_imagetype:this._sImageType};if(this.oLayerOL){this.oLayerOL.events.unregister("loadstart",this,this.loadStart);this.oLayerOL.events.unregister("loadend",this,this.loadEnd);this.oLayerOL.events.unregister("loadcancel",this,this.loadEnd);this.oLayerOL.destroy()}var url=Fusion.getConfigurationItem("mapserver","cgi");this.oLayerOL=new OpenLayers.Layer.MapServer(o.mapName,url,params,layerOptions);this.oLayerOL.events.register("loadstart",this,this.loadStart);this.oLayerOL.events.register("loadend",this,this.loadEnd);this.oLayerOL.events.register("loadcancel",this,this.loadEnd);if(this.bIsMapWidgetLayer){this.mapWidget.addMap(this);this.mapWidget.oMapOL.setBaseLayer(this.oLayerOL);this.mapWidget.oMapOL.units=this.oLayerOL.units;var initialExtent=this.mapWidget.setInitialExtents();this.mapWidget.setExtents(initialExtent);this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADED)}else{this.triggerEvent(Fusion.Event.MAP_LOADED)}this.bMapLoaded=true}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,"Failed to load requested map:\n"+r.responseText))}this.mapWidget._removeWorker()},reloadMap:function(){this.mapWidget._addWorker();this.aShowLayers=[];this.aHideLayers=[];this.aShowGroups=[];this.aHideGroups=[];this.aRefreshLayers=[];this.layerRoot.clear();this.aLayers=[];var A=Fusion.getScriptLanguage();var B=this.arch+"/"+A+"/LoadMap."+A;var D={mapname:this._sMapname,session:this.getSessionID()};if(this.mapMetadataKeys){D.map_metadata=this.mapMetadataKeys}if(this.layerMetadataKeys){D.layer_metadata=this.layerMetadataKeys}var C={onSuccess:OpenLayers.Function.bind(this.mapReloaded,this),parameters:D};Fusion.ajaxRequest(B,C)},mapReloaded:function(r){if(r.status==200){var o;eval("o="+r.responseText);this.parseMapLayersAndGroups(o);this.aVisibleLayers=[];for(var i=0;i<this.aLayers.length;i++){if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName)}}this.drawMap();this.mapWidget.triggerEvent(Fusion.Event.MAP_RELOADED)}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.i18n("mapLoadError",{error:r.responseText})))}this.mapWidget._removeWorker()},reorderLayers:function(D){var A=Fusion.getScriptLanguage();var B=this.arch+"/"+A+"/SetLayers."+A;var E={mapname:this._sMapname,session:this.getSessionID(),layerindex:D.join()};var C={onSuccess:OpenLayers.Function.bind(this.mapLayersReset,this,D),parameters:E};Fusion.ajaxRequest(B,C)},mapLayersReset:function(aLayerIndex,r){if(r.status==200){var o;eval("o="+r.responseText);if(o.success){var layerCopy=this.aLayers.clone();this.aLayers=[];this.aVisibleLayers=[];for(var i=0;i<aLayerIndex.length;++i){this.aLayers.push(layerCopy[aLayerIndex[i]]);if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName)}}this.drawMap();this.triggerEvent(Fusion.Event.MAP_LAYER_ORDER_CHANGED)}else{alert(OpenLayers.i18n("setLayersError",{error:o.layerindex}))}}},parseMapLayersAndGroups:function(E){for(var B=0;B<E.groups.length;B++){var D=new Fusion.Maps.MapServer.Group(E.groups[B],this);var C;if(D.parentUniqueId!=""){C=this.layerRoot.findGroup(D.parentUniqueId)}else{C=this.layerRoot}C.addGroup(D,this.bLayersReversed)}for(var B=0;B<E.layers.length;B++){var A=new Fusion.Maps.MapServer.Layer(E.layers[B],this);var C;if(A.parentGroup!=""){C=this.layerRoot.findGroup(A.parentGroup)}else{C=this.layerRoot}C.addLayer(A,this.bLayersReversed);this.aLayers.push(A)}},isMapLoaded:function(){return this.bMapLoaded},getScale:function(){return this.mapWidget.getScale()},updateLayer:function(){if(this.hasSelection()){this.oLayerOL.addOptions({queryfile:this._sQueryfile})}},drawMap:function(){if(!this.bMapLoaded||this.deferredDraw){return }var C=[];for(var B=0;B<this.aLayers.length;B++){var A=this.aLayers[B];if(A.isVisible()){C.push(A.layerName)}}var D={layers:C.join(" "),ts:(new Date()).getTime()};if(this.hasSelection()){D.queryfile=this._sQueryfile}else{D.queryfile=""}this.oLayerOL.mergeNewParams(D)},showLayer:function(A){this.aVisibleLayers.push(A);this.drawMap()},hideLayer:function(B){for(var A=0;A<this.aLayers.length;A++){if(this.aVisibleLayers[A]==B){this.aVisibleLayers.splice(A,1);break}}this.drawMap()},showGroup:function(A){if(A=="layerRoot"){this.oLayerOL.setVisibility(true)}else{this.aVisibleGroups.push(A);var C=this.layerRoot.findGroup(A);this.deferredDraw=true;for(var B=0;B<C.layers.length;++B){C.layers[B].show()}this.deferredDraw=false;this.drawMap()}},hideGroup:function(A){if(A=="layerRoot"){this.oLayerOL.setVisibility(false)}else{for(var B=0;B<this.aVisibleGroups.length;B++){if(this.aVisibleGroups[B]==A){this.aVisibleGroups.splice(B,1);break}}var C=this.layerRoot.findGroup(A);this.deferredDraw=true;for(var B=0;B<C.layers.length;++B){C.layers[B].hide()}this.deferredDraw=false;this.drawMap()}},refreshLayer:function(A){this.drawMap()},hasSelection:function(){return this.bSelectionOn},getSelectionCB:function(userFunc,layers,startend,r){if(r.status==200){var o;eval("o="+r.responseText);var oSelection=new Fusion.SelectionObject(o);userFunc(oSelection)}},newSelection:function(){this.bSelectionOn=true;this.drawMap();this.triggerEvent(Fusion.Event.MAP_SELECTION_ON)},getSelectedFeatureCount:function(){var B=0;for(var A=0;A<this.aLayers.length;++A){B+=this.aLayers[A].selectedFeatureCount}return B},getSelectedLayers:function(){var B=[];for(var A=0;A<this.aLayers.length;++A){if(this.aLayers[A].selectedFeatureCount>0){B.push(this.aLayers[A])}}return B},getSelectableLayers:function(){var B=[];for(var A=0;A<this.aLayers.length;++A){if(this.aLayers[A].selectable){B.push(this.aLayers[A])}}return B},getSelection:function(F,D,C){if(F){var B=this.arch+"/"+Fusion.getScriptLanguage()+"/Selection."+Fusion.getScriptLanguage();var E={mapname:this._sMapname,session:this.getSessionID(),layers:D,startcount:C,queryfile:this._sQueryfile};var A={parameters:E,onSuccess:OpenLayers.Function.bind(this.getSelectionCB,this,F,D,C)};Fusion.ajaxRequest(B,A)}},clearSelection:function(){if(!this.aLayers){return }for(var A=0;A<this.aLayers.length;++A){this.aLayers[A].selectedFeatureCount=0}this.bSelectionOn=false;this._sQueryfile="";this.triggerEvent(Fusion.Event.MAP_SELECTION_OFF);this.drawMap();this.oSelection=null},processQueryResults:function(zoomTo,r){this.mapWidget._removeWorker();if(r.status==200){var o;eval("o="+r.responseText);if(!o.hasSelection){return }else{this._sQueryfile=o.queryFile;for(var i=0;i<o.layers.length;++i){var layerName=o.layers[i];for(var j=0;j<this.aLayers.length;++j){if(layerName==this.aLayers[j].layerName){this.aLayers[j].selectedFeatureCount=o[layerName].featureCount}}}this.newSelection();if(zoomTo){var ext=oNode.extents;var extents=new OpenLayers.Bounds(ext.minx,ext.miny,ext.maxx,ext.maxy);this.zoomToSelection(extents)}}}},query:function(I){this.mapWidget._addWorker();for(var E=0;E<this.aLayers.length;++E){this.aLayers[E].selectedFeatureCount=0}var H=I.persistent||true;var G=I.layers||"";if(G==""){G=this.aVisibleLayers.join(",")}var F=I.zoomTo||false;var C=Fusion.getScriptLanguage();var B=this.arch+"/"+C+"/Query."+C;var D={mapname:this._sMapname,session:this.getSessionID(),spatialfilter:I.geometry||"",maxfeatures:I.maxFeatures||-1,layers:G,variant:I.selectionType||this.selectionType};if(I.filter){D.filter=I.filter}if(I.extendSelection){D.extendselection=true}if(I.computedProperties){D.computed=true}var A={onSuccess:OpenLayers.Function.bind(this.processQueryResults,this,F),parameters:D};Fusion.ajaxRequest(B,A)},loadStart:function(){this.mapWidget._addWorker()},loadEnd:function(){this.mapWidget._removeWorker()},pingServer:function(){var A=this.arch+"/"+Fusion.getScriptLanguage()+"/Common."+Fusion.getScriptLanguage();var B={};B.parameters={session:this.getSessionID()};Fusion.ajaxRequest(A,B)},getGroupInfoUrl:function(A){return null},getLayerInfoUrl:function(A){return null},getMetadata:function(A){if(typeof this.metadata[A]!="undefined"){return this.metadata[A]}else{return""}}});Fusion.Maps.MapServer.Group=OpenLayers.Class(Fusion.Widget.Map.Group,{oMap:null,initialize:function(B,A){this.uniqueId=B.uniqueId;Fusion.Widget.Map.Group.prototype.initialize.apply(this,[B.groupName]);this.oMap=A;this.groupName=B.groupName;this.legendLabel=B.legendLabel;this.parentUniqueId=B.parentUniqueId;this.groupType=B.groupType;this.displayInLegend=B.displayInLegend;this.expandInLegend=B.expandInLegend;this.visible=B.visible;this.actuallyVisible=B.actuallyVisible},clear:function(){Fusion.Widget.Map.Group.prototype.clear.apply(this,[])},show:function(){this.visible=true;this.oMap.showGroup(this.groupName)},hide:function(){this.visible=false;this.oMap.hideGroup(this.groupName)},isVisible:function(){var A=(this.parentGroup&&this.parentGroup.isVisible)?this.parentGroup.isVisible():true;return this.visible&&A}});var MSLAYER_POINT_TYPE=0;var MSLAYER_LINE_TYPE=1;var MSLAYER_POLYGON_TYPE=2;var MSLAYER_SOLID_TYPE=3;var MSLAYER_RASTER_TYPE=4;Fusion.Maps.MapServer.Layer=OpenLayers.Class(Fusion.Widget.Map.Group,{scaleRanges:null,oMap:null,initialize:function(D,A){this.uniqueId=D.uniqueId;Fusion.Widget.Map.Layer.prototype.initialize.apply(this,[this.uniqueId]);this.oMap=A;this.layerName=D.layerName;this.uniqueId=D.uniqueId;this.resourceId=D.resourceId;this.legendLabel=D.legendLabel;this.selectable=D.selectable;this.selectedFeatureCount=0;this.layerTypes=[].concat(D.layerTypes);this.displayInLegend=D.displayInLegend;this.expandInLegend=D.expandInLegend;this.visible=D.visible;this.actuallyVisible=D.actuallyVisible;this.editable=D.editable;this.parentGroup=D.parentGroup;this.metadata=D.metadata;this.extent=D.extent;this.scaleRanges=[];this.minScale=10000000000;this.maxScale=0;for(var B=0;B<D.scaleRanges.length;B++){var C=new Fusion.Maps.MapServer.ScaleRange(D.scaleRanges[B],this.supportsType(4));this.scaleRanges.push(C);this.minScale=Math.min(this.minScale,C.minScale);this.maxScale=Math.max(this.maxScale,C.maxScale)}},clear:function(){Fusion.Widget.Map.Layer.prototype.clear.apply(this,[]);this.oMap=null;this.legend=null},supportsType:function(B){for(var A=0;A<this.layerTypes.length;A++){if(this.layerTypes[A]==B){return true}}return false},getScaleRange:function(A){for(var B=0;B<this.scaleRanges.length;B++){if(this.scaleRanges[B].contains(A)){return this.scaleRanges[B]}}return null},show:function(){this.set("visible",true);this.oMap.showLayer(this.layerName)},hide:function(){this.set("visible",false);this.oMap.hideLayer(this.layerName)},isVisible:function(){var A=this.parentGroup?this.parentGroup.isVisible():true;return this.visible&&A},getMetadata:function(A){if(typeof this.metadata[A]!="undefined"){return this.metadata[A]}else{return""}}});Fusion.Maps.MapServer.ScaleRange=OpenLayers.Class({styles:null,initialize:function(F,A){this.minScale=F.minScale;this.maxScale=F.maxScale;this.styles=[];if(!F.styles){return }if(F.styles.length==0&&A){var B={};B.legendLabel="raster";B.filter="";B.index=0;B.staticIcon=true;var E=new Fusion.Maps.MapServer.StyleItem(B,B.staticIcon);this.styles.push(E)}else{var D=F.styles.length>=1?false:A;for(var C=0;C<F.styles.length;C++){var E=new Fusion.Maps.MapServer.StyleItem(F.styles[C],D);this.styles.push(E)}}},contains:function(A){var B=Math.round(A);return B>=this.minScale&&B<=this.maxScale}});Fusion.Maps.MapServer.StyleItem=OpenLayers.Class({initialize:function(B,A){this.legendLabel=B.legendLabel;this.filter=B.filter;this.index=B.index;this.staticIcon=A},getLegendImageURL:function(C,D){var A=Fusion.getScriptLanguage();var B=Fusion.getFusionURL()+"/"+D.oMap.arch+"/"+A+"/LegendIcon."+A;var E=D.oMap.getSessionID();var F="mapname="+D.oMap._sMapname+"&session="+E+"&layername="+D.resourceId+"&classindex="+this.index;return B+"?"+F}});Fusion.Strings.en={scriptFailed:"failed to load script: ${script}",configParseError:"Error parsing fusion configuration file, initialization aborted",configLoadError:"Error loading fusion configuration file, initialization aborted.Make sure that you have copied config_dist.json to config.json and have configured the settings for your system",ajaxError:"Exception occurred in AJAX callback.\nMessage: ${exception}\nLocation: ${filename} (${line})\nResponse: ${response}",importFailed:"failed to import stylesheet: ${url}",registerEventError:"Error registering eventID, invalid (empty) eventID.",appDefLoadFailed:"failed to load: ${script}",appDefParseError:"failed to parse ApplicationDefinition",widgetSetParseError:"failed to parse the WidgetSet",fusionError:"Fusion Error: ${type}\n${message}",nullExtents:"Map.setExtents called with null extents",mapLoadError:"Failed to load requested map:\n${error}",setLayersError:"setLayers failure: ${error}",printTitle:"Printable Page ",noSelection:"No Selection",selectionInfo:"${features} features selected on ${layers} layers",attribute:"Attribute",value:"Value",taskHome:"return to the task pane home",prevTask:"go to previous task executed",nextTask:"go to next task executed",taskList:"Task List",taskPane:"Task Pane",imperial:"Imperial",metric:"Metric",deg:"Degrees",refresh:"Refresh",expandAll:"Expand All",expand:"Expand",collapseAll:"Collapse All",collapse:"Collapse",defaultMapTitle:"Map",legendTitle:"Legend",selectionPanelTitle:"Selection",ovmapTitle:"Overview Map",ovmapTitleShort:"Overview",taskPaneTitle:"Tasks",segment:"Segment ${seg}",calculating:"calculating ...",panWest:"Pan West",panEast:"Pan East",panSouth:"Pan South",panNorth:"Pan North",zoomOut:"Zoom Out",zoomIn:"Zoom In",end:""};Fusion.Strings.fr={scriptFailed:"failed to load script: ${script}",configParseError:"Error parsing fusion configuration file, initialization aborted",configLoadError:"Error loading fusion configuration file, initialization aborted.Make sure that you have copied config_dist.json to config.json and have configured the settings for your system",ajaxError:"Exception occurred in AJAX callback.\n${exception}\nLocation: ${file} (${line}))",importFailed:"failed to import stylesheet: ${url}",registerEventError:"Error registering eventID, invalid (empty) eventID.",appDefLoadFailed:"failed to load: ${script}",appDefParseError:"failed to parse ApplicationDefinition",widgetSetParseError:"failed to parse the WidgetSet",fusionError:"Fusion Error: ${type}\n${message}",nullExtents:"Map.setExtents called with null extents",mapLoadError:"Failed to load requested map:\n${error}",setLayersError:"setLayers failure: ${error}",printTitle:"Printable Page ",noSelection:"Aucun Slection",selectionInfo:"${features} features selected on ${layers} layers",attribute:"Attribute",value:"Value",taskHome:"return to the task pane home",prevTask:"go to previous task executed",nextTask:"go to next task executed",taskList:"Task List",taskPane:"Task Pane",imperial:"Imperial",metric:"Metric",deg:"Degrees",refresh:"Refresh",expandAll:"Expand All",expand:"Expand",collapseAll:"Collapse All",collapse:"Collapse",defaultMapTitle:"Map",legendTitle:"Legend",selectionPanelTitle:"Slection",ovmapTitle:"Overview Map",ovmapTitleShort:"Overview",taskPaneTitle:"Tasks",segment:"Segment ${seg}",calculating:"calculating ...",panWest:"Ouest",panEast:"Est",panSouth:"Sud",panNorth:"Nord",zoomOut:"Cliquer pour rduire",zoomIn:"Cliquer pour agrandir",end:""};Fusion.Widget.About=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{_nWidth:500,_nHeight:400,_sDefaultUrl:"/mapguide/mapadmin/about.php",initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=B.extension;this._sAboutUrl=(A.AboutURL)?A.AboutURL[0]:this._sDefaultUrl;this.enable()},execute:function(){var A="menubar=no,location=no,resizable=no,status=no";A+=",width="+this._nWidth;A+=",height="+this._nHeight;window.open(this._sAboutUrl,"AboutPopup",A)}});Fusion.Widget.ActivityIndicator=OpenLayers.Class(Fusion.Widget,{element:null,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);this.element=this.domObj;var A=B.extension;if(A.ElementId){var C=$(A.ElementId[0]);if(C&&C!=this.domObj){this.domObj.appendChild(C);this.element=C}}this.element.style.visibility="hidden";this.getMap().registerForEvent(Fusion.Event.MAP_BUSY_CHANGED,OpenLayers.Function.bind(this.busyChanged,this))},busyChanged:function(){this.element.style.visibility=this.getMap().isBusy()?"visible":"hidden"}});Fusion.Widget.Buffer=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{layerName:null,layerNameInput:null,bufferDistance:null,bufferDistanceInput:null,bufferUnits:null,bufferUnitsInput:null,borderColor:null,borderColorInput:null,fillColor:null,fillColorInput:null,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=B.extension;this.layerName=A.LayerName?A.LayerName[0]:"";this.layerNameInput=A.LayerNameInput?A.LayerNameInput[0]:null;this.bufferDistance=A.BufferDistance?parseFloat(A.BufferDistance[0]):"";this.bufferDistanceInput=A.BufferDistanceInput?A.BufferDistanceInput[0]:null;this.bufferUnits=Fusion.unitFromName(A.BufferUnits?A.BufferUnits[0]:"meters");this.bufferUnitsInput=A.BufferUnitsInput?A.BufferUnitsInput[0]:null;this.borderColor=A.BorderColor?A.BorderColor[0]:"00000000";this.borderColorInput=A.BorderColorInput?A.BorderColorInput[0]:null;this.fillColor=A.FillColor?A.FillColor[0]:"00000000";this.fillColorInput=A.FillColorInput?A.FillColorInput[0]:null;if(this.layerNameInput){this.layerNameInput=$(this.layerNameInput);this.setValue(this.layerNameInput,this.layerName)}if(this.bufferDistanceInput){this.bufferDistanceInput=$(this.bufferDistanceInput);this.setValue(this.bufferDistanceInput,this.bufferDistance)}if(this.bufferUnitsInput){this.bufferUnitsInput=$(this.bufferUnitsInput);this.setValue(this.bufferUnitsInput,this.bufferUnits)}if(this.borderColorInput){this.borderColorInput=$(this.borderColorInput);this.setValue(this.borderColorInput,this.borderColor)}if(this.fillColorInput){this.fillColorInput=$(this.fillColorInput);this.setValue(this.fillColorInput,this.fillColor)}this.enable=Fusion.Widget.Buffer.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.enable,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.disable,this))},setValue:function(A,C){if(A.tagName.toLowerCase()=="input"){switch(A.type){case"radio":case"checkbox":for(var B=0;B<A.length;B++){if(A[B].value==C){A[B].checked=true}}break;case"file":break;case"button":case"hidden":case"image":case"password":case"reset":case"submit":case"text":A.value=C;break;default:}}if(A.tagName.toLowerCase()=="textarea"){A.value=C}if(A.tagName.toLowerCase()=="select"){for(var B=0;B<A.options.length;B++){if(A.options[B].value==C){A.options[B].selected=true;break}}}},getValue:function(A){if(A.tagName.toLowerCase()=="input"){switch(A.type){case"radio":case"checkbox":return A.value;break;case"file":case"button":case"hidden":case"image":case"password":case"reset":case"submit":case"text":return A.value;break;default:}}if(A.tagName.toLowerCase()=="textarea"){return A.value}if(A.tagName.toLowerCase()=="select"){return A.options[A.selectedIndex].value}},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}else{this.disable()}},execute:function(){if(this.layerNameInput){this.layerName=this.getValue(this.layerNameInput)}var G="&layer="+this.layerName;var I;if(this.bufferDistanceInput){I=this.getValue(this.bufferDistanceInput)}else{I=this.bufferDistance}var C;if(this.bufferUnitsInput){C=this.getValue(this.bufferUnitsInput)}else{C=this.bufferUnits}var A="&distance="+Fusion.toMeter(Fusion.unitFromName(C),I);var E="&bordercolor=";if(this.borderColorInput){E+=this.getValue(this.borderColorInput)}else{E+=this.borderColor}var B="&fillcolor=";if(this.fillColorInput){B+=this.getValue(this.fillColorInput)}else{B+=this.fillColor}var D=this.getMap();var H=D.getAllMaps();var J=H[0].arch+"/"+Fusion.getScriptLanguage()+"/Buffer."+Fusion.getScriptLanguage();var F={};F.parameters="locale="+Fusion.locale+"&merge=1&session="+H[0].getSessionID()+"&mapname="+H[0].getMapName()+G+A+E+B;F.onComplete=OpenLayers.Function.bind(this.bufferCreated,this);Fusion.ajaxRequest(J,F)},bufferCreated:function(){var B=this.getMap().getAllMaps();var A=B[0].getLayerByName(this.layerName);if(A){A.noCache=true}B[0].reloadMap();B[0].drawMap()}});Fusion.Widget.BufferPanel=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{sFeatures:"menubar=no,location=no,resizable=no,status=no",initialize:function(E){Fusion.Widget.prototype.initialize.apply(this,[E,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var D=E.extension;this.sTarget=D.Target?D.Target[0]:"BufferPanelWindow";this.sBaseUrl=Fusion.getFusionURL()+"widgets/BufferPanel/BufferPanel.php";this.bSelectionOnly=(D.DisableIfSelectionEmpty&&(D.DisableIfSelectionEmpty[0]=="true"||D.DisableIfSelectionEmpty[0]=="1"))?true:false;this.additionalParameters=[];if(D.AdditionalParameter){for(var C=0;C<D.AdditionalParameter.length;C++){var F=D.AdditionalParameter[C];var B=F.Key[0];var A=F.Value[0];this.additionalParameters.push(B+"="+encodeURIComponent(A))}}this.enable=Fusion.Widget.BufferPanel.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.enable,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.enable,this));this.disable()},enable:function(){var A=this.getMap();if(this.bSelectionOnly||!A){if(A&&A.hasSelection()){if(this.action){this.action.setEnabled(true)}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}}else{if(this.action){this.action.setEnabled(false)}else{this.disable()}}}else{if(this.action){this.action.setEnabled(true)}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}}},execute:function(){var C=this.sBaseUrl;var E=this.getMap();var B=E.getAllMaps();var D=Fusion.getWidgetById(this.sTarget);var A=$(this.sTarget);var F=[];F.push("locale="+Fusion.locale);F.push("session="+B[0].getSessionID());F.push("mapname="+B[0].getMapName());if(D||A){F.push("popup=false")}else{F.push("popup=true")}F.push("us=0");F=F.concat(this.additionalParameters);if(C.indexOf("?")<0){C+="?"}else{if(C.slice(-1)!="&"){C+="&"}}C+=F.join("&");if(D){D.setContent(C)}else{if(A){A.src=C}else{window.open(C,this.sTarget,this.sWinFeatures)}}}});Fusion.Widget.CenterSelection=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{initialize:function(A){Fusion.Widget.prototype.initialize.apply(this,[A,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);this.enable=Fusion.Widget.CenterSelection.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.enable,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.disable,this))},execute:function(){this.getMap().getSelection(OpenLayers.Function.bind(this.centerSelection,this))},centerSelection:function(N){var B=this.getMap();var M=B.getCurrentExtents();var J=M[2]-M[0];var I=M[3]-M[1];var L=N[B.getMapName()].getLowerLeftCoord();var E=N[B.getMapName()].getUpperRightCoord();var G=E.x-L.x;var A=E.y-L.y;if(G<J&&A<I){var D=(E.x+L.x)/2;var C=(E.y+L.y)/2;B.zoom(D,C,1)}else{var F=0.1;var P=L.x-G*F;var O=L.y-A*F;var K=E.x+G*F;var H=E.y+A*F;B.setExtents(new OpenLayers.Bounds(P,O,K,H))}},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}else{this.disable()}}});Fusion.Widget.ClearSelection=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{initialize:function(A){Fusion.Widget.prototype.initialize.apply(this,[A,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);this.enable=Fusion.Widget.ClearSelection.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.enable,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.disable,this))},execute:function(){this.getMap().clearSelection()},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}else{this.disable()}}});Fusion.Widget.ColorPicker=OpenLayers.Class(Fusion.Widget,{colorInput:null,alpha:100,color:"#000000",colorButton:null,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,false]);var A=B.extension;if(A.ColorInputId){this.colorInput=$(A.ColorInputId[0])}if(this.colorInput){this.alpha=100*parseInt("0x"+this.colorInput.value.substring(0,2))/255;this.color="#"+this.colorInput.value.substring(2);this.colorInput.widget=this}this.colorButton=new Jx.Button.Color({color:this.color,alpha:this.alpha,label:B.label,tooltip:B.tooltip});this.colorButton.addColorChangeListener(this);if(this.domObj){this.domObj.appendChild(this.colorButton.domObj)}},colorChanged:function(B){var A=parseInt(this.colorButton.alpha*255/100).toString(16);var C=A+this.colorButton.color.substring(1);if(this.colorInput){this.colorInput.value=C}}});Fusion.Widget.CursorPosition=OpenLayers.Class(Fusion.Widget,{defaultTemplate:"x: {x}, y: {y}",domSpan:null,units:Fusion.UNKNOWN,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);var A=B.extension;this.emptyText=A.EmptyText?A.EmptyText[0]:this.domObj.innerHTML;this.template=A.Template?A.Template[0]:this.defaultTemplate;this.precision=A.Precision?parseInt(A.Precision[0]):-1;this.units=A.Units?Fusion.unitFromName(A.Units[0]):Fusion.UNKOWN;this.domSpan=document.createElement("span");this.domSpan.className="spanCursorPosition";this.domSpan.innerHTML=this.emptyText;this.domObj.innerHTML="";this.domObj.appendChild(this.domSpan);this.enable=Fusion.Widget.CursorPosition.prototype.enable;this.disable=Fusion.Widget.CursorPosition.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.setUnits,this));this.registerParameter("Units")},enable:function(){this.mouseMoveWatcher=OpenLayers.Function.bind(this.mouseMove,this);this.mouseOutWatcher=OpenLayers.Function.bind(this.mouseOut,this);this.getMap().observeEvent("mousemove",this.mouseMoveWatcher);this.getMap().observeEvent("mouseout",this.mouseOutWatcher)},disable:function(){this.getMap().stopObserveEvent("mousemove",this.mouseMoveWatcher);this.getMap().stopObserveEvent("mouseout",this.mouseOutWatcher)},mouseOut:function(A){this.domSpan.innerHTML=this.emptyText},mouseMove:function(F){var E=this.getMap();var D=E.getEventPosition(F);if(this.units!=Fusion.PIXELS){D=E.pixToGeo(D.x,D.y);if(D){if(this.units!=Fusion.UNKNOWN){var B=E.getMetersPerUnit();D.x=Fusion.fromMeter(this.units,D.x*B);D.y=Fusion.fromMeter(this.units,D.y*B)}if(this.precision>=0){var C=Math.pow(10,this.precision);D.x=Math.round(D.x*C)/C;D.y=Math.round(D.y*C)/C}}}if(D){var A=Fusion.unitAbbr(this.units);this.domSpan.innerHTML=this.template.replace("{x}",D.x).replace("{y}",D.y).replace("{units}",A).replace("{units}",A)}},setUnits:function(){if(this.units==Fusion.UNKNOWN){this.setParameter("Units",this.getMap().getUnits())}},setParameter:function(B,A){if(B=="Units"){this.units=Fusion.unitFromName(A)}}});Fusion.Widget.EditableScale=OpenLayers.Class(Fusion.Widget,{precision:4,initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,false]);var A=C.extension;var B=document.createElement("span");B.className="inputEditableScalePrefix";B.innerHTML="1: ";this.domObj.appendChild(B);this.domScale=document.createElement("input");this.domScale.className="inputEditableScale";this.domObj.appendChild(this.domScale);Event.observe(this.domScale,"keypress",OpenLayers.Function.bindAsEventListener(this.keyPressHandler,this));this.precision=A.Precision?parseInt(A.Precision[0]):this.precision;this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.scaleChanged,this));Fusion.addWidgetStyleSheet(C.location+"/EditableScale/EditableScale.css")},scaleChanged:function(){this.domScale.value=this.scaleToString(this.getMap().oMapOL.getScale())},scaleToString:function(A){A=Math.abs(parseFloat(A));return""+Math.round(A*Math.pow(10,this.precision))/Math.pow(10,this.precision)},keyPressHandler:function(A){if(A.keyCode==Event.KEY_RETURN){this.zoomToScale()}},zoomToScale:function(A){var B=parseFloat(this.domScale.value);if(B){this.getMap().zoomToScale(B)}}});Fusion.Event.HISTORY_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget.ExtentHistory=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{events:[],aHistory:[],sDirection:null,EPS:1e-8,initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var B=C.extension;var A=B.Direction?B.Direction[0].toLowerCase():"previous";if(A!="previous"&&A!="next"){this.sDirection="previous"}else{this.sDirection=A}if(!this.aHistory.history){this.aHistory.history=[];this.aHistory.index=-1;this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.extentsChanged,this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.reset,this))}this.enable=Fusion.Widget.ExtentHistory.prototype.historyChanged;this.disable=Fusion.Widget.ExtentHistory.prototype.historyChanged;this.registerEventID(Fusion.Event.HISTORY_CHANGED);this.registerForEvent(Fusion.Event.HISTORY_CHANGED,OpenLayers.Function.bind(this.historyChanged,this));this.disable()},reset:function(){if(this.getMap().isMapLoaded()){this.aHistory.history=[this.getMap().getCurrentExtents()];this.aHistory.index=0}else{this.aHistory.history=[];this.aHistory.index=-1}this.historyChanged()},extentsChanged:function(){var A=this.getMap().getCurrentExtents();if(this.aHistory.history.length==0){this.aHistory.history.push(A);this.aHistory.index=0}else{var B=this.aHistory.history[this.aHistory.index];if(this.boundsEqual(A,B)){return }if(this.aHistory.index!=(this.aHistory.history.length-1)){this.aHistory.history=this.aHistory.history.slice(0,this.aHistory.index+1)}this.aHistory.history.push(A);this.aHistory.index=this.aHistory.history.length-1}this.triggerEvent(Fusion.Event.HISTORY_CHANGED)},historyChanged:function(){if(this.sDirection=="previous"){if(this.aHistory.index>0){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}else{Fusion.Tool.ButtonBase.prototype.disable.apply(this,[])}}else{if(this.aHistory.index<(this.aHistory.history.length-1)){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}else{Fusion.Tool.ButtonBase.prototype.disable.apply(this,[])}}},execute:function(){if(this.sDirection=="previous"){if(this.aHistory.index>0){this.aHistory.index--;this.getMap().setExtents(this.aHistory.history[this.aHistory.index]);this.triggerEvent(Fusion.Event.HISTORY_CHANGED)}}else{if(this.aHistory.index<(this.aHistory.history.length-1)){this.aHistory.index++;this.getMap().setExtents(this.aHistory.history[this.aHistory.index]);this.triggerEvent(Fusion.Event.HISTORY_CHANGED)}}},boundsEqual:function(B,A){var C=false;var D=100;if(A.top==0){B.top+=D;A.top+=D}if(A.bottom==0){B.bottom+=D;A.bottom+=D}if(A.left==0){B.left+=D;A.left+=D}if(A.right==0){B.right+=D;A.right+=D}C=(Math.abs(B.top-A.top)/A.top<this.EPS&&Math.abs(B.bottom-A.bottom)/A.bottom<this.EPS&&Math.abs(B.left-A.left)/A.left<this.EPS&&Math.abs(B.right-A.right)/A.right<this.EPS);return C}});Fusion.Widget.Help=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{sFeatures:"menubar=no,location=no,resizable=no,status=no",target:"HelpWindow",baseUrl:null,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=B.extension;this.target=A.Target?A.Target[0]:"HelpWindow";this.baseUrl=A.Url?A.Url[0]:Fusion.getFusionURL()+B.location+"/Help/Help.html";if(!B.Disabled||B.Disabled[0].toLowerCase()!="true"){this.enable()}},execute:function(){var B=this.baseUrl;var D=this.getMap();var E=[];E.push("LOCALE="+Fusion.locale);E.push("SESSION="+D.getSessionID());E.push("MAPNAME="+D.getMapName());if(B.indexOf("?")<0){B+="?"}else{if(B.slice(-1)!="&"){B+="&"}}B+=E.join("&");var C=Fusion.getWidgetById(this.target);if(C){C.setContent(B)}else{var A=$(this.target);if(A){A.src=B}else{window.open(B,this.target,this.sWinFeatures)}}}});Fusion.Widget.InitialMapView=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{viewType:"initial",initialize:function(B){var A=B.extension;if(A.ViewType&&(A.ViewType[0]=="full")){this.viewType="full"}Fusion.Widget.prototype.initialize.apply(this,[B,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[])},execute:function(){if(this.viewType=="full"){this.getMap().fullExtents()}else{var A=this.getMap();A.setExtents(A.initialExtents)}}});Fusion.Widget.InvokeScript=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{sScript:null,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=B.extension;this.sScript=A.Script?A.Script[0]:""},execute:function(){eval(this.sScript)}});Fusion.Widget.InvokeURL=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{sFeatures:"menubar=no,location=no,resizable=no,status=no",initialize:function(E){Fusion.Widget.prototype.initialize.apply(this,[E,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var D=E.extension;this.sTarget=D.Target?D.Target[0]:"InvokeUrlWindow";this.sBaseUrl=D.Url[0];this.bSelectionOnly=(D.DisableIfSelectionEmpty&&(D.DisableIfSelectionEmpty[0]=="true"||D.DisableIfSelectionEmpty[0]=="1"))?true:false;this.additionalParameters=[];if(D.AdditionalParameter){for(var C=0;C<D.AdditionalParameter.length;C++){var F=D.AdditionalParameter[C];var B=F.Key[0];var A=F.Value[0];this.additionalParameters.push(B+"="+encodeURIComponent(A))}}this.enable=Fusion.Widget.InvokeURL.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.enable,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.enable,this));this.disable()},enable:function(){var A=this.getMap();if(this.bSelectionOnly||!A){if(A&&A.hasSelection()){if(this.action){this.action.setEnabled(true)}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}}else{if(this.action){this.action.setEnabled(false)}else{this.disable()}}}else{if(this.action){this.action.setEnabled(true)}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}}},execute:function(){var B=this.sBaseUrl;var D=this.getMap();var E=[];E.push("LOCALE="+Fusion.locale);E.push("SESSION="+D.getSessionID());E.push("MAPNAME="+D.getMapName());E=E.concat(this.additionalParameters);if(B.indexOf("?")<0){B+="?"}else{if(B.slice(-1)!="&"){B+="&"}}B+=E.join("&");var C=Fusion.getWidgetById(this.sTarget);if(C){C.setContent(B)}else{var A=$(this.sTarget);if(A){A.src=B}else{window.open(B,this.sTarget,this.sWinFeatures)}}}});Fusion.Widget.LayerManager=OpenLayers.Class(Fusion.Widget,{currentNode:null,bIsDrawn:false,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);var A=B.extension;this.delIconSrc=A.DeleteIcon?A.DeleteIcon[0]:"images/icons/select-delete.png";Fusion.addWidgetStyleSheet(B.location+"LayerManager/LayerManager.css");this.cursorNormal=["url('images/grab.cur'),move","grab","-moz-grab","move"];this.cursorDrag=["url('images/grabbing.cur'),move","grabbing","-moz-grabbing","move"];this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.mapLoaded,this));this.getMap().registerForEvent(Fusion.Event.MAP_RELOADED,OpenLayers.Function.bind(this.mapLoaded,this))},mapLoaded:function(){this.draw()},clear:function(A){while(A.childNodes.length>0){this.clear(A.childNodes[0]);A.remove(A.childNodes[0])}},draw:function(C){if(this.mapList){this.mapList.remove();this.mapList=null}this.mapList=document.createElement("ul");Element.addClassName(this.mapList,"jxLman");this.domObj.appendChild(this.mapList);var F=this.getMap();for(var B=0;B<F.aMaps.length;++B){var E=document.createElement("li");Element.addClassName(this.mapBlock,"jxLmanMap");E.id="mapBlock_"+B;var D=document.createElement("a");D.innerHTML=F.aMaps[B]._sMapTitle;Element.addClassName(D,"jxLmanHandle");E.appendChild(D);this.mapList.appendChild(E);this.processMapBlock(E,F.aMaps[B])}if(F.aMaps.length>1){var A=[];A.onUpdate=OpenLayers.Function.bind(this.updateMapBlock,this,F);A.handle="jxLmanHandle";A.scroll=this.domObj.id;Sortable.create(this.mapList.id,A)}},processMapBlock:function(G,F){var A=document.createElement("ul");Element.addClassName(A,"jxLmanSet");A.id="fusionLayerManager_"+F.getMapName();G.appendChild(A);F.layerPrefix="layer_";var E=F.aLayers;if(F.bLayersReversed){E.reverse()}for(var C=0;C<E.length;++C){var D=document.createElement("li");Element.addClassName(D,"jxLmanLayer");D.id=F.layerPrefix+C;A.appendChild(D);this.createItemHtml(D,E[C]);D.layer=E[C]}var B=[];B.onUpdate=OpenLayers.Function.bind(this.updateLayer,this,F);B.scroll=this.domObj.id;Position.includeScrollOffsets=true;Sortable.create(A.id,B)},createItemHtml:function(D,B){var E=document.createElement("img");E.src=this.delIconSrc;Event.observe(E,"click",OpenLayers.Function.bind(this.deleteLayer,this,B));E.style.visibility="hidden";D.appendChild(E);var C=document.createElement("input");C.type="checkbox";Event.observe(C,"click",OpenLayers.Function.bind(this.visChanged,this,B));D.appendChild(C);if(B.visible){C.checked=true}else{C.checked=false}var A=document.createElement("a");A.innerHTML=B.legendLabel;Event.observe(A,"mouseover",OpenLayers.Function.bind(this.setGrabCursor,this));Event.observe(A,"mousedown",OpenLayers.Function.bind(this.setDragCursor,this));Event.observe(A,"mouseout",OpenLayers.Function.bind(this.setNormalCursor,this));D.appendChild(A);Event.observe(D,"mouseover",OpenLayers.Function.bind(this.setHandleVis,this,E));Event.observe(D,"mouseout",OpenLayers.Function.bind(this.setHandleHide,this,E))},setHandleVis:function(A){A.style.visibility="visible"},setHandleHide:function(A){A.style.visibility="hidden"},setGrabCursor:function(A){this.setCursor(this.cursorNormal,Event.element(A))},setDragCursor:function(A){this.setCursor(this.cursorDrag,Event.element(A))},setNormalCursor:function(A){this.setCursor("auto",Event.element(A))},setCursor:function(C,A){this.cursor=C;if(C&&C.length&&typeof C=="object"){for(var B=0;B<C.length;B++){A.style.cursor=C[B];if(A.style.cursor==C[B]){break}}}else{if(typeof C=="string"){A.style.cursor=C}else{A.style.cursor="auto"}}},updateLayer:function(G,D){var C=[];var F=[];var H=D.childNodes.length;for(var B=0;B<H;++B){F[B]=D.childNodes[B].id.split("_");var A=parseInt(F[B].pop());if(G.bLayersReversed){A=H-(A+1)}C.push(A);D.childNodes[B].id=""}for(var B=0;B<D.childNodes.length;++B){var E=D.childNodes[B];F[B].push(B);E.id=F[B].join("_");E.childNodes[1].checked=E.layer.isVisible()}if(G.bLayersReversed){C.reverse()}G.reorderLayers(C)},updateMapBlock:function(B,A){},deleteLayer:function(C,D){var A=Event.element(D).parentNode;var B=A.parentNode;Element.remove(A.id);this.updateLayer(C.oMap,B)},visChanged:function(C,B){var D=Event.element(B);var A=D.parentNode.layer;if(D.checked){A.show()}else{A.hide()}}});Fusion.Widget.Legend=OpenLayers.Class(Fusion.Widget,{defaultLayerDWFIcon:"images/icons/legend-DWF.png",defaultLayerRasterIcon:"images/icons/legend-raster.png",defaultLayerThemeIcon:"images/icons/legend-theme.png",defaultDisabledLayerIcon:"images/icons/legend-layer.png",defaultRootFolderIcon:"images/icons/legend-map.png",defaultLayerInfoIcon:"images/icons/tree_layer_info.png",defaultGroupInfoIcon:"images/icons/tree_group_info.png",initialize:function(widgetTag){Fusion.Widget.prototype.initialize.apply(this,[widgetTag,true]);var json=widgetTag.extension;if(json.LegendRenderer){var renderer=eval(json.LegendRenderer[0]);if(renderer&&renderer.prototype.CLASS_NAME&&renderer.prototype.CLASS_NAME=="Fusion.Widget.Legend.LegendRenderer"){this.renderer=new renderer(this,widgetTag)}else{if(typeof renderer=="function"){var renderFunction=renderer;this.renderer=new Fusion.Widget.Legend.LegendRenderer(this);this.renderer.mapLoaded=renderFunction;this.renderer.mapReloaded=renderFunction;this.renderer.mapLoading=false}else{this.renderer=new Fusion.Widget.Legend.LegendRendererDefault(this,widgetTag)}}}else{this.renderer=new Fusion.Widget.Legend.LegendRendererDefault(this,widgetTag)}if(this.renderer.mapReloaded){this.getMap().registerForEvent(Fusion.Event.MAP_RELOADED,OpenLayers.Function.bind(this.renderer.mapReloaded,this.renderer))}if(this.renderer.mapLoading){this.getMap().registerForEvent(Fusion.Event.MAP_LOADING,OpenLayers.Function.bind(this.renderer.mapLoading,this.renderer))}if(this.renderer.mapLoaded){this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.renderer.mapLoaded,this.renderer))}}});Fusion.Widget.Legend.LegendRenderer=OpenLayers.Class({oLegend:null,layerRoot:null,initialize:function(A){this.oLegend=A;this.layerRoot=this.getMap().layerRoot},renderLegend:function(){},mapLoading:function(){},mapLoaded:function(){},mapReloaded:function(){},getMap:function(){return this.oLegend.getMap()},CLASS_NAME:"Fusion.Widget.Legend.LegendRenderer"});Fusion.Widget.Legend.LegendRendererDefault=OpenLayers.Class(Fusion.Widget.Legend.LegendRenderer,{showRootFolder:false,currentNode:null,bIsDrawn:false,targetFolder:null,bIncludeVisToggle:true,initialize:function(C,D){Fusion.Widget.Legend.LegendRenderer.prototype.initialize.apply(this,[C]);var B=D.extension;this.imgLayerDWFIcon=B.LayerDWFIcon?B.LayerDWFIcon[0]:this.oLegend.defaultLayerDWFIcon;this.imgLayerRasterIcon=B.LayerRasterIcon?B.LayerRasterIcon[0]:this.oLegend.defaultLayerRasterIcon;this.imgLayerThemeIcon=B.LayerThemeIcon?B.LayerThemeIcon[0]:this.oLegend.defaultLayerThemeIcon;this.imgDisabledLayerIcon=B.DisabledLayerIcon?B.DisabledLayerIcon[0]:this.oLegend.defaultDisabledLayerIcon;this.imgLayerInfoIcon=B.LayerInfoIcon?B.LayerInfoIcon[0]:this.oLegend.defaultLayerInfoIcon;this.imgGroupInfoIcon=B.GroupInfoIcon?B.GroupInfoIcon[0]:this.oLegend.defaultGroupInfoIcon;this.selectedLayer=null;this.oTree=new Jx.Tree(this.oLegend.domObj);this.hideInvisibleLayers=(B.HideInvisibleLayers&&B.HideInvisibleLayers[0])=="true"?true:false;this.refreshAction=new Jx.Action(OpenLayers.Function.bind(this.update,this));this.refreshItem=new Jx.MenuItem(this.refreshAction,{label:OpenLayers.i18n("refresh")});this.expandAllAction=new Jx.Action(OpenLayers.Function.bind(this.expandAll,this));this.expandAllItem=new Jx.MenuItem(this.expandAllAction,{label:OpenLayers.i18n("expandAll")});this.expandBranchAction=new Jx.Action(OpenLayers.Function.bind(this.expandBranch,this));this.expandBranchItem=new Jx.MenuItem(this.expandBranchAction,{label:OpenLayers.i18n("expand")});this.collapseAllAction=new Jx.Action(OpenLayers.Function.bind(this.collapseAll,this));this.collapseAllItem=new Jx.MenuItem(this.collapseAllAction,{label:OpenLayers.i18n("collapseAll")});this.collapseBranchAction=new Jx.Action(OpenLayers.Function.bind(this.collapseBranch,this));this.collapseBranchItem=new Jx.MenuItem(this.collapseBranchAction,{label:OpenLayers.i18n("collapse")});this.contextMenu=new Jx.ContextMenu(this.sName);this.contextMenu.add(this.collapseBranchItem,this.expandBranchItem,this.refreshItem,this.expandAllItem,this.collapseAllItem);this.showRootFolder=(B.ShowRootFolder&&B.ShowRootFolder[0]=="false")?false:true;this.showMapFolder=(B.ShowMapFolder&&B.ShowMapFolder[0]=="false")?false:true;if(this.showRootFolder){var A={};A.label=OpenLayers.i18n("defaultMapTitle");A.data=null;A.imgTreeFolder=B.RootFolderIcon?B.RootFolderIcon[0]:this.defRootFolderIcon;A.imgTreeFolderOpen=A.imgTreeFolder;A.isOpen=true;A.contextMenu=this.contextMenu;this.oRoot=new Jx.TreeFolder(A);this.oTree.append(this.oRoot);Event.observe(this.oRoot.domObj,"mouseover",OpenLayers.Function.bind(this.setFolder,this))}else{this.oRoot=this.oTree}this.extentsChangedWatcher=this.update.bind(this)},expandAll:function(){this.recurseTree("expand",this.oRoot)},collapseAll:function(){this.recurseTree("collapse",this.oRoot)},collapseBranch:function(){if(this.targetFolder&&this.targetFolder instanceof Jx.TreeFolder){this.targetFolder.collapse()}},expandBranch:function(){if(this.targetFolder&&this.targetFolder instanceof Jx.TreeFolder){this.targetFolder.expand()}},recurseTree:function(D,C){for(var A=0;A<C.nodes.length;A++){var B=C.nodes[A];if(B instanceof Jx.TreeFolder){this.recurseTree(D,B);B[D]()}}},setFolder:function(A){var B=Event.element(A);this.targetFolder=B.jxTreeItem},mapLoading:function(){this.getMap().deregisterForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.extentsChangedWatcher);this.clear()},mapLoaded:function(){this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.extentsChangedWatcher);this.layerRoot=this.getMap().layerRoot;this.renderLegend()},mapReloaded:function(){this.renderLegend()},invalidate:function(){this.draw()},renderLegend:function(C){this.bIsDrawn=false;this.clear();if(this.showRootFolder){this.oRoot.setName(this.getMap().getMapTitle())}var A=this.layerRoot;if(!this.showMapFolder){A=this.layerRoot.groups[0]}if(!A.legend){A.legend={};A.legend.treeItem=this.oRoot}for(var B=0;B<A.groups.length;B++){A.groups[B].visible=true;this.processMapGroup(A.groups[B],this.oRoot)}for(var B=0;B<A.layers.length;B++){this.processMapLayer(A.layers[B],this.oRoot)}this.bIsDrawn=true;this.update()},processMapGroup:function(G,F){if(G.displayInLegend){G.legend={};var E={};E.label=G.legendLabel;E.data=G;E.contextMenu=this.contextMenu;E.isOpen=G.expandInLegend;G.legend.treeItem=new Jx.TreeFolder(E);F.append(G.legend.treeItem);G.legend.checkBox=document.createElement("input");G.legend.checkBox.type="checkbox";G.legend.treeItem.domObj.insertBefore(G.legend.checkBox,G.legend.treeItem.domObj.childNodes[1]);G.legend.checkBox.checked=G.visible?true:false;Event.observe(G.legend.checkBox,"click",OpenLayers.Function.bind(this.stateChanged,this,G));Event.observe(G.legend.treeItem.domObj,"mouseover",OpenLayers.Function.bind(this.setFolder,this));var D=G.oMap.getGroupInfoUrl(G.groupName);if(D){var A=document.createElement("a");A.href=D;if(D.indexOf("javascript:")<0){A.target="_blank"}var B=document.createElement("img");Jx.addToImgQueue({domElement:B,src:this.imgGroupInfoIcon});B.border=0;A.appendChild(B);G.legend.treeItem.domObj.insertBefore(A,G.legend.treeItem.domObj.childNodes[4])}if(this.oSelectionListener){G.legend.treeItem.addSelectionListener(this)}for(var C=0;C<G.groups.length;C++){this.processMapGroup(G.groups[C],G.legend.treeItem)}for(var C=0;C<G.layers.length;C++){this.processMapLayer(G.layers[C],G.legend.treeItem)}}},processMapLayer:function(A,B){A.legend={};A.legend.parentItem=B;A.legend.checkBox=document.createElement("input");A.legend.checkBox.type="checkbox";Event.observe(A.legend.checkBox,"click",OpenLayers.Function.bind(this.stateChanged,this,A));A.legend.currentRange=null;A.registerForEvent(Fusion.Event.LAYER_PROPERTY_CHANGED,OpenLayers.Function.bind(this.layerPropertyChanged,this))},layerPropertyChanged:function(B,A){A.legend.checkBox.checked=A.isVisible()},update:function(){if(this.bIsDrawn){window.setTimeout(OpenLayers.Function.bind(this._update,this),1)}},_update:function(){var C=this.getMap();var B=C.getScale();for(var A=0;A<C.layerRoot.groups.length;A++){this.updateGroupLayers(C.layerRoot.groups[A],B)}for(var A=0;A<C.layerRoot.layers.length;A++){this.updateLayer(C.layerRoot.layers[A],B)}},clear:function(){while(this.oRoot.nodes.length>0){this.oRoot.remove(this.oRoot.nodes[0])}},selectionChanged:function(A){if(this.currentNode){Element.removeClassName(this.currentNode.domObj.childNodes[3],"jxTreeSelectedNode")}this.currentNode=A;Element.addClassName(this.currentNode.domObj.childNodes[3],"jxTreeSelectedNode");if(A.data instanceof Fusion.Widget.Map.Group){this.getMap().setActiveLayer(null)}else{this.getMap().setActiveLayer(A.data)}},updateGroupLayers:function(C,A){for(var B=0;B<C.groups.length;B++){this.updateGroupLayers(C.groups[B],A)}for(var B=0;B<C.layers.length;B++){this.updateLayer(C.layers[B],A)}},updateLayer:function(E,C){if(!E.displayInLegend){return }var B=E.getScaleRange(C);if(B==E.legend.currentRange&&E.legend.treeItem){return }E.legend.currentRange=B;if(B!=null){if(B.styles.length>0){E.legend.checkBox.disabled=false}else{E.legend.checkBox.disabled=true}if(B.styles.length>1){if(!E.legend.treeItem){E.legend.treeItem=this.createFolderItem(E);E.parentGroup.legend.treeItem.append(E.legend.treeItem)}else{if(E.legend.treeItem instanceof Jx.TreeItem){this.clearTreeItem(E);E.legend.treeItem=this.createFolderItem(E);E.parentGroup.legend.treeItem.append(E.legend.treeItem)}else{while(E.legend.treeItem.nodes.length>0){E.legend.treeItem.remove(E.legend.treeItem.nodes[0])}}}for(var D=0;D<B.styles.length;D++){var G=this.createTreeItem(E,B.styles[D],C,false);E.legend.treeItem.append(G)}}else{var F=B.styles[0];if(!E.legend.treeItem){E.legend.treeItem=this.createTreeItem(E,F,C,this.bIncludeVisToggle);E.parentGroup.legend.treeItem.append(E.legend.treeItem)}else{if(E.legend.treeItem instanceof Jx.TreeFolder){this.clearTreeItem(E);E.legend.treeItem=this.createTreeItem(E,F,C,this.bIncludeVisToggle);E.parentGroup.legend.treeItem.append(E.legend.treeItem)}else{if(B.styles.length>0){Jx.addToImgQueue({domElement:E.legend.treeItem.domObj.childNodes[2],src:B.styles[0].getLegendImageURL(C,E,this.getMap())});Element.removeClassName(E.legend.treeItem.domObj,"jxDisabled")}else{Element.addClassName(E.legend.treeItem.domObj,"jxDisabled")}}}}}else{if(this.hideInvisibleLayers){if(E.legend.treeItem){E.parentGroup.legend.treeItem.remove(E.legend.treeItem);E.legend.treeItem=null}}else{E.legend.checkBox.disabled=true;var A=this.createTreeItem(E,null,null,this.bIncludeVisToggle);if(E.legend.treeItem){E.parentGroup.legend.treeItem.replace(A,E.legend.treeItem);E.legend.treeItem.finalize()}else{E.parentGroup.legend.treeItem.append(A)}E.legend.treeItem=A}}E.legend.checkBox.checked=E.visible?true:false},createFolderItem:function(D){var C={};C.label=D.legendLabel==""?"&nbsp;":D.legendLabel;C.data=D;C.isOpen=D.expandInLegend;C.contextMenu=this.contextMenu;C.imgTreeFolderOpen=this.imgLayerThemeIcon;C.imgTreeFolder=this.imgLayerThemeIcon;var E=new Jx.TreeFolder(C);E.domObj.insertBefore(D.legend.checkBox,E.domObj.childNodes[1]);var F=D.oMap.getLayerInfoUrl(D.layerName);if(F){var A=document.createElement("a");A.href=F;if(F.indexOf("javascript:")<0){A.target="_blank"}var B=document.createElement("img");Jx.addToImgQueue({domElement:B,src:this.imgLayerInfoIcon});B.border=0;A.appendChild(B);E.domObj.insertBefore(A,E.domObj.childNodes[4])}E.addSelectionListener(this);Event.observe(E.domObj,"mouseover",OpenLayers.Function.bind(this.setFolder,this));return E},createTreeItem:function(E,A,C,H){var B={};if(H){B.label=E.legendLabel==""?"&nbsp;":E.legendLabel}else{B.label=A.legendLabel==""?"&nbsp;":A.legendLabel}B.data=E;B.contextMenu=this.contextMenu;if(!A){B.imgIcon=this.imgDisabledLayerIcon;B.enabled=false}else{if(A.staticIcon){if(A.staticIcon==Fusion.Constant.LAYER_DWF_TYPE){B.imgIcon=this.imgLayerDWFIcon}else{B.imgIcon=this.imgLayerRasterIcon}}else{B.imgIcon=A.getLegendImageURL(C,E)}}var I=new Jx.TreeItem(B);if(H){I.domObj.insertBefore(E.legend.checkBox,I.domObj.childNodes[1]);var F=E.oMap.getLayerInfoUrl(E.layerName);if(F){var G=document.createElement("a");G.href=F;if(F.indexOf("javascript:")<0){G.target="_blank"}var D=document.createElement("img");Jx.addToImgQueue({domElement:D,src:this.imgLayerInfoIcon});D.border=0;G.appendChild(D);I.domObj.insertBefore(G,I.domObj.childNodes[4])}}I.addSelectionListener(this);return I},clearTreeItem:function(A){if(A.legend.treeItem&&A.legend.treeItem.parent){A.legend.treeItem.parent.remove(A.legend.treeItem);A.legend.treeItem.finalize();A.legend.treeItem=null}},stateChanged:function(A){if(A.legend&&A.legend.checkBox){if(A.legend.checkBox.checked){A.show()}else{A.hide()}}}});Fusion.Widget.LinkToView=OpenLayers.Class(Fusion.Widget,{initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,false]);var A=C.extension;this.baseUrl=window.location.protocol+"//"+window.location.host+window.location.pathname+"?";var B=Fusion.parseQueryString();var D="";for(var E in B){if(typeof B[E]=="function"){continue}if(E=="extent"){continue}this.baseUrl+=D+E+"="+B[E];D="&"}this.anchorLabel=A.Label?A.Label[0]:(this.domObj.innerHTML?this.domObj.innerHTML:"Link to View");this.anchor=document.createElement("a");this.anchor.className="anchorLinkToView";this.anchor.href=this.baseUrl;this.anchor.innerHTML=this.anchorLabel;this.anchor.title=A.Tooltip?A.Tooltip[0]:"Right-click to copy or bookmark link to current view";this.domObj.innerHTML="";this.domObj.appendChild(this.anchor);this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.updateLink,this));this.enable()},updateLink:function(){var A=this.getMap().getCurrentExtents().toBBOX();var B=(this.baseUrl.indexOf("?")==this.baseUrl.length-1)?"":"&";this.anchor.href=this.baseUrl+B+"extent="+A}});Fusion.Widget.MapMenu=OpenLayers.Class(Fusion.Widget,Fusion.Tool.MenuBase,{domObj:null,oMenu:null,mapGroupData:null,sRootFolder:"",aMenus:null,initialize:function(F){Fusion.Widget.prototype.initialize.apply(this,[F,false]);Fusion.Tool.MenuBase.prototype.initialize.apply(this,[]);this.enable();var J=F.extension;var I=Fusion.applicationDefinition.mapGroups;this.mapGroupData={};for(var H=0;H<I.length;H++){var C=I[H];if(J.Folder){this.mapGroupData[C.maps[0].resourceId]=C}else{var B={};B.label=C.mapId;var G=C;var E=new Jx.Action(this.switchMap.bind(this,G));var A=new Jx.MenuItem(E,B);this.oMenu.add(A)}}this.arch=this.getMap().getAllMaps()[0].arch;if(this.arch=="MapGuide"&&J.Folder){this.sRootFolder=J.Folder?J.Folder[0]:"Library://";var K=this.arch+"/"+Fusion.getScriptLanguage()+"/MapMenu."+Fusion.getScriptLanguage();var D={parameters:{folder:this.sRootFolder},onComplete:OpenLayers.Function.bind(this.processMapMenu,this)};Fusion.ajaxRequest(K,D)}},processMapMenu:function(B){if(B.responseXML){this.aMenus={};var D=new DomNode(B.responseXML);var I=D.findFirstNode("MapDefinition");while(I){var E=I.getNodeText("ResourceId");var G=E.replace(this.sRootFolder,"");if(G.lastIndexOf("/")>-1){G=G.slice(0,G.lastIndexOf("/"));this.createFolders(G)}else{G=""}var C={};C.label=I.getNodeText("Name");var H=null;if(this.mapGroupData[I.getNodeText("ResourceId")]){H=this.mapGroupData[I.getNodeText("ResourceId")]}else{H={maps:[{resourceId:I.getNodeText("ResourceId"),singleTile:true,type:this.arch,extension:{ResourceId:[I.getNodeText("ResourceId")]}}]};H.getInitialView=function(){return this.initialView}}var F=new Jx.Action(this.switchMap.bind(this,H));var A=new Jx.MenuItem(F,C);if(G==""){this.oMenu.add(A)}else{this.aMenus[G].add(A)}I=D.findNextNode("MapDefinition")}}},createFolders:function(A){var D=A.split("/");var G="";var E="";for(var C=0;C<D.length;C++){if(!this.aMenus[G+E+D[C]]){var B={label:D[C]};var F=new Jx.SubMenu(B);if(G==""){this.oMenu.add(F)}else{this.aMenus[G].add(F)}this.aMenus[G+E+D[C]]=F}G=G+E+D[C];E="/"}},activateTool:function(){this.oMenu.show()},switchMap:function(A){var B=this.getMap().getCurrentExtents();A.initialView={minX:B.left,minY:B.bottom,maxX:B.right,maxY:B.top};this.getMap().loadMapGroup(A)}});Fusion.Widget.Maptip=OpenLayers.Class(Fusion.Widget,{oCurrentPosition:null,oMapTipPosition:null,nTimer:null,delay:null,aLayers:null,bOverTip:false,sWinFeatures:"menubar=no,location=no,resizable=no,status=no",offset:new OpenLayers.Pixel(2,2),initialize:function(D){Fusion.Widget.prototype.initialize.apply(this,[D,true]);var B=D.extension;this.sTarget=B.Target?B.Target[0]:"MaptipWindow";if(B.WinFeatures){this.sWinFeatures=B.WinFeatures[0]}this.delay=B.Delay?parseInt(B.Delay[0]):350;this.nTolerance=B.Tolerance?parseInt(B.Tolerance[0]):2;this.aLayers=[];if(B.Layer){for(var A=0;A<B.Layer.length;A++){this.aLayers.push(B.Layer[A])}}Fusion.addWidgetStyleSheet(D.location+"Maptip/Maptip.css");if(this.domObj){this.domObj.parentNode.removeChild(this.domObj)}else{this.domObj=document.createElement("div")}this.domObj.className="maptipContainer";this.domObj.style.display="none";this.domObj.style.top="0px";this.domObj.style.left="0px";this.iframe=document.createElement("iframe");this.iframe.className="maptipShim";this.iframe.scrolling="no";this.iframe.frameborder=0;Event.observe(this.domObj,"mouseover",OpenLayers.Function.bind(this.mouseOverTip,this));Event.observe(this.domObj,"mouseout",OpenLayers.Function.bind(this.mouseOutTip,this));var C=this.getMap().getDomObj();document.getElementsByTagName("BODY")[0].appendChild(this.domObj);this.getMap().observeEvent("mousemove",OpenLayers.Function.bind(this.mouseMove,this));this.getMap().observeEvent("mouseout",OpenLayers.Function.bind(this.mouseOut,this))},mouseOut:function(A){if(this.nTimer){window.clearTimeout(this.nTimer);if(!this.nHideTimer){this.nHideTimer=window.setTimeout(OpenLayers.Function.bind(this.hideMaptip,this),250)}}},mouseMove:function(B){if(this.bOverTip){return }var A=this.getMap().getEventPosition(B);this.oCurrentPosition=A;this.oMapTipPosition={x:Event.pointerX(B),y:Event.pointerY(B)};if(this.oCurrentPosition){window.clearTimeout(this.nTimer);this.nTimer=null}this.nTimer=window.setTimeout(OpenLayers.Function.bind(this.showMaptip,this),this.delay)},showMaptip:function(A){var B=this.getMap();if(B==null){return }var H=Fusion.oBroker;var M=this.oCurrentPosition.x;var K=this.oCurrentPosition.y;var E=B.pixToGeo(M-this.nTolerance,K-this.nTolerance);var L=B.pixToGeo(M+this.nTolerance,K+this.nTolerance);if(!E){return }var F="POLYGON(("+E.x+" "+E.y+", "+E.x+" "+L.y+", "+L.x+" "+L.y+", "+L.x+" "+E.y+", "+E.x+" "+E.y+"))";var C=1;var G=0;var N="INTERSECTS";var D=5;var I=this.getMap().getAllMaps();var J=this.aLayers.toString();var A=new Fusion.Lib.MGRequest.MGQueryMapFeatures(I[0].getSessionID(),I[0]._sMapname,F,C,G,N,J,D);H.dispatchRequest(A,OpenLayers.Function.bind(Fusion.xml2json,this,OpenLayers.Function.bind(this.requestCB,this)))},requestCB:function(xhr){var o;eval("o="+xhr.responseText);this._display(o);if(this.nHideTimer){window.clearTimeout(this.nHideTimer);this.nHideTimer=null}},_display:function(K){this.domObj.innerHTML="&nbsp;";var C=document.createElement("div");C.className="maptipContent";this.domObj.appendChild(C);var F=true;this.bIsVisible=true;var I=K.FeatureInformation["Tooltip"];if(I){C.innerHTML=I[0].replace(/\n/g,"<br>");F=false}var D=K.FeatureInformation["Hyperlink"];if(D){var H,A;var G=document.createElement("div");if(D[0].indexOf("href=")>0){G.innerHTML=D[0];H=G.firstChild;A=H.href}else{H=document.createElement("a");H.innerHTML=D[0];A=D[0];G.appendChild(H)}H.href="javascript:void(0)";var B=OpenLayers.Function.bind(this.openLink,this,A);H.onclick=OpenLayers.Function.bindAsEventListener(B,this);C.appendChild(G);F=false}if(!F){var E=this.getMap().getSize();var J=Element.getDimensions(this.domObj);if(this.oCurrentPosition.x<E.w/2){this.domObj.style.left=(this.oMapTipPosition.x+this.offset.x)+"px"}else{this.domObj.style.left=(this.oMapTipPosition.x-(J.width+this.offset.x))+"px"}if(this.oCurrentPosition.y<E.h/2){this.domObj.style.top=(this.oMapTipPosition.y+this.offset.y)+"px"}else{this.domObj.style.top=(this.oMapTipPosition.y-(J.height+this.offset.y))+"px"}this.domObj.style.visibility="hidden";this.domObj.style.display="block";if(!window.opera){C.appendChild(this.iframe);var J=Element.getContentBoxSize(this.domObj);this.iframe.style.width=J.width+"px";this.iframe.style.height=J.height+"px"}this.domObj.style.visibility="visible"}else{this.hideMaptip()}},hideMaptip:function(){this.bIsVisible=false;this.hideTimer=window.setTimeout(OpenLayers.Function.bind(this._hide,this),10)},_hide:function(){this.hideTimer=null;this.domObj.style.display="none"},mouseOverTip:function(){window.clearTimeout(this.nHideTimer);this.nHideTimer=null;this.bOverTip=true},mouseOutTip:function(){this.nHideTimer=window.setTimeout(OpenLayers.Function.bind(this.hideMaptip,this),250);this.bOverTip=false},openLink:function(C,A){var D=Fusion.getWidgetById(this.sTarget);if(D){D.setContent(C)}else{var B=$(this.sTarget);if(B){B.src=C}else{window.open(C,this.sTarget,this.sWinFeatures)}}OpenLayers.Event.stop(A,true);return false}});Fusion.Constant.MEASURE_TYPE_DISTANCE=0;Fusion.Constant.MEASURE_TYPE_AREA=1;Fusion.Constant.MEASURE_TYPE_BOTH=2;Fusion.Event.MEASURE_SEGMENT_UPDATE=Fusion.Event.lastEventId++;Fusion.Event.MEASURE_CLEAR=Fusion.Event.lastEventId++;Fusion.Event.MEASURE_COMPLETE=Fusion.Event.lastEventId++;Fusion.Widget.Measure=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,Fusion.Tool.Canvas,{isDigitizing:false,distances:null,distanceMarkers:null,aAreaFirstPoint:null,cumulativeDistance:0,lastDistance:0,cumulativeArea:0,lastArea:0,units:Fusion.UNKNOWN,mType:null,distPrecision:4,areaPrecision:4,distanceNormalStyle:null,fillStyle:null,areaStyle:null,initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);Fusion.Tool.Canvas.prototype.initialize.apply(this,[]);this.asCursor=["crosshair"];var B=C.extension;this.units=(B.Units&&(B.Units[0]!=""))?Fusion.unitFromName(B.Units[0]):this.units;this.distPrecision=B.DistancePrecision?parseInt(B.DistancePrecision[0]):4;this.areaPrecision=B.AreaPrecision?parseInt(B.AreaPrecision[0]):4;this.sTarget=B.Target?B.Target[0]:"";this.sBaseUrl=Fusion.getFusionURL()+"widgets/Measure/Measure.php";this.measureType=Fusion.Constant.MEASURE_TYPE_BOTH;if(B.Type){switch(B.Type[0].toLowerCase()){case"distance":this.measureType=Fusion.Constant.MEASURE_TYPE_DISTANCE;break;case"area":this.measureType=Fusion.Constant.MEASURE_TYPE_AREA;break}}this.measureType=Fusion.Constant.MEASURE_TYPE_DISTANCE;var A=B.FillStyle?B.FillStyle[0]:"rgba(0,0,255, 0.3)";var E=B.LineStyleWidth?B.LineStyleWidth[0]:2;var D=B.LineStyleColor?B.LineStyleColor[0]:"rgba(0,0,255,0.3)";this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:A});this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:E,strokeStyle:D});this.distanceMarkers=[];this.distances=[];this.registerEventID(Fusion.Event.MEASURE_SEGMENT_UPDATE);this.registerEventID(Fusion.Event.MEASURE_CLEAR);this.registerEventID(Fusion.Event.MEASURE_COMPLETE);this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.resetCanvas,this));this.keyHandler=OpenLayers.Function.bind(this.onKeyPress,this);Fusion.addWidgetStyleSheet(C.location+"Measure/Measure.css");this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.setUnits,this,this.units));this.registerParameter("Units")},onKeyPress:function(B){var A=(B.charCode)?B.charCode:((B.keyCode)?B.keyCode:B.which);if(A==Event.KEY_ESC){this.resetCanvas()}},activateTool:function(){this.getMap().activateWidget(this);this._oButton.activateTool()},initVars:function(){this.cumulativeDistance=0;this.lastDistance=0;this.cumulativeArea=0;this.lastArea=0;this.aAreaFirstPoint=null},activate:function(){this.activateCanvas();this.initVars();this.triggerEvent(Fusion.Event.MEASURE_CLEAR,this);Event.observe(document,"keypress",this.keyHandler);this.loadDisplayPanel()},loadDisplayPanel:function(){if(this.sTarget){var A=this.sBaseUrl;var E="locale="+Fusion.locale;if(A.indexOf("?")<0){A+="?"}else{if(A.slice(-1)!="&"){A+="&"}}A+=E;var D=Fusion.getWidgetById(this.sTarget);var C=window;if(D){D.setContent(A);C=D.iframe.contentWindow}else{C=window.open(A,this.sTarget,this.sWinFeatures)}this.registerForEvent(Fusion.Event.MEASURE_CLEAR,OpenLayers.Function.bind(this.clearDisplay,this,C));this.registerForEvent(Fusion.Event.MEASURE_SEGMENT_UPDATE,OpenLayers.Function.bind(this.updateDisplay,this,C));this.registerForEvent(Fusion.Event.MEASURE_COMPLETE,OpenLayers.Function.bind(this.updateDisplay,this,C))}else{this.totalDistanceMarker=new Fusion.Widget.Measure.DistanceMarker(this.units,this.distPrecision,"Total:");var B=this.getMap().getDomObj();if(!this.totalDistanceMarker.domObj.parentNode||this.totalDistanceMarker.domObj.parentNode!=B){B.appendChild(this.totalDistanceMarker.domObj)}Element.addClassName(this.totalDistanceMarker.domObj,"divMeasureTotal");this.totalDistanceMarker.domObj.style.display="none";this.registerForEvent(Fusion.Event.MEASURE_CLEAR,OpenLayers.Function.bind(this.clearTotalDistance,this));this.registerForEvent(Fusion.Event.MEASURE_SEGMENT_UPDATE,OpenLayers.Function.bind(this.updateTotalDistance,this));this.registerForEvent(Fusion.Event.MEASURE_COMPLETE,OpenLayers.Function.bind(this.updateTotalDistance,this))}},deactivate:function(){Event.stopObserving(document,"keypress",this.keyHandler);this._oButton.deactivateTool();this.deactivateCanvas();this.resetCanvas()},resetCanvas:function(){if(this.isDigitizing){this.isDigitizing=false}this.clearContext();this.initVars();for(var A=0;A<this.distanceMarkers.length;A++){this.distanceMarkers[A].destroy()}this.distanceMarkers=[];this.triggerEvent(Fusion.Event.MEASURE_CLEAR,this)},mouseDown:function(E){if(Event.isLeftClick(E)){var D=this.getMap();var C=D.getEventPosition(E);var B=D.pixToGeo(C.x,C.y);if(!this.isDigitizing){this.resetCanvas();var G=new Fusion.Tool.Canvas.Node(B.x,B.y,D);var F=new Fusion.Tool.Canvas.Node(B.x,B.y,D);var A=new Fusion.Tool.Canvas.Segment(G,F);if(this.measureType==Fusion.Constant.MEASURE_TYPE_DISTANCE){this.feature=new Fusion.Tool.Canvas.Line(D);this.feature.lineStyle=this.lineStyle}else{this.feature=new Fusion.Tool.Canvas.Polygon(D);this.feature.fillStyle=this.fillStyle;this.feature.lineStyle=this.lineStyle}this.feature.addSegment(A);this.aAreaFirstPoint=new Fusion.Tool.Canvas.Node(B.x,B.y,D);this.isDigitizing=true}else{var A=this.feature.lastSegment();A.to.set(B.x,B.y);if(A.from.x==A.to.x&&A.from.y==A.to.y){this.dblClick(E);return }this.feature.extendLine();this.updateMarker(this.lastMarker,A,E)}this.lastMarker=new Fusion.Widget.Measure.DistanceMarker(this.units,this.distPrecision);this.distanceMarkers.push(this.lastMarker);this.clearContext();this.feature.draw(this.context)}},mouseMove:function(G){if(!this.isDigitizing){return }var H={x:0,y:0};var C=this.getMap().getDomObj();if(this.delayUpdateTimer){window.clearTimeout(this.delayUpdateTimer)}var F=this.getMap();var E=F.getEventPosition(G);var D=F.pixToGeo(E.x,E.y);var A=this.feature.lastSegment();A.to.set(D.x,D.y);this.clearContext();this.feature.draw(this.context);this.lastMarker.setCalculating();this.delayUpdateTimer=window.setTimeout(OpenLayers.Function.bind(this.delayUpdate,this,A,G),100);this.positionMarker(this.lastMarker,A);if(this.totalDistanceMarker){var B=this.totalDistanceMarker.getSize();this.totalDistanceMarker.domObj.style.top=(E.y-B.height)+"px";this.totalDistanceMarker.domObj.style.left=E.x+"px"}},delayUpdate:function(A,B){this.delayUpdateTimer=null;this.updateMarker(this.lastMarker,A,B)},dblClick:function(E){if(!this.isDigitizing){return }var D=this.getMap().getEventPosition(E);var B=this.getMap().pixToGeo(D.x,D.y);var A=this.feature.lastSegment();A.to.set(B.x,B.y);this.clearContext();this.feature.draw(this.context);if(this.measureType==Fusion.Constant.MEASURE_TYPE_AREA||this.measureType==Fusion.Constant.MEASURE_TYPE_BOTH){}if(this.measureType==Fusion.Constant.MEASURE_TYPE_DISTANCE||this.measureType==Fusion.Constant.MEASURE_TYPE_BOTH){}this.isDigitizing=false;var C=this.distanceMarkers.pop();C.destroy();this.triggerEvent(Fusion.Event.MEASURE_COMPLETE)},positionMarker:function(B,F){var E=this.getMap().getDomObj();if(!B.domObj.parentNode||B.domObj.parentNode!=E){E.appendChild(B.domObj)}var D=B.getSize();var C=(F.from.py+F.to.py-D.height)/2;var A=(F.from.px+F.to.px-D.width)/2;B.domObj.style.top=C+"px";B.domObj.style.left=A+"px"},updateMarker:function(A,B,C){if(!A){return }this.measureSegment(B,A);this.positionMarker(A,B)},measureSegment:function(E,A){var D=this.getMap().getAllMaps();var C=D[0].arch+"/"+Fusion.getScriptLanguage()+"/Measure."+Fusion.getScriptLanguage();var B={parameters:{session:D[0].getSessionID(),locale:Fusion.locale,mapname:this.getMap().getMapName(),x1:E.from.x,y1:E.from.y,x2:E.to.x,y2:E.to.y},onComplete:OpenLayers.Function.bind(this.measureCompleted,this,E,A)};Fusion.ajaxRequest(C,B)},measureCompleted:function(segment,marker,r){if(r.status==200){var o;eval("o="+r.responseText);if(o.distance){mapUnits=Fusion.METERS;if(mapUnits!=this.units){o.distance=Fusion.convert(mapUnits,this.units,o.distance)}marker.setDistance(o.distance);this.positionMarker(marker,segment);this.triggerEvent(Fusion.Event.MEASURE_SEGMENT_UPDATE)}}},updateDisplay:function(E){var J=E.document;var D=J.getElementById("segmentTBody");var I;if(D){this.clearDisplay(E);var G=0;var F=Fusion.unitAbbr(this.units);for(var C=0;C<this.distanceMarkers.length;C++){var A=this.distanceMarkers[C].getDistance();G+=A;var H=J.createElement("tr");var B=J.createElement("td");B.innerHTML=OpenLayers.i18n("segment",{seg:C+1});H.appendChild(B);B=J.createElement("td");if(this.distPrecision==0){I=Math.floor(A)}else{I=A.toPrecision(this.distPrecision)}B.innerHTML=I+" "+F;H.appendChild(B);D.appendChild(H)}var K=J.getElementById("totalDistance");if(this.distPrecision==0){I=Math.floor(G)}else{I=G.toPrecision(this.distPrecision)}K.innerHTML=I+" "+F}},updateTotalDistance:function(){if(this.distanceMarkers.length>1){var A=0;var B=Fusion.unitAbbr(this.units);for(var C=0;C<this.distanceMarkers.length;C++){var D=this.distanceMarkers[C].getDistance();A+=D}this.totalDistanceMarker.domObj.style.display="block";this.totalDistanceMarker.setDistance(A)}},clearDisplay:function(C){var B=C.document;var A=B.getElementById("segmentTBody");if(A){while(A.firstChild){A.firstChild.marker=null;A.removeChild(A.firstChild)}var D=B.getElementById("totalDistance");D.innerHTML=""}},clearTotalDistance:function(){this.totalDistanceMarker.domObj.style.display="none"},setUnits:function(A){A=(A==Fusion.UNKNOWN)?Fusion.unitFromName(this.getMap().getUnits()):A;this.setParameter("Units",Fusion.unitName(A))},setParameter:function(C,B){if(C=="Units"){this.units=Fusion.unitFromName(B);for(var A=0;A<this.distanceMarkers.length;A++){this.distanceMarkers[A].setUnits(this.units)}if(this.totalDistanceMarker){this.totalDistanceMarker.setUnits(this.units)}}}});Fusion.Widget.Measure.DistanceMarker=OpenLayers.Class({calculatingImg:null,distance:0,initialize:function(B,A,C){this.precision=A;this.label=C?C:"";this.domObj=document.createElement("div");this.domObj.className="divMeasureMarker";this.calculatingImg=document.createElement("img");this.calculatingImg.src=Fusion.getFusionURL()+"widgets/Measure/MeasurePending.gif";this.calculatingImg.width=19;this.calculatingImg.height=4;this.setUnits(B);this.setCalculating()},destroy:function(){if(this.domObj.parentNode){this.domObj.parentNode.removeChild(this.domObj)}},setUnits:function(A){this.unit=A;this.unitAbbr=Fusion.unitAbbr(A)},getDistance:function(){return this.distance},getDistanceLabel:function(){var A;if(this.precision==0){A=Math.floor(this.distance)}else{A=this.distance.toPrecision(this.precision)}return this.label+" "+A+" "+this.unitAbbr},setDistance:function(A){if(this.calculatingImg.parentNode){this.calculatingImg.parentNode.removeChild(this.calculatingImg)}this.distance=A;this.domObj.innerHTML=this.getDistanceLabel()},setCalculating:function(){if(!this.calculatingImg.parentNode){this.domObj.innerHTML="";this.domObj.appendChild(this.calculatingImg)}},getSize:function(){var A=Element.getDimensions(this.domObj);var B={width:19,height:4};if(A.width<B.width){A.width+=B.width}if(A.height<B.height){A.height+=B.height}return A}});Fusion.Widget.Navigator=OpenLayers.Class(Fusion.Widget,{bInternalChange:false,zoomInFactor:4,zoomOutFactor:2,panAmount:50,initialize:function(E){Fusion.Widget.prototype.initialize.apply(this,[E,true]);var C=document.createElement("map");C.name="Navigator_ImageMap";C.id="Navigator_ImageMap";var N=document.createElement("area");N.shape="poly";N.alt=OpenLayers.i18n("panEast");N.title=OpenLayers.i18n("panEast");N.coords="27,176, 27,177, 40,190, 44,182, 44,159";var O=OpenLayers.Function.bind(this.pan,this,this.panAmount/100,0);Event.observe(N,"mouseup",OpenLayers.Function.bindAsEventListener(O,this));C.appendChild(N);var N=document.createElement("area");N.shape="poly";N.alt=OpenLayers.i18n("panWest");N.title=OpenLayers.i18n("panWest");N.coords="24,177, 24,176, 7,159, 7,182, 11,190";var A=OpenLayers.Function.bind(this.pan,this,-this.panAmount/100,0);Event.observe(N,"mouseup",OpenLayers.Function.bindAsEventListener(A,this));C.appendChild(N);var N=document.createElement("area");N.shape="poly";N.alt=OpenLayers.i18n("panSouth");N.title=OpenLayers.i18n("panSouth");N.coords="25,178, 12,191, 21,197, 30,197, 39,191, 26,178";var M=OpenLayers.Function.bind(this.pan,this,0,-this.panAmount/100);Event.observe(N,"mouseup",OpenLayers.Function.bindAsEventListener(M,this));C.appendChild(N);var N=document.createElement("area");N.shape="poly";N.alt=OpenLayers.i18n("panNorth");N.title=OpenLayers.i18n("panNorth");N.coords="26,175, 43,158, 8,158, 25,175";var G=OpenLayers.Function.bind(this.pan,this,0,this.panAmount/100);Event.observe(N,"mouseup",OpenLayers.Function.bindAsEventListener(G,this));C.appendChild(N);var N=document.createElement("area");N.shape="circle";N.alt=OpenLayers.i18n("zoomOut");N.title=OpenLayers.i18n("zoomOut");N.coords="25,142,8";var I=OpenLayers.Function.bind(this.zoom,this,1/this.zoomOutFactor);Event.observe(N,"mouseup",OpenLayers.Function.bindAsEventListener(I,this));C.appendChild(N);var N=document.createElement("area");N.shape="circle";N.alt=OpenLayers.i18n("zoomIn");N.title=OpenLayers.i18n("zoomIn");N.coords="25,34,8";var D=OpenLayers.Function.bind(this.zoom,this,this.zoomInFactor);Event.observe(N,"mouseup",OpenLayers.Function.bindAsEventListener(D,this));C.appendChild(N);this.domObj.appendChild(C);var H=document.createElement("img");H.src=Fusion.getFusionURL()+E.location+"Navigator/sliderscale.png";H.className="png24";H.width=51;H.height=201;H.style.position="absolute";H.style.left="0px";H.style.top="0px";H.useMap="#Navigator_ImageMap";this.domObj.appendChild(H);var F=document.createElement("div");F.style.position="absolute";F.style.top="6px";F.style.left="6px";F.style.width="39px";F.style.height="16px";this.domObj.appendChild(F);var J=document.createElement("div");J.style.position="absolute";J.style.top="44px";J.style.left="0px";J.style.width="51px";J.style.height="88px";this.domObj.appendChild(J);var B=document.createElement("img");B.src=Fusion.getFusionURL()+E.location+"Navigator/slider.png";B.className="png24";B.width=29;B.height=12;B.style.position="absolute";B.style.left="11px";B.style.top="49px";J.appendChild(B);this.activityIndicator=document.createElement("img");this.activityIndicator.src=Fusion.getFusionURL()+E.location+"Navigator/spinner.gif";this.activityIndicator.width=18;this.activityIndicator.height=6;this.activityIndicator.style.position="absolute";this.activityIndicator.style.top="3px";this.activityIndicator.style.right="4px";F.appendChild(this.activityIndicator);this.domObj.style.position="absolute";this.domObj.style.zIndex=1000;this.domObj.style.width="51px";this.domObj.style.height="204px";this.domObj.style.cursor="pointer";var K=OpenLayers.Function.bind(this.checkPosition,this);new Draggable(this.domObj,{handle:F,starteffect:false,endeffect:false});var L={element:this.domObj,onStart:function(){},onEnd:K};Draggables.addObserver(L);var P={};P.axis="vertical";P.range=$R(1,91);P.sliderValue=91;P.onChange=OpenLayers.Function.bind(this.scaleChanged,this);this.slider=new Control.Slider(B,J,P);this.slider.setDisabled();this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.updateSlider,this));this.getMap().registerForEvent(Fusion.Event.MAP_RESIZED,OpenLayers.Function.bind(this.checkPosition,this));this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.updateValue,this));this.getMap().registerForEvent(Fusion.Event.MAP_BUSY_CHANGED,OpenLayers.Function.bind(this.busyChanged,this))},scaleChanged:function(E){var G=this.getMap();var F=null;if(G.oActiveWidget){F=G.oActiveWidget;G.deactivateWidget(G.oActiveWidget)}if(!this.bInternalChange){var G=this.getMap();var A=G.getCurrentCenter();var C=G.getSize();var D=C.w*E;var B=C.h*E;G.setExtents(new OpenLayers.Bounds(A.x-D/2,A.y-B/2,A.x+D/2,A.y+B/2))}if(F){G.activateWidget(F)}return false},checkPosition:function(){var D=this.domObj;var C=Element.getDimensions(D.parentNode);var B,A;B=parseInt(D.style.left);A=parseInt(D.style.top);if(B+D.getWidth()>C.width){B=C.width-D.getWidth();D.style.left=B+"px"}if(A+D.getHeight()>C.height){A=C.height-D.getHeight();D.style.top=A+"px"}if(B<0){D.style.left="0px"}if(A<0){D.style.top="0px"}},updateSlider:function(){var E=this.getMap().oMapOL;if(E.baseLayer.singleTile){this.slider.values=[];this.slider.range=$R(E.baseLayer.minResolution,E.baseLayer.maxResolution);this.bInternalChange=true;this.slider.setValue(E.getResolution());this.bInternalChange=false}else{var D=E.baseLayer.resolutions;var G=D.length;var A=D[0];var C=D[G-1];this.slider.values=[];this.slider.range=$R(1,91);for(var B=0;B<G;B++){var F=D[B];this.slider.values.push(parseInt((F/A)*91))}}this.slider.setEnabled()},updateValue:function(){var A=this.getMap().oMapOL;this.bInternalChange=true;this.slider.setValue(A.getResolution());this.bInternalChange=false},pan:function(B,H,G){var F=this.getMap();var E=null;if(F.oActiveWidget){E=F.oActiveWidget;F.deactivateWidget(F.oActiveWidget)}var A=F.getCurrentCenter();var D=F.oMapOL.getResolution();var C=F.oMapOL.getSize();F.zoom(A.x+(B*C.w*D),A.y+(H*C.h*D),1);Event.stop(G);if(E){F.activateWidget(E)}return false},zoom:function(B,E){var D=this.getMap();var C=null;if(D.oActiveWidget){C=D.oActiveWidget;D.deactivateWidget(D.oActiveWidget)}var A=D.getCurrentCenter();D.zoom(A.x,A.y,B);Event.stop(E);if(C){D.activateWidget(C)}return false},busyChanged:function(){this.activityIndicator.style.visibility=this.getMap().isBusy()?"visible":"hidden"}});Fusion.Widget.OverviewMap=OpenLayers.Class(Fusion.Widget,{oSize:null,nMinRatio:4,nMaxRatio:32,bDisplayed:false,initialize:function(widgetTag){Fusion.Widget.prototype.initialize.apply(this,[widgetTag,false]);var json=widgetTag.extension;if(json.MinRatio){this.nMinRatio=json.MinRatio[0]}if(json.MaxRatio){this.nMaxRatio=json.MaxRatio[0]}var mapTag=null;if(json.MapId){this.sMapGroupId=json.MapId;var mapGroup=Fusion.applicationDefinition.getMapGroup(this.sMapGroupId);mapTag=mapGroup.maps[0]}else{var mainMap=this.getMap();mapTag=mainMap.mapGroup.maps[0]}this.mapObject=eval("new Fusion.Maps."+mapTag.type+"(this.getMap(),mapTag,false)");this.mapObject.registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.loadOverview,this));if(this.domObj){this.domObj.style.overflow="hidden";if(this.domObj.jxLayout){this.domObj.jxLayout.addSizeChangeListener(this)}else{this.domObj.resize=OpenLayers.Function.bind(this.sizeChanged,this)}}this.oMapOptions={}},mapWidgetLoaded:function(){var A=this.getMap();if(this.sMapGroupId&&(A.projection==this.mapObject.projection)){this.loadOverview([this.mapObject.oLayerOL])}else{var B=this.oMap._oCurrentExtents;this.loadOverview([this.getMap().oMapOL.baseLayer.clone()])}},keymapLoaded:function(){this.mapObject.oLayerOL.isBaseLayer=true},loadOverview:function(){if(this.control){this.control.destroy()}var A=Element.getContentBoxSize(this.domObj);this.oSize=new OpenLayers.Size(A.width,A.height);this.mapObject.oLayerOL.isBaseLayer=true;if(this.mapObject.oLayerOL.singleTile){this.oMapOptions.numZoomLevels=3}this.mapObject.oLayerOL.ratio=1;var B={div:this.domObj,size:this.oSize,minRatio:this.nMinRatio,maxRatio:this.nMaxRatio,mapOptions:this.oMapOptions,layers:[this.mapObject.oLayerOL]};this.control=new OpenLayers.Control.OverviewMap(B);if(A.width==0||A.height==0){return }else{this.getMap().oMapOL.addControl(this.control);this.bDisplayed=true}},sizeChanged:function(){var A=Element.getContentBoxSize(this.domObj);this.oSize=new OpenLayers.Size(A.width,A.height);if(A.width==0||A.height==0){return }if(!this.bDisplayed&&this.control){this.getMap().oMapOL.addControl(this.control);this.bDisplayed=true}if(this.control){this.control.size=new OpenLayers.Size(A.width,A.height);this.control.mapDiv.style.width=this.oSize.w+"px";this.control.mapDiv.style.height=this.oSize.h+"px";this.control.ovmap.updateSize();this.control.update()}}});Fusion.Widget.Pan=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{initialize:function(A){Fusion.Widget.prototype.initialize.apply(this,[A,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);this.control=new OpenLayers.Control.DragPan();this.getMap().oMapOL.addControl(this.control);this.control.handler.keyMask=0;this.cursorNormal=["url('images/grab.cur'),move","grab","-moz-grab","move"];this.cursorDrag=["url('images/grabbing.cur'),move","grabbing","-moz-grabbing","move"]},activateTool:function(){this.getMap().activateWidget(this)},activate:function(){this.control.activate();this.getMap().setCursor(this.cursorNormal);this._oButton.activateTool()},deactivate:function(){this.control.deactivate();this.getMap().setCursor("auto");this._oButton.deactivateTool()}});Fusion.Widget.PanOnClick=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{fPercent:null,nDeltaX:null,nDeltaY:null,initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=C.extension;var B=A.Percentage?A.Percentage[0]:75;this.fPercent=parseFloat(B)/100;var D=A.Direction?A.Direction[0]:"";switch(D){case"north":this.nDeltaX=0;this.nDeltaY=1;break;case"south":this.nDeltaX=0;this.nDeltaY=-1;break;case"east":this.nDeltaX=1;this.nDeltaY=0;break;case"west":this.nDeltaX=-1;this.nDeltaY=0;break;default:this.nDeltaX=0;this.nDeltaY=0}},execute:function(){var D=this.getMap().getCurrentExtents();var A=this.getMap().getCurrentCenter();var C,B;C=A.x+this.nDeltaX*(D[2]-D[0])*this.fPercent;B=A.y+this.nDeltaY*(D[3]-D[1])*this.fPercent;this.getMap().zoom(C,B,1)}});Fusion.Widget.PanQuery=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{selectionType:"INTERSECTS",nTolerance:3,bActiveOnly:false,initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);this.control=new OpenLayers.Control.DragPan();this.getMap().oMapOL.addControl(this.control);this.control.handler.up=OpenLayers.Function.bind(this.mouseUp,this);var A=C.extension;this.nTolerance=A.Tolerance?Math.abs(parseInt(A.Tolerance)):3;this.bComputeMetadata=(A.ComputeMetadata&&(A.ComputeMetadata[0]=="true"||A.ComputeMetadata[0]=="1"))?true:false;var B=A.QueryActiveLayer?A.QueryActiveLayer[0]:"false";this.bActiveOnly=(B=="true"||B=="1")?true:false;this.cursorNormal=["auto"];this.cursorDrag=["url('images/grabbing.cur'),move","grabbing","-moz-grabbing","move"]},mouseUp:function(D){var J=this.control.handler;var A={x:Event.pointerX(D),y:Event.pointerY(D)};var M=J.start.x-J.last.x;var K=J.start.y-J.last.y;if(Math.abs(M)<this.nTolerance&&Math.abs(K)<this.nTolerance){var G=this.getMap().pixToGeo(J.last.x,J.last.y);var L={};var B=this.getMap().pixToGeoMeasure(this.nTolerance);var I=G.x-B;var H=G.y-B;var F=G.x+B;var E=G.y+B;L.geometry="POLYGON(("+I+" "+H+", "+F+" "+H+", "+F+" "+E+", "+I+" "+E+", "+I+" "+H+"))";L.selectionType="INTERSECTS";L.computed=this.bComputeMetadata;if(this.bActiveOnly){var C=this.getMap().getActiveLayer();if(C){L.layers=C.layerName}else{return }}if(D.shiftKey){L.extendSelection=true}this.getMap().aMaps[0].query(L)}Event.stop(D)},activateTool:function(){this.getMap().activateWidget(this)},activate:function(){this.control.activate();this.getMap().setCursor(this.cursorNormal);this._oButton.activateTool()},deactivate:function(){this.control.deactivate();this.getMap().setCursor("auto");this._oButton.deactivateTool()},setParameter:function(B,A){if(B=="Tolerance"&&A>0){this.nTolerance=A}if(B=="SelectionType"){this.selectionType=A}}});Fusion.Widget.Print=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{initialize:function(D){Fusion.Widget.prototype.initialize.apply(this,[D,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var C=D.extension;var F=C.ShowPrintUI?C.ShowPrintUI[0]:"false";this.showPrintUI=(F.toLowerCase()=="true"||F=="1");var E=C.ShowTitle?C.ShowTitle[0]:"false";this.showTitle=(E.toLowerCase()=="true"||E=="1");this.pageTitle=C.PageTitle?C.PageTitle[0]:"";this.resultsLayer=C.ResultsLayer?C.ResultsLayer[0]:null;var B=C.ShowLegend?C.ShowLegend[0]:"false";this.showLegend=(B.toLowerCase()=="true"||B=="1");var A=C.ShowNorthArrow?C.ShowNorthArrow[0]:"false";this.showNorthArrow=(A.toLowerCase()=="true"||A=="1");this.imageBaseUrl=C.ImageBaseUrl?C.ImageBaseUrl[0]:null;this.dialogContentURL=Fusion.getFusionURL()+D.location+"Print/Print.html";this.printablePageURL=Fusion.getFusionURL()+D.location+"Print/printablepage.php";Fusion.addWidgetStyleSheet(D.location+"Print/Print.css")},execute:function(){if(this.showPrintUI){this.openPrintUI()}else{this.openPrintable()}},openPrintUI:function(){if(!this.dialog){var A=Element.getPageDimensions();var B={title:OpenLayers.i18n("printTitle"),id:"printablePage",contentURL:this.dialogContentURL,onContentLoaded:OpenLayers.Function.bind(this.contentLoaded,this),imageBaseUrl:this.imageBaseUrl,width:350,height:250,resizeable:true,top:(A.height-250)/2,left:(A.width-350)/2,buttons:["generate","cancel"],handler:OpenLayers.Function.bind(this.handler,this)};this.dialog=new Jx.Dialog(B)}this.dialog.open()},setParameter:function(B,A){switch(B){case"Print_ShowTitle":this.showTitle=A;break;case"Print_Title":this.pageTitle=A;break;case"Print_ShowLegend":this.showLegend=A;break;case"Print_ShowNorthArrow":this.showNorthArrow=A;break}},contentLoaded:function(A){A.registerIds(["dialogPrintShowtitle","dialogPrintTitle","dialogPrintShowlegend","dialogPrintShowNorthArrow"],A.content);A.getObj("dialogPrintShowtitle").checked=this.showTitle;A.getObj("dialogPrintTitle").value=this.pageTitle;A.getObj("dialogPrintTitle").disabled=!this.showTitle;A.getObj("dialogPrintShowlegend").checked=this.showLegend;A.getObj("dialogPrintShowNorthArrow").checked=this.showNorthArrow;Event.observe(A.getObj("dialogPrintShowtitle"),"click",OpenLayers.Function.bind(this.controlTitle,this))},controlTitle:function(){this.dialog.getObj("dialogPrintTitle").disabled=!this.dialog.getObj("dialogPrintShowtitle").checked},handler:function(A){if(A=="generate"){this.showTitle=this.dialog.getObj("dialogPrintShowtitle").checked;this.pageTitle=this.dialog.getObj("dialogPrintTitle").value;this.showLegend=this.dialog.getObj("dialogPrintShowlegend").checked;this.showNorthArrow=this.dialog.getObj("dialogPrintShowNorthArrow").checked;this.openPrintable()}this.dialog.close()},openPrintable:function(){var A=this.getMap();var B=this.printablePageURL+"?";var D=A.getCurrentExtents();var F=(D.left+D.right)/2;var E=(D.top+D.bottom)/2;var C=A._nDpi;var H=A.getScale();var G=A.getAllMaps();B=B+"MAPNAME="+A.getMapName();B=B+"&SESSION="+G[0].getSessionID();B=B+"&CENTERX="+F;B=B+"&CENTERY="+E;B=B+"&DPI="+C;B=B+"&SCALE="+H;B=B+"&ISTITLE="+(this.showTitle!=""?"1":"0");B=B+"&ISLEGEND="+(this.showLegend?"1":"0");B=B+"&ISARROW="+(this.showNorthArrow?"1":"0");if(this.pageTitle!=""){B=B+"&TITLE="+this.pageTitle}window.open(B,"printablepage","")}});Fusion.Widget.RefreshMap=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{initialize:function(A){Fusion.Widget.prototype.initialize.apply(this,[A,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[])},execute:function(){var A=this.getMap();A.redraw()}});Fusion.Widget.SaveMap=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{iframe:null,printLayout:null,printScale:null,imageWidth:null,imageHeight:null,initialize:function(F){Fusion.Widget.prototype.initialize.apply(this,[F,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var N=F.extension;this.format=(N.Format&&N.Format[0]!="")?N.Format[0]:"png";if(this.format=="DWF"&&N.PrintLayout.length){Object.inheritFrom(this,Fusion.Tool.MenuBase.prototype,[]);var K=N.PrintLayout;for(var I=0;I<K.length;I++){var J=K[I];var B={};B.label=J.Name[0];var H={rid:J.ResourceId[0]};if(J.PageHeight){H.pageHeight=J.PageHeight[0]}if(J.PageWidth){H.pageWidth=J.PageWidth[0]}if(J.Margins){H.margins=[J.Margins[0].Top[0],J.Margins[0].Left[0],J.Margins[0].Right[0],J.Margins[0].Bottom[0]]}var A=null;if(J.Scale){A=new Jx.SubMenu(B);H.scales=[];for(var E=0;E<J.Scale.length;E++){H.scales.push(J.Scale[E]);var G=new Jx.Action(this.setLayout.bind(this,H,E));var C=new Jx.MenuItem(G,{label:J.Scale[E]});A.add(C)}var M=new Jx.Action(this.setLayout.bind(this,H));var L=new Jx.MenuItem(M,{label:"Current Scale"});A.add(L)}else{var D=new Jx.Action(this.setLayout.bind(this,H));A=new Jx.MenuItem(D,B)}this.oMenu.add(A)}}else{Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);if(N.Width&&N.Width[0]!=""){this.imageWidth=N.Width[0]}if(N.Height&&N.Height[0]!=""){this.imageHeight=N.Height[0]}}this.enable=Fusion.Widget.SaveMap.prototype.enable},enable:function(){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])},setLayout:function(A){this.printLayout=A.rid;this.pageHeight=A.pageHeight;this.pageWidth=A.pageWidth;this.pageMargins=A.margins;if(arguments.length==3){this.printScale=parseFloat(A.scales[arguments[1]])}else{this.printScale=null}this.activateTool()},activateTool:function(){if(!this.iframe){this.iframe=document.createElement("iframe");this.iframe.id="w";this.iframe.style.visibility="hidden";document.body.appendChild(this.iframe)}var B="";var J="";var C="";var H="";var F="";if(this.format==="DWF"){if(this.printLayout){B="&layout="+this.printLayout}else{alert("DWF Save is not properly configured.");return }if(this.printScale){J="&scale="+this.printScale}if(this.pageHeight){C="&pageheight="+this.pageHeight}if(this.pageWidth){H="&pagewidth="+this.pageWidth}if(this.pageMargins){F="&margins="+this.pageMargins.join(",")}}var E="";if(this.imageHeight){E="&height="+this.imageHeight}var G="";if(this.imageWidth){G="&width="+this.imageWidth}var D=this.getMap().aMaps[0];if(navigator.appVersion.match(/\bMSIE\b/)){var A=Fusion.fusionURL+"/"+D.arch+"/"+Fusion.getScriptLanguage()+"/SaveMapFrame."+Fusion.getScriptLanguage()+"?session="+D.getSessionID()+"&mapname="+D.getMapName()+"&format="+this.format+B+J+G+E+C+H+F;w=open(A,"Save","menubar=no,height=200,width=300")}else{var I=Fusion.fusionURL+"/"+D.arch+"/"+Fusion.getScriptLanguage()+"/SaveMap."+Fusion.getScriptLanguage()+"?session="+D.getSessionID()+"&mapname="+D.getMapName()+"&format="+this.format+B+J+G+E+C+H+F;this.iframe.src=I}}});if(typeof (ScaleBarTool)=="undefined"){Fusion.require("widgets/scalebar/scalebartool.js")}Fusion.Widget.Scalebar=OpenLayers.Class(Fusion.Widget,{style:"thin",displaySystem:"metric",minWidth:100,maxWidth:200,divisions:2,subdivisions:2,showMinorMeasures:true,abbreviateLabel:true,singleLine:false,initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,false]);var B=C.extension;this.style=B.Style?B.Style[0].toLowerCase():this.style;if(this.style!="fancy"&&this.style!="fat"&&this.style!="thin"&&this.style!="thinner"){this.style="thin"}this.displaySystem=B.DisplaySystem?B.DisplaySystem[0]:this.displaySystem;this.minWidth=B.MinWidth?B.MinWidth[0]:this.minWidth;this.maxWidth=B.MaxWidth?B.MaxWidth[0]:this.maxWidth;this.divisions=B.Divisions?B.Divisions[0]:this.divisions;this.subdivisions=B.SubDivisions?B.SubDivisions[0]:this.subdivisions;this.showMinorMeasures=(B.ShowMinorMeasures&&B.ShowMinorMeasures[0])=="false"?false:true;this.abbreviateLabel=(B.AbbreviateLabel&&B.AbbreviateLabel[0])=="true"?true:false;this.singleLine=(B.SingleLine&&B.SingleLine[0])=="true"?true:false;if(document.styleSheets){if(document.styleSheets[0]){var A=Fusion.getFusionURL()+"widgets/scalebar/scalebar-"+this.style+".css";if(document.styleSheets[0].addImport){document.styleSheets[0].addImport(A)}else{document.styleSheets[0].insertRule("@import url("+A+");",0)}}}this.oScaleBar=new ScaleBarTool(1);this.oScaleBar.displaySystem=this.displaySystem;this.oScaleBar.minWidth=this.minWidth;this.oScaleBar.maxWidth=this.maxWidth;this.oScaleBar.divisions=this.divisions;this.oScaleBar.subdivisions=this.subdivisions;this.oScaleBar.showMinorMeasures=this.showMinorMeasures;this.oScaleBar.abbreviateLabel=this.abbreviateLabel;this.oScaleBar.singleLine=this.singleLine;window.setTimeout(OpenLayers.Function.bind(this.oScaleBar,C.name),1);this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.extentsChangedCB,this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.extentsChangedCB,this))},extentsChangedCB:function(){this.oScaleBar.update(this.getMap().getScale())}});Fusion.Widget.ScalebarDual=OpenLayers.Class(Fusion.Widget,{initialize:function(H){Fusion.Widget.prototype.initialize.apply(this,[H]);var E=H.extension;var G=E.MaxWidth?parseInt(E.MaxWidth[0]):300;var F=E.TopInUnits?E.TopInUnits[0]:"ft";var A=E.TopOutUnits?E.TopOutUnits[0]:"mi";var C=E.BottomInUnits?E.BottomInUnits[0]:"m";var D=E.BottomOutUnits?E.BottomOutUnits[0]:"km";var B={maxWidth:G,topInUnits:F,topOutUnits:A,bottomInUnits:C,bottomOutUnits:D};this.addControl(new OpenLayers.Control.ScaleLine(B))}});Fusion.Widget.Search=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{sFeatures:"menubar=no,location=no,status=no,scrollbars=yes",initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=B.extension;this.sTarget=A.Target?A.Target[0]:"SearchWindow";this.sBaseUrl=Fusion.getFusionURL()+"widgets/Search/SearchPrompt.php";this.prompt=A.Prompt?A.Prompt[0]:"";this.layer=A.Layer?A.Layer[0]:"";this.filter=A.Filter?A.Filter[0]:"";this.limit=A.MatchLimit?A.MatchLimit[0]:100;this.resultColumns=A.ResultColumns?A.ResultColumns[0].Column:[];this.title=A.Title?A.Title[0]:B.label},execute:function(){var C=this.sBaseUrl;var E=this.getMap();var B=E.getAllMaps();var D=Fusion.getWidgetById(this.sTarget);var A=$(this.sTarget);var F=[];F.push("locale="+Fusion.locale);F.push("session="+B[0].getSessionID());F.push("mapname="+B[0].getMapName());if(D||A){F.push("popup=false")}else{F.push("popup=true")}F.push("widgetname="+this.id);if(C.indexOf("?")<0){C+="?"}else{if(C.slice(-1)!="&"){C+="&"}}C+=F.join("&");if(D){D.setContent(C)}else{if(A){A.src=C}else{window.open(C,this.sTarget,this.sWinFeatures)}}}});Fusion.Widget.Select=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{selectionType:"INTERSECTS",nTolerance:3,bActiveOnly:false,maxFeatures:0,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);this.asCursor=["auto"];this.enable=Fusion.Widget.Select.prototype.enable;var A=B.extension;this.selectionType=A.SelectionType?A.SelectionType[0]:"INTERSECTS";if(A.Tolerance&&(parseInt(A.Tolerance[0])>0)){nTolerance=parseInt(A.Tolerance[0])}if(A.MaxFeatures){this.maxFeatures=parseInt(A.MaxFeatures[0])}this.bActiveOnly=(A.QueryActiveLayer&&(A.QueryActiveLayer[0]=="true"||A.QueryActiveLayer[0]=="1"))?true:false;this.bComputeMetadata=(A.ComputeMetadata&&(A.ComputeMetadata[0]=="true"||A.ComputeMetadata[0]=="1"))?true:false;if(this.bActiveOnly){this.getMap().registerForEvent(Fusion.Event.MAP_ACTIVE_LAYER_CHANGED,OpenLayers.Function.bind(this.enable,this))}this.map=this.getMap().oMapOL;this.handler=new OpenLayers.Handler.Box(this,{done:this.execute},{keyMask:0});this.shiftHandler=new OpenLayers.Handler.Box(this,{done:this.extend},{keyMask:OpenLayers.Handler.MOD_SHIFT})},enable:function(){if(this.bActiveOnly){var A=this.getMap().getActiveLayer();if(A&&A.selectable){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}else{this.disable()}}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}},activateTool:function(){this.getMap().activateWidget(this)},activate:function(){this.handler.activate();this.shiftHandler.activate();this.getMap().setCursor(this.asCursor);this._oButton.activateTool()},deactivate:function(){this.handler.deactivate();this.shiftHandler.deactivate();this.getMap().setCursor("auto");this._oButton.deactivateTool()},execute:function(G,J){if(this.keyModifiers&OpenLayers.Handler.MOD_CTRL){}var E,B;var A=G.left;var L=G.bottom;if(G instanceof OpenLayers.Bounds){E=G.right;B=G.top}else{E=A=G.x;B=L=G.y}var F=this.getMap().pixToGeo(A,L);var K=this.getMap().pixToGeo(E,B);var D=Math.abs(A-E);var I=Math.abs(L-B);var M={};if(D<=this.nTolerance&&I<=this.nTolerance){var C=this.getMap().pixToGeoMeasure(this.nTolerance);F.x=F.x-C;F.y=F.y-C;K.x=K.x+C;K.y=K.y+C}M.geometry="POLYGON(("+F.x+" "+F.y+", "+K.x+" "+F.y+", "+K.x+" "+K.y+", "+F.x+" "+K.y+", "+F.x+" "+F.y+"))";M.selectionType=this.selectionType;M.maxFeatures=this.maxFeatures;M.computed=this.bComputeMetadata;if(this.bActiveOnly){var H=this.getMap().getActiveLayer();if(H){M.layers=H.layerName}else{return }}if(J){M.extendSelection=true}this.getMap().query(M)},extend:function(A){this.execute(A,true)},setModifiers:function(A){this.keyModifiers=(A.shiftKey?OpenLayers.Handler.MOD_SHIFT:0)|(A.ctrlKey?OpenLayers.Handler.MOD_CTRL:0)|(A.altKey?OpenLayers.Handler.MOD_ALT:0)},clearModifiers:function(A){this.keyModifiers=0},setParameter:function(B,A){if(B=="Tolerance"&&A>0){this.nTolerance=A}if(B=="SelectionType"){this.selectionType=A}}});Fusion.Widget.SelectPolygon=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,Fusion.Tool.ButtonBase,Fusion.Tool.Canvas,{selectionType:"INTERSECTS",nTolerance:3,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);Fusion.Tool.Canvas.prototype.initialize.apply(this,[]);this.asCursor=["auto"];var A=B.extension;this.selectionType=A.SelectionType?A.SelectionType[0]:"INTERSECTS";if(A.Tolerance&&(parseInt(A.Tolerance[0])>0)){nTolerance=parseInt(A.Tolerance[0])}this.bComputeMetadata=(A.ComputeMetadata&&(A.ComputeMetadata[0]=="true"||A.ComputeMetadata[0]=="1"))?true:false;this.polygon=new Fusion.Tool.Canvas.Polygon()},activateTool:function(){this.getMap().activateWidget(this)},activate:function(){this.activateCanvas();this.getMap().setCursor(this.asCursor);this._oButton.activateTool();this.polygon=new Fusion.Tool.Canvas.Polygon(this.getMap())},deactivate:function(){this.deactivateCanvas();this.getMap().setCursor("auto");this._oButton.deactivateTool()},mouseDown:function(D){if(Event.isLeftClick(D)){var C=this.getMap().getEventPosition(D);if(!this.isDigitizing){this.polygon=new Fusion.Tool.Canvas.Polygon(this.getMap());var A=this.getMap().pixToGeo(C.x,C.y);var F=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());var E=new Fusion.Tool.Canvas.Node(A.x,A.y,this.getMap());var B=new Fusion.Tool.Canvas.Segment(F,E);B.setEditing(true);this.polygon.addSegment(B);this.clearContext();this.polygon.draw(this.context);this.isDigitizing=true}else{var B=this.polygon.lastSegment();B.setEditing(false);B=this.polygon.extendLine();B.setEditing(true);this.clearContext();this.polygon.draw(this.context)}}},mouseMove:function(C){if(!this.isDigitizing){return }var B=this.getMap().getEventPosition(C);var A=this.polygon.lastSegment();A.to.setPx(B.x,B.y);A.to.updateGeo();this.clearContext();this.polygon.draw(this.context)},dblClick:function(D){if(!this.isDigitizing){return }this.event=D;var C=this.getMap().getEventPosition(D);var A=this.getMap().pixToGeo(C.x,C.y);var B=this.polygon.lastSegment();B.setEditing(false);B.to.set(A.x,A.y);this.clearContext();this.isDigitizing=false;this.execute()},execute:function(){var F="POLYGON((";var A=this.polygon.getNodes();var C="";for(var E=0;E<A.length;E++){F=F+C+A[E].x+" "+A[E].y;C=","}F=F+C+A[0].x+" "+A[0].y+"))";var B={};B.geometry=F;B.selectionType=this.selectionType;B.computed=this.bComputeMetadata;if(this.bActiveOnly){var D=this.getMap().getActiveLayer();if(D){B.layers=D.layerName}else{return }}if(this.event.shiftKey){B.extendSelection=true}this.getMap().query(B)},setParameter:function(B,A){if(B=="Tolerance"&&A>0){this.nTolerance=A}if(B=="SelectionType"){this.selectionType=A}}});Fusion.Event.RADIUS_WIDGET_ACTIVATED=Fusion.Event.lastEventId++;Fusion.Widget.SelectRadius=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,Fusion.Tool.Canvas,{selectionType:"INTERSECTS",nTolerance:3,defaultRadius:20,initialize:function(D){Fusion.Widget.prototype.initialize.apply(this,[D,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);Fusion.Tool.Canvas.prototype.initialize.apply(this,[]);this.asCursor=["auto"];this.isDigitizing=false;var B=D.extension;this.selectionType=B.SelectionType?B.SelectionType[0]:"INTERSECTS";if(B.Tolerance&&(parseInt(B.Tolerance[0])>0)){nTolerance=parseInt(B.Tolerance[0])}this.defaultRadius=B.DefaultRadius?parseInt(B.DefaultRadius[0]):this.defaultRadius;this.bComputeMetadata=(B.ComputeMetadata&&(B.ComputeMetadata[0]=="true"||B.ComputeMetadata[0]=="1"))?true:false;var A=B.RadiusTooltipContainer?B.RadiusTooltipContainer[0]:"";if(A!=""){this.radiusTip=$(A)}if(this.radiusTip){this.radiusTipType=B.RadiusTooltipType?B.RadiusTooltipType[0].toLowerCase():"dynamic";if(this.radiusTipType=="dynamic"){var C=this.getMap().getDomObj();C.appendChild(this.radiusTip);this.radiusTip.style.position="absolute";this.radiusTip.style.display="none";this.radiusTip.style.top="0px";this.radiusTip.style.left="0px";this.radiusTip.style.zIndex=101}}this.registerEventID(Fusion.Event.RADIUS_WIDGET_ACTIVATED)},setRadius:function(A){this.defaultRadius=A},getRadius:function(){if(this.circle){return this.circle.radius}else{return this.defaultRadius}},activateTool:function(){this.getMap().activateWidget(this)},activate:function(){this.activateCanvas();this.getMap().setCursor(this.asCursor);this._oButton.activateTool();if(!this.circle){this.circle=new Fusion.Tool.Canvas.Circle(this.getMap())}this.units=this.getMap().getAllMaps()[0].units;this.triggerEvent(Fusion.Event.RADIUS_WIDGET_ACTIVATED,true)},deactivate:function(){this.deactivateCanvas();this.getMap().setCursor("auto");this._oButton.deactivateTool();this.triggerEvent(Fusion.Event.RADIUS_WIDGET_ACTIVATED,false)},mouseDown:function(F){if(Event.isLeftClick(F)){var E=this.getMap().getEventPosition(F);var B=this.getMap().pixToGeo(E.x,E.y);var A=this.defaultRadius;if(!this.isDigitizing){this.circle.setCenter(B.x,B.y);this.circle.setRadius(A);this.clearContext();this.circle.draw(this.context);this.isDigitizing=true}}if(this.radiusTip&&this.radiusTipType=="dynamic"){this.radiusTip.style.display="block";var C=Element.getDimensions(this.radiusTip);this.radiusTip.style.top=(E.y-C.height*2)+"px";this.radiusTip.style.left=E.x+"px";var D=this.circle.radius;if(this.units=="m"||this.units=="ft"){D=Math.round(D*100)/100}this.radiusTip.innerHTML=D+this.units}},mouseMove:function(H){if(!this.isDigitizing){return }var G=this.getMap();var F=G.getEventPosition(H);var C=G.pixToGeo(F.x,F.y);var B=this.circle.center;var A=Math.sqrt(Math.pow(B.x-C.x,2)+Math.pow(B.y-C.y,2));if(A>this.nTolerance){this.circle.setRadius(A)}this.clearContext();this.circle.draw(this.context);if(this.radiusTip&&this.radiusTipType=="dynamic"){this.radiusTip.style.display="block";var D=Element.getDimensions(this.radiusTip);this.radiusTip.style.top=(F.y-D.height*2)+"px";this.radiusTip.style.left=F.x+"px";var E=this.circle.radius;if(this.units=="m"||this.units=="ft"){E=Math.round(E*100)/100}this.radiusTip.innerHTML=E+this.units}},mouseUp:function(C){if(this.isDigitizing){this.event=C;this.clearContext();this.isDigitizing=false;var B=this.circle.center;var A=this.circle.radius;this.execute(B,A)}if(this.radiusTip&&this.radiusTipType=="dynamic"){this.radiusTip.style.display="none";this.radiusTip.innerHTML=""}},execute:function(A,F){var G="POLYGON((";var H=16;var B=2*Math.PI/H;var L="";var D;for(var C=0;C<H;C++){var J=A.x+F*Math.cos(C*B);var I=A.y+F*Math.sin(C*B);if(C==0){D=J+" "+I}G=G+L+J+" "+I;L=","}G=G+L+D+"))";var K={};K.geometry=G;K.selectionType=this.selectionType;K.computed=this.bComputeMetadata;if(this.bActiveOnly){var E=this.getMap().getActiveLayer();if(E){K.layers=E.layerName}else{return }}if(this.event.shiftKey){K.extendSelection=true}this.getMap().query(K)},setParameter:function(B,A){if(B=="Tolerance"&&A>0){this.nTolerance=A}if(B=="SelectionType"){this.selectionType=A}}});Fusion.Widget.SelectRadiusValue=OpenLayers.Class(Fusion.Widget,{radiusWidgetName:null,label:"",className:"",domLabel:null,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,false]);var A=B.extension;this.radiusWidgetName=A.RadiusName?A.RadiusName[0]:null;this.label=A.Label?A.Label[0]:"";this.className=A.ClassName?A.ClassName[0]:"";this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.mapLoaded,this));this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.mapExtentsChanged,this))},draw:function(){var A=this.getMap().getAllMaps()[0].units;this.domLabel=document.createElement("span");this.domLabel.className=this.className;this.domLabel.innerHTML=this.label+"("+A+")";this.input=document.createElement("input");this.input.type="text";this.domLabel.appendChild(this.input);this.domObj.appendChild(this.domLabel);Event.observe(this.input,"blur",OpenLayers.Function.bind(this.onBlur,this))},mapLoaded:function(){this.draw();this.input.disabled=true;var B=Fusion.getWidgetsByType("SelectRadius");for(var A=0;A<B.length;A++){if(B[A].widgetTag.name==this.radiusWidgetName){this.widget=B[A];this.widget.registerForEvent(Fusion.Event.RADIUS_WIDGET_ACTIVATED,this.dependantEnable.bind(this));break}}this.updateFromWidgetValue()},dependantEnable:function(A,B){if(this.widget){if(B){this.input.disabled=false}else{this.input.disabled=true}}},mapExtentsChanged:function(){this.updateWidgetValue()},onBlur:function(){this.updateWidgetValue()},updateWidgetValue:function(){if(this.widget){var A=this.input.getValue();this.widget.setRadius(A)}},updateFromWidgetValue:function(){if(this.widget){this.input.value=this.widget.getRadius()}}});Fusion.Widget.SelectWithin=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{sFeatures:"menubar=no,location=no,resizable=no,status=no",initialize:function(E){Fusion.Widget.prototype.initialize.apply(this,[E,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var D=E.extension;this.sTarget=D.Target?D.Target[0]:"SelectWithinWindow";this.sBaseUrl=Fusion.getFusionURL()+"widgets/SelectWithin/SelectWithinPanel.php";this.bSelectionOnly=(D.DisableIfSelectionEmpty&&(D.DisableIfSelectionEmpty[0]=="true"||D.DisableIfSelectionEmpty[0]=="1"))?true:false;this.additionalParameters=[];if(D.AdditionalParameter){for(var C=0;C<D.AdditionalParameter.length;C++){var F=D.AdditionalParameter[C];var B=F.Key[0];var A=F.Value[0];this.additionalParameters.push(B+"="+encodeURIComponent(A))}}this.enable=Fusion.Widget.SelectWithin.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.enable,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.enable,this));this.disable()},enable:function(){var A=this.getMap();if(this.bSelectionOnly||!A){if(A&&A.hasSelection()){if(this.action){this.action.setEnabled(true)}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}}else{if(this.action){this.action.setEnabled(false)}else{this.disable()}}}else{if(this.action){this.action.setEnabled(true)}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}}},execute:function(){var C=this.sBaseUrl;var E=this.getMap();var B=E.getAllMaps();var D=Fusion.getWidgetById(this.sTarget);var A=$(this.sTarget);var F=[];F.push("locale="+Fusion.locale);F.push("session="+B[0].getSessionID());F.push("mapname="+B[0].getMapName());if(D||A){F.push("popup=false")}else{F.push("popup=true")}F=F.concat(this.additionalParameters);if(C.indexOf("?")<0){C+="?"}else{if(C.slice(-1)!="&"){C+="&"}}C+=F.join("&");if(D){D.setContent(C)}else{if(A){A.src=C}else{window.open(C,this.sTarget,this.sWinFeatures)}}}});Fusion.Widget.SelectionInfo=OpenLayers.Class(Fusion.Widget,{defaultTemplate:"selectionInfo",domSpan:null,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);var A=B.extension;this.emptyText=A.EmptyText?A.EmptyText[0]:this.domObj.innerHTML;this.template=A.Template?A.Template[0]:null;this.domSpan=document.createElement("span");this.domSpan.className="spanSelectionInfo";this.domSpan.innerHTML=OpenLayers.i18n(this.emptyText);this.domObj.innerHTML="";this.domObj.appendChild(this.domSpan);this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.update,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.update,this))},update:function(){var B=this.getMap();var A=B.getAllMaps();var D=A[0];if(D.hasSelection()){var C=D.getSelectedLayers();var F=C.length;var E=D.getSelectedFeatureCount();if(this.template){this.domSpan.innerHTML=this.template.replace("{0}",E).replace("{1}",F)}else{this.domSpan.innerHTML=OpenLayers.i18n(this.defaultTemplate,{features:E,layers:F})}}else{this.domSpan.innerHTML=OpenLayers.i18n(this.emptyText)}}});Fusion.Widget.SelectionPanel=OpenLayers.Class(Fusion.Widget,{previousIcon:"images/icon_back.gif",nextIcon:"images/icon_forward.gif",initialize:function(widgetTag){Fusion.Widget.prototype.initialize.apply(this,[widgetTag,false]);var json=widgetTag.extension;if(json.PreviousImageUrl){this.previousIcon=json.PreviousImageUrl}if(json.NextImageUrl){this.nextIcon=json.NextImageUrl}this.iResultsPerPage=json.ResultsPerPage?json.ResultsPerPage[0]:0;this.iResultsPerPage=parseInt(this.iResultsPerPage);if(isNaN(this.iResultsPerPage)||(this.iResultsPerPage<0)){this.iResultsPerPage=0}if(json.SelectionRenderer){var renderer=eval(json.SelectionRenderer[0]);if(renderer&&renderer.prototype.CLASS_NAME&&renderer.prototype.CLASS_NAME=="Fusion.Widget.SelectionPanel.SelectionRenderer"){this.renderer=new renderer(this)}else{if(typeof renderer=="function"){var renderFunction=renderer;this.renderer=new Fusion.Widget.SelectionPanel.SelectionRenderer(this);this.renderer.updateSelection=function(){this.getMap().getSelection(OpenLayers.Function.bind(renderFunction))};this.renderer.clearSelection=false}else{this.renderer=new Fusion.Widget.SelectionPanel.SelectionRendererDefault(this)}}}else{this.renderer=new Fusion.Widget.SelectionPanel.SelectionRendererDefault(this)}this.iResultsPerPage=null;if(this.renderer.updateSelection){this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.renderer.updateSelection,this.renderer))}if(this.renderer.clearSelection){this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.renderer.clearSelection,this.renderer))}}});Fusion.Widget.SelectionPanel.SelectionRenderer=OpenLayers.Class({oSelection:null,aiCurrentIndex:null,iResultsPerPage:0,initialize:function(A){this.oSelectionPanel=A;this.iResultsPerPage=A.iResultsPerPage;this.aiCurrentIndex=new Array()},updatePageIndexes:function(){var B=this.oSelection.getNumLayers();for(var A=0;A<B;A++){this.aiCurrentIndex[this.oSelection.getLayer(A).getName()]=0}},getNextPage:function(A){if(A&&(this.iResultsPerPage!=0)){var C=A.getName();if(this.aiCurrentIndex[C]>=A.getNumElements()){this.aiCurrentIndex[C]=this.aiCurrentIndex[C]-this.iResultsPerPage}var B=A.getNumElements();var F=this.aiCurrentIndex[C];var D=F+this.iResultsPerPage;if(D>=B){D=B}if(F<0){F=0}this.aiCurrentIndex[C]=D;var E=(D-F);if(E!=this.iResultsPerPage){this.aiCurrentIndex[C]=this.aiCurrentIndex[C]+(this.iResultsPerPage-E)}return this.getPage(A,F,D)}return this.getPage(A)},getPreviousPage:function(A){var C=A.getName();if(A&&(this.aiCurrentIndex[C]!=0)&&(this.iResultsPerPage!=0)){var B=A.getNumElements();var E=this.aiCurrentIndex[C]-(this.iResultsPerPage*2);var D=this.aiCurrentIndex[C]-this.iResultsPerPage;if(E<0){E=0;D=(B<this.iResultsPerPage)?B:this.iResultsPerPage}this.aiCurrentIndex[C]=D;return this.getPage(A,E,D)}return this.getPage(A)},getMap:function(){return this.oSelectionPanel.getMap()},getPage:function(A,G,F){var E=false;if(A){E=new Array();G=G?G:0;F=F?F:A.getNumElements();var H=A.getPropertyNames();var C=0;for(var D=G;D<F;D++,C++){E[C]=new Array();for(var B=0;B<H.length;B++){E[C][B]=A.getElementValue(D,B)}}}return E},updateSelection:function(){},clearSelection:function(){},CLASS_NAME:"Fusion.Widget.SelectionPanel.SelectionRenderer"});Fusion.Widget.SelectionPanel.SelectionRendererDefault=OpenLayers.Class(Fusion.Widget.SelectionPanel.SelectionRenderer,{initialize:function(B){Fusion.Widget.SelectionPanel.SelectionRenderer.prototype.initialize.apply(this,[B]);var A=document.createElement("div");this.toolbar=document.createElement("div");this.toolbar.className="selectionPanelToolbar";this.layerList=document.createElement("select");this.layerList.className="layerSelector";this.toolbar.appendChild(this.layerList);Event.observe(this.layerList,"change",OpenLayers.Function.bind(this.renderSelectionFeatures,this));this.featureList=document.createElement("select");this.featureList.className="featureSelector";this.toolbar.appendChild(this.featureList);Event.observe(this.featureList,"change",OpenLayers.Function.bind(this.renderFeature,this));this.featureDiv=document.createElement("div");this.featureDiv.className="selectionPanelContent";this.clearSelection();A.appendChild(this.toolbar);A.appendChild(this.featureDiv);Fusion.addWidgetStyleSheet(this.oSelectionPanel.getLocation()+"SelectionPanel/SelectionPanel.css");this.oSelectionPanel.domObj.appendChild(A)},updateSelection:function(){this.getMap().getSelection(OpenLayers.Function.bind(this.renderSelectionLayers,this))},clearSelection:function(){this.layerList.options.length=0;this.featureList.options.length=0;this.oSelection=null;Element.addClassName(this.featureDiv,"noSelection");this.featureDiv.innerHTML=OpenLayers.i18n("noSelection")},renderSelectionLayers:function(E){this.oSelection=null;for(var I in E){this.oSelection=E[I];break}if(!this.oSelection){return }Element.removeClassName(this.featureDiv,"noSelection");while(this.layerList.length>0){this.layerList.remove(this.layerList.options[0])}var C=this.oSelection.getNumLayers();for(var G=0;G<C;G++){var D=this.oSelection.getLayer(G);var B=this.getMap().aMaps[0].aLayers;var H=D.getName();for(var F=0;F<B.length;++F){if(B[F].layerName==H){H=B[F].legendLabel;break}}var A=new Option(H,G);this.layerList.options[G]=A}this.layerList.selectedIndex=0;this.renderSelectionFeatures()},renderSelectionFeatures:function(){var B=this.layerList.selectedIndex;var E=this.oSelection.getLayer(B);while(this.featureList.length>0){this.featureList.remove(this.featureList.options[0])}var A=E.getNumElements();for(var D=0;D<A;D++){var C=new Option(D+1,D);this.featureList.options[D]=C}this.featureList.selectedIndex=0;this.renderFeature()},renderFeature:function(){var K=this.layerList.selectedIndex;var G=this.featureList.selectedIndex;var D=this.oSelection.getLayer(K);var J=D.getNumProperties();var B=D.getPropertyNames();var L=document.createElement("table");var H=document.createElement("thead");var I=document.createElement("tr");var A=document.createElement("th");A.innerHTML=OpenLayers.i18n("attribute");I.appendChild(A);var A=document.createElement("th");A.innerHTML=OpenLayers.i18n("value");I.appendChild(A);H.appendChild(I);L.appendChild(H);var F=document.createElement("tbody");L.appendChild(F);for(var E=0;E<J;E++){var I=document.createElement("tr");if(E%2){Element.addClassName(I,"oddRow")}var A=document.createElement("th");A.innerHTML=B[E];var C=document.createElement("td");C.innerHTML=D.getElementValue(G,E);I.appendChild(A);I.appendChild(C);F.appendChild(I)}this.featureDiv.innerHTML="";this.featureDiv.appendChild(L)}});Fusion.Widget.SelectionPanel.SelectionRendererHorizontal=OpenLayers.Class(Fusion.Widget.SelectionPanel.SelectionRenderer,{initialize:function(B){Fusion.Widget.SelectionPanel.SelectionRenderer.prototype.initialize.apply(this,[B]);var A=document.createElement("div");this.featureDiv=document.createElement("div");this.featureDiv.innerHTML="No Selection";Element.addClassName(this.featureDiv,"noSelection");A.appendChild(this.featureDiv);if(this.iResultsPerPage!=0){this.previousButton=document.createElement("img");this.previousButton.src=this.oSelectionPanel.previousIcon;this.previousButton.style.position="absolute";this.previousButton.style.left="0px";this.previousButton.style.padding="3px";Event.observe(this.previousButton,"click",OpenLayers.Function.bind(this.renderLayers,this,"prev"));this.nextButton=document.createElement("img");this.nextButton.src=this.oSelectionPanel.nextIcon;this.nextButton.style.position="absolute";this.nextButton.style.right="0px";this.nextButton.style.padding="3px";Event.observe(this.nextButton,"click",OpenLayers.Function.bind(this.renderLayers,this,"next"));A.appendChild(this.previousButton);A.appendChild(this.nextButton)}Element.addClassName(this.featureDiv,"selectionPanelContent");Fusion.addWidgetStyleSheet(this.oSelectionPanel.getLocation()+"SelectionPanel/SelectionPanel.css");this.oSelectionPanel.domObj.appendChild(A)},updateSelection:function(){this.getMap().getSelection(OpenLayers.Function.bind(this.renderSelection,this))},clearSelection:function(){this.oSelection=null;Element.addClassName(this.featureDiv,"noSelection");this.featureDiv.innerHTML=OpenLayers.i18n("noSelection")},renderSelection:function(B){this.oSelection=null;for(var A in B){this.oSelection=B[A];break}this.updatePageIndexes();this.renderLayers("next")},renderLayers:function(A){if(!this.oSelection){return }Element.removeClassName(this.featureDiv,"noSelection");this.featureDiv.innerHTML="";var D=this.oSelection.getNumLayers();for(var I=0;I<D;I++){var N=document.createElement("table");N.style.borderLeft="1px solid #CCCCCC";N.style.marginBottom="10px";var F=this.oSelection.getLayer(I);var E=F.getPropertyNames();var C=this.getMap().aMaps[0].aLayers;var J=F.getName();for(var G=0;G<C.length;++G){if(C[G].layerName==J){J=C[G].legendLabel;break}}var L=document.createElement("thead");var M=document.createElement("tr");var B=document.createElement("th");B.innerHTML=J;B.colSpan=E.length;B.style.textAlign="center";M.appendChild(B);L.appendChild(M);M=document.createElement("tr");for(var G=0;G<E.length;G++){B=document.createElement("th");B.innerHTML=E[G];B.style.textAlign="center";M.appendChild(B)}L.appendChild(M);N.appendChild(L);var H=document.createElement("tbody");var K=(A=="next")?this.getNextPage(F):this.getPreviousPage(F);this.renderFeatures(K,H);N.appendChild(H);this.featureDiv.appendChild(N)}},renderFeatures:function(D,E){if(!D){return }for(var B=0;B<D.length;B++){var C=document.createElement("tr");if(B%2){Element.addClassName(C,"oddRow")}for(var A=0;A<D[B].length;A++){var F=document.createElement("td");F.innerHTML=D[B][A];C.appendChild(F)}E.appendChild(C)}}});Fusion.Widget.TaskPane=OpenLayers.Class(Fusion.Widget,{aExecutedTasks:null,nCurrentTask:0,nTasks:0,homeAction:null,prevAction:null,nextAction:null,initialize:function(C){Fusion.Widget.prototype.initialize.apply(this,[C,true]);this.aExecutedTasks=[];this.defHomeIcon="images/icon_home.png";this.defPrevTaskIcon="images/icon_back.png";this.defNextTaskIcon="images/icon_forward.png";this.defTaskListIcon="images/icon_tasks.png";this.defInitialTask=C.location+"TaskPane/TaskPane.html";var B=C.extension;if(B.InitialTask){this.initialTask=taskURL=B.InitialTask[0]}else{this.initialTask=Fusion.getFusionURL()+this.defInitialTask}if(B.MenuContainer){this.menuName=B.MenuContainer[0]}var D="TaskNav";var A=document.createElement("div");A.setAttribute("id",D);this.toolbar=new Jx.Toolbar(A,{left:0});this.homeAction=new Jx.Action(OpenLayers.Function.bind(this.goHome,this));this.toolbar.add(new Jx.Button(this.homeAction,{image:this.defHomeIcon,tooltip:OpenLayers.i18n("taskHome")}));this.prevAction=new Jx.Action(OpenLayers.Function.bind(this.gotoPrevTask,this));this.toolbar.add(new Jx.Button(this.prevAction,{image:this.defPrevTaskIcon,tooltip:OpenLayers.i18n("prevTask")}));this.nextAction=new Jx.Action(OpenLayers.Function.bind(this.gotoNextTask,this));this.toolbar.add(new Jx.Button(this.nextAction,{image:this.defNextTaskIcon,tooltip:OpenLayers.i18n("nextTask")}));this.taskMenu=new Jx.Menu({image:this.defTaskListIcon,label:OpenLayers.i18n("taskList"),right:0});Element.addClassName(this.taskMenu.domObj,"taskMenu");Element.addClassName(this.taskMenu.button.domObj,"jxButtonContentLeft");this.toolbar.add(this.taskMenu);var E=this.sName+"_IFRAME";this.iframe=document.createElement("iframe");new Jx.Layout(this.iframe);this.iframe.setAttribute("name",E);this.iframe.setAttribute("id",E);this.iframe.setAttribute("frameborder",0);this.iframe.style.border="0px solid #fff";this.oTaskPane=new Jx.Panel({toolbar:A,label:OpenLayers.i18n("taskPane"),content:this.iframe});Element.addClassName(this.domObj,"taskPanePanel");Fusion.addWidgetStyleSheet(C.location+"TaskPane/TaskPane.css");this.domObj.appendChild(this.oTaskPane.domObj);this.oTaskPane.domObj.resize();Fusion.registerForEvent(Fusion.Event.FUSION_INITIALIZED,OpenLayers.Function.bind(this.setTaskMenu,this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.setContent,this,this.initialTask))},updateButtons:function(){this.prevAction.setEnabled(this.nCurrentTask>0);this.nextAction.setEnabled(this.nCurrentTask<this.aExecutedTasks.length-1)},gotoPrevTask:function(){this.nCurrentTask=this.nCurrentTask>0?--this.nCurrentTask:0;this.iframe.src=this.aExecutedTasks[this.nCurrentTask];this.updateButtons()},gotoNextTask:function(){this.nCurrentTask=this.nCurrentTask<this.aExecutedTasks.length-1?++this.nCurrentTask:this.aExecutedTasks.length-1;this.iframe.src=this.aExecutedTasks[this.nCurrentTask];this.updateButtons()},goHome:function(){this.nCurrentTask=0;this.iframe.src=this.aExecutedTasks[this.nCurrentTask];this.updateButtons()},setContent:function(A){if(this.nCurrentTask<this.aExecutedTasks.length){this.aExecutedTasks.splice(this.nCurrentTask,this.aExecutedTasks.length-this.nCurrentTask)}this.aExecutedTasks.push(A);++this.nCurrentTask;this.iframe.src=A;this.iframe.taskPaneId=this.widgetTag.name;this.updateButtons()},setTaskMenu:function(){if(this.menuName){var A=this.getMap().widgetSet.getContainerByName(this.menuName);if(A){A.createWidgets(this.getMap().widgetSet,this.taskMenu)}}}});Fusion.Widget.ViewOptions=OpenLayers.Class(Fusion.Widget,Fusion.Tool.MenuBase,{displayUnits:false,options:{imperial:"Miles",metric:"Meters",deg:"Degrees"},initialize:function(D){Fusion.Widget.prototype.initialize.apply(this,[D,true]);Fusion.Tool.MenuBase.prototype.initialize.apply(this,[]);var B=D.extension;for(var A in this.options){var E=new Jx.Action(OpenLayers.Function.bind(this.setViewOptions,this,this.options[A]));var C=new Jx.MenuItem(E,{label:OpenLayers.i18n(A)});this.oMenu.add(C)}this.displayUnits=B.DisplayUnits?B.DisplayUnits[0]:false;this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.setMapUnits,this))},activateTool:function(A){this.oMenu.show(A)},setViewOptions:function(A){this.getMap().setViewOptions(A)},setMapUnits:function(){var A=this.displayUnits?this.displayUnits:this.getMap().getUnits();this.setViewOptions(A)}});Fusion.Widget.ViewSize=OpenLayers.Class(Fusion.Widget,{defaultTemplate:"x: {x}, y: {y}",domSpan:null,units:Fusion.UNKNOWN,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);this.emptyText=this.domObj.innerHTML;var A=B.extension;this.template=A.Template?A.Template[0]:this.defaultTemplate;this.precision=A.Precision?parseInt(A.Precision[0]):-1;this.units=A.Units?Fusion.unitFromName(A.Units[0]):Fusion.UNKOWN;this.domSpan=document.createElement("span");this.domSpan.className="spanViewSize";this.domSpan.innerHTML=this.emptyText;this.domObj.innerHTML="";this.domObj.appendChild(this.domSpan);this.getMap().registerForEvent(Fusion.Event.MAP_RESIZED,OpenLayers.Function.bind(this.updateViewSize,this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,OpenLayers.Function.bind(this.setUnits,this));this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,OpenLayers.Function.bind(this.updateViewSize,this));this.registerParameter("Units")},updateViewSize:function(G){var F=this.getMap();var E=F.getSize();if(this.units!=Fusion.PIXELS){var H=F.pixToGeoMeasure(E.w);var C=F.pixToGeoMeasure(E.h);if(this.units!=Fusion.UNKNOWN){var B=F.getMetersPerUnit();H=Fusion.fromMeter(this.units,H*B);C=Fusion.fromMeter(this.units,C*B)}if(this.precision>=0){var D=Math.pow(10,this.precision);H=Math.round(H*D)/D;C=Math.round(C*D)/D}}var A=Fusion.unitAbbr(this.units);this.domSpan.innerHTML=this.template.replace("{w}",H).replace("{h}",C).replace("{units}",A).replace("{units}",A)},setUnits:function(){if(this.units==Fusion.UNKNOWN){this.setParameter("Units",this.getMap().getUnits())}this.updateViewSize()},setParameter:function(B,A){if(B=="Units"){this.units=Fusion.unitFromName(A);this.updateViewSize()}}});Fusion.Widget.Zoom=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{nTolerance:5,nFactor:2,zoomIn:true,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,true]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);this.asCursor=["url('images/zoomin.cur'),auto","-moz-zoom-in","auto"];var A=B.extension;this.nTolerance=A.Tolerance?A.Tolerance[0]:this.nTolerance;this.nFactor=A.Factor?A.Factor[0]:this.nFactor;this.zoomIn=(A.Direction&&A.Direction[0]=="out")?false:true;this.zoomInCursor=["url('images/zoomin.cur'),auto","-moz-zoom-in","auto"];this.zoomOutCursor=["url('images/zoomout.cur'),auto","-moz-zoom-out","auto"];this.keypressWatcher=OpenLayers.Function.bind(this.keypressHandler,this);this.map=this.getMap().oMapOL;this.handler=new OpenLayers.Handler.Box(this,{done:this.execute},{keyMask:0});this.shiftHandler=new OpenLayers.Handler.Box(this,{done:this.altZoom},{keyMask:OpenLayers.Handler.MOD_SHIFT})},activateTool:function(){this.getMap().activateWidget(this);Event.observe(document,"keypress",this.keypressWatcher)},activate:function(){this.handler.activate();this.shiftHandler.activate();if(this.zoomIn){this.getMap().setCursor(this.zoomInCursor)}else{this.getMap().setCursor(this.zoomOutCursor)}this._oButton.activateTool()},deactivate:function(){this.handler.deactivate();this.shiftHandler.deactivate();this.getMap().setCursor("auto");this._oButton.deactivateTool();Event.stopObserving(document,"keypress",this.keypressWatcher)},execute:function(H,M){var F=this.zoomIn;if(M){F=!F}if(H instanceof OpenLayers.Bounds){var I=this.map.getLonLatFromPixel(new OpenLayers.Pixel(H.left,H.bottom));var K=this.map.getLonLatFromPixel(new OpenLayers.Pixel(H.right,H.top));var B=new OpenLayers.Bounds(I.lon,I.lat,K.lon,K.lat);if(F){this.getMap().setExtents(B)}else{var G=B.getWidth();var C=B.getHeight();var L=this.getMap().getCurrentExtents();var D=L.getWidth();var E=L.getHeight();var J=Math.min(G/D,C/E);var A=B.getCenterLonLat();this.getMap().zoom(A.lon,A.lat,J)}}else{var A=this.map.getLonLatFromPixel(H);var J;if(!F&&this.nFactor>1){J=1/this.nFactor}else{J=this.nFactor}this.getMap().zoom(A.lon,A.lat,J)}},altZoom:function(A){this.execute(A,true)},setParameter:function(B,A){if(B=="Factor"&&A>0){this.nFactor=A}},keypressHandler:function(B){var A=(B.charCode)?B.charCode:B.keyCode;if(A==Event.KEY_ESC){this.handler.deactivate();this.handler.activate()}}});Fusion.Widget.ZoomOnClick=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{nFactor:4,initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=B.extension;this.nFactor=parseFloat(A.Factor?A.Factor[0]:this.nFactor)},execute:function(){var A=this.getMap().getCurrentCenter();this.getMap().zoom(A.x,A.y,this.nFactor)},setParameter:function(B,A){if(B=="Factor"&&A>0){this.nFactor=A}}});Fusion.Widget.ZoomToSelection=OpenLayers.Class(Fusion.Widget,Fusion.Tool.ButtonBase,{initialize:function(B){Fusion.Widget.prototype.initialize.apply(this,[B,false]);Fusion.Tool.ButtonBase.prototype.initialize.apply(this,[]);var A=B.extension;this.maxDimension=A.MaximumZoomDimension?A.MaximumZoomDimension[0]:-1;this.zoomFactor=A.ZoomFactor?A.ZoomFactor[0]:2;this.enable=Fusion.Widget.ZoomToSelection.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,OpenLayers.Function.bind(this.enable,this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,OpenLayers.Function.bind(this.disable,this))},execute:function(){this.getMap().getSelection(OpenLayers.Function.bind(this.zoomToSelection,this))},zoomToSelection:function(A){var D=this.oMap.aMaps[0];var C=A[D.getMapName()].getLowerLeftCoord();var F=A[D.getMapName()].getUpperRightCoord();var B=this.zoomFactor*Math.max(Math.abs(F.x-C.x),Math.abs(F.y-C.y))/2;var G=(F.x+C.x)/2;var E=(F.y+C.y)/2;C.x=G-B;F.x=G+B;C.y=E-B;F.y=E+B;this.getMap().setExtents(new OpenLayers.Bounds(C.x,C.y,F.x,F.y))},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[])}else{this.disable()}}});function ScaleBarTool(B){this.scaleDenominator=(B==null)?1:B;this.displaySystem="metric";this.minWidth=100;this.maxWidth=200;this.divisions=2;this.subdivisions=2;this.showMinorMeasures=false;this.abbreviateLabel=false;this.singleLine=false;this.resolution=72;this.align="center";this.container=document.createElement("div");this.container.className="sbWrapper";this.labelContainer=document.createElement("div");this.labelContainer.className="sbUnitsContainer";this.labelContainer.style.position="absolute";this.graphicsContainer=document.createElement("div");this.graphicsContainer.style.position="absolute";this.graphicsContainer.className="sbGraphicsContainer";this.numbersContainer=document.createElement("div");this.numbersContainer.style.position="absolute";this.numbersContainer.className="sbNumbersContainer";var A=document.createElement("div");A.className="sbMarkerMajor";this.graphicsContainer.appendChild(A);var C=document.createElement("div");C.className="sbMarkerMinor";this.graphicsContainer.appendChild(C);var D=document.createElement("div");D.className="sbBar";this.graphicsContainer.appendChild(D);var E=document.createElement("div");E.className="sbBarAlt";this.graphicsContainer.appendChild(E)}ScaleBarTool.prototype.update=function(T){if(T!=null){this.scaleDenominator=T}function k(s,AD,u){var u=(u==null)?10:u;var v=Number.POSITIVE_INFINITY;var x=Number.POSITIVE_INFINITY;var AF=s;var t=3;for(var y=0;y<3;++y){var r=Math.pow(2,(-1*y));var AB=Math.floor(Math.log(AD/r)/Math.LN10);for(var AE=AB;AE>(AB-u+1);--AE){var AA=Math.max(y-AE,0);var AG=r*Math.pow(10,AE);if((AG*Math.floor(AD/AG))>=s){if(s%AG==0){var AC=s/AG}else{var AC=Math.floor(s/AG)+1}var q=AC+(2*y);var z=(AE<0)?(Math.abs(AE)+1):AE;if((q<v)||((q==v)&&(z<x))){v=q;x=z;AF=(AG*AC).toFixed(AA);t=AA}}}}this.value=AF;this.score=v;this.tieBreaker=x;this.numDec=t}k.prototype.toString=function(){return this.value.toString()};k.prototype.valueOf=function(){return this.value};function c(q,v){var y=0;if(document.styleSheets){for(var s=document.styleSheets.length-1;s>=0;--s){var t=document.styleSheets[s];if(!t.disabled){var r;if(typeof (t.cssRules)=="undefined"){if(typeof (t.rules)=="undefined"){return 0}else{r=t.rules}}else{r=t.cssRules}for(var x=0;x<r.length;++x){var u=r[x];if(u.selectorText&&(u.selectorText.toLowerCase()==q.toLowerCase())){if(u.style[v]!=""){y=parseInt(u.style[v])}}}}}}return y?y:0}function l(u,t){t=(t)?t:0;var s=""+Math.round(u);var r=/(-?[0-9]+)([0-9]{3})/;while(r.test(s)){s=s.replace(r,"$1,$2")}if(t>0){var q=Math.floor(Math.pow(10,t)*(u-Math.round(u)));if(q==0){return s}else{return s+"."+q}}else{return s}}this.container.title="scale 1:"+l(this.scaleDenominator);var L=new Object();L.english={units:["miles","feet","inches"],abbr:["mi","ft","in"],inches:[63360,12,1]};L.metric={units:["kilometers","meters","centimeters"],abbr:["km","m","cm"],inches:[39370.07874,39.370079,0.393701]};var n=new Array();for(var o=0;o<L[this.displaySystem].units.length;++o){n[o]=new Object();var I=this.resolution*L[this.displaySystem].inches[o]/this.scaleDenominator;var E=(this.minWidth/I)/(this.divisions*this.subdivisions);var N=(this.maxWidth/I)/(this.divisions*this.subdivisions);for(var D=0;D<(this.divisions*this.subdivisions);++D){var Q=E*(D+1);var f=N*(D+1);var C=new k(Q,f);n[o][D]={value:(C.value/(D+1)),score:0,tieBreaker:0,numDec:0,displayed:0};for(var M=0;M<(this.divisions*this.subdivisions);++M){displayedValuePosition=C.value*(M+1)/(D+1);niceNumber2=new k(displayedValuePosition,displayedValuePosition);var i=((M+1)%this.subdivisions==0);var p=((M+1)==(this.divisions*this.subdivisions));if((this.singleLine&&p)||(!this.singleLine&&(i||this.showMinorMeasures))){n[o][D].score+=niceNumber2.score;n[o][D].tieBreaker+=niceNumber2.tieBreaker;n[o][D].numDec=Math.max(n[o][D].numDec,niceNumber2.numDec);n[o][D].displayed+=1}else{n[o][D].score+=niceNumber2.score/this.subdivisions;n[o][D].tieBreaker+=niceNumber2.tieBreaker/this.subdivisions}}var G=(o+1)*n[o][D].tieBreaker/n[o][D].displayed;n[o][D].score*=G}}var V=null;var H=null;var A=null;var R=null;var Y=Number.POSITIVE_INFINITY;var W=Number.POSITIVE_INFINITY;var X=0;for(var o=0;o<n.length;++o){for(D in n[o]){if((n[o][D].score<Y)||((n[o][D].score==Y)&&(n[o][D].tieBreaker<W))){Y=n[o][D].score;W=n[o][D].tieBreaker;V=n[o][D].value;X=n[o][D].numDec;H=L[this.displaySystem].units[o];A=L[this.displaySystem].abbr[o];I=this.resolution*L[this.displaySystem].inches[o]/this.scaleDenominator;R=I*V}}}var K=(c(".sbMarkerMajor","borderLeftWidth")+c(".sbMarkerMajor","width")+c(".sbMarkerMajor","borderRightWidth"))/2;var F=(c(".sbMarkerMinor","borderLeftWidth")+c(".sbMarkerMinor","width")+c(".sbMarkerMinor","borderRightWidth"))/2;var a=(c(".sbBar","borderLeftWidth")+c(".sbBar","borderRightWidth"))/2;var m=(c(".sbBarAlt","borderLeftWidth")+c(".sbBarAlt","borderRightWidth"))/2;if(!document.styleSheets){K=0.5;F=0.5}while(this.labelContainer.hasChildNodes()){this.labelContainer.removeChild(this.labelContainer.firstChild)}while(this.graphicsContainer.hasChildNodes()){this.graphicsContainer.removeChild(this.graphicsContainer.firstChild)}while(this.numbersContainer.hasChildNodes()){this.numbersContainer.removeChild(this.numbersContainer.firstChild)}var b,d,S,U;var B={left:0,center:(-1*this.divisions*this.subdivisions*R/2),right:(-1*this.divisions*this.subdivisions*R)};var P=0+B[this.align];var e=0;for(var Z=0;Z<this.divisions;++Z){P=Z*this.subdivisions*R;P+=B[this.align];e=(Z==0)?0:((Z*this.subdivisions)*V).toFixed(X);b=document.createElement("div");b.className="sbMarkerMajor";b.style.position="absolute";b.style.overflow="hidden";b.style.left=Math.round(P-K)+"px";b.appendChild(document.createTextNode(" "));this.graphicsContainer.appendChild(b);if(!this.singleLine){S=document.createElement("div");S.className="sbNumbersBox";S.style.position="absolute";S.style.overflow="hidden";S.style.textAlign="center";if(this.showMinorMeasures){S.style.width=Math.round(R*2)+"px";S.style.left=Math.round(P-R)+"px"}else{S.style.width=Math.round(this.subdivisions*R*2)+"px";S.style.left=Math.round(P-(this.subdivisions*R))+"px"}S.appendChild(document.createTextNode(e));this.numbersContainer.appendChild(S)}for(var J=0;J<this.subdivisions;++J){d=document.createElement("div");d.style.position="absolute";d.style.overflow="hidden";d.style.width=Math.round(R)+"px";if((J%2)==0){d.className="sbBar";d.style.left=Math.round(P-a)+"px"}else{d.className="sbBarAlt";d.style.left=Math.round(P-m)+"px"}d.appendChild(document.createTextNode(" "));this.graphicsContainer.appendChild(d);if(J<(this.subdivisions-1)){P=((Z*this.subdivisions)+(J+1))*R;P+=B[this.align];e=(Z*this.subdivisions+J+1)*V;b=document.createElement("div");b.className="sbMarkerMinor";b.style.position="absolute";b.style.overflow="hidden";b.style.left=Math.round(P-F)+"px";b.appendChild(document.createTextNode(" "));this.graphicsContainer.appendChild(b);if(this.showMinorMeasures&&!this.singleLine){S=document.createElement("div");S.className="sbNumbersBox";S.style.position="absolute";S.style.overflow="hidden";S.style.textAlign="center";S.style.width=Math.round(R*2)+"px";S.style.left=Math.round(P-R)+"px";S.appendChild(document.createTextNode(e));this.numbersContainer.appendChild(S)}}}}P=(this.divisions*this.subdivisions)*R;P+=B[this.align];e=((this.divisions*this.subdivisions)*V).toFixed(X);b=document.createElement("div");b.className="sbMarkerMajor";b.style.position="absolute";b.style.overflow="hidden";b.style.left=Math.round(P-K)+"px";b.appendChild(document.createTextNode(" "));this.graphicsContainer.appendChild(b);if(!this.singleLine){S=document.createElement("div");S.className="sbNumbersBox";S.style.position="absolute";S.style.overflow="hidden";S.style.textAlign="center";if(this.showMinorMeasures){S.style.width=Math.round(R*2)+"px";S.style.left=Math.round(P-R)+"px"}else{S.style.width=Math.round(this.subdivisions*R*2)+"px";S.style.left=Math.round(P-(this.subdivisions*R))+"px"}S.appendChild(document.createTextNode(e));this.numbersContainer.appendChild(S)}var h=document.createElement("div");h.style.position="absolute";var g;if(this.singleLine){g=e;h.className="sbLabelBoxSingleLine";h.style.top="-0.6em";h.style.left=(P+10)+"px"}else{g="";h.className="sbLabelBox";h.style.textAlign="center";h.style.width=Math.round(this.divisions*this.subdivisions*R)+"px";h.style.left=Math.round(B[this.align])+"px";h.style.overflow="hidden"}if(this.abbreviateLabel){g+=" "+A}else{g+=" "+H}h.appendChild(document.createTextNode(g));this.labelContainer.appendChild(h);if(!document.styleSheets){var O=document.createElement("style");O.type="text/css";var j=".sbBar {top: 0px; background: #666666; height: 1px; border: 0;}";j+=".sbBarAlt {top: 0px; background: #666666; height: 1px; border: 0;}";j+=".sbMarkerMajor {height: 7px; width: 1px; background: #666666; border: 0;}";j+=".sbMarkerMinor {height: 5px; width: 1px; background: #666666; border: 0;}";j+=".sbLabelBox {top: -16px;}";j+=".sbNumbersBox {top: 7px;}";O.appendChild(document.createTextNode(j));document.getElementsByTagName("head").item(0).appendChild(O)}this.container.appendChild(this.graphicsContainer);this.container.appendChild(this.labelContainer);this.container.appendChild(this.numbersContainer)};ScaleBarTool.prototype.place=function(A){if(A==null){document.body.appendChild(this.container)}else{var B=document.getElementById(A);if(B!=null){B.appendChild(this.container)}}this.update()};